# 分钟K线数据拉取工具使用说明

## 概述

这个工具用于从QMT拉取1分钟K线数据，解决样本丢失问题。

**关键优势**：
- ✅ **无需L2权限**（所有QMT用户免费）
- ✅ **数据可补全**（不会永久丢失）
- ✅ **数据量小**（5000只股票/天约20MB）
- ✅ **适合回测**（标准的历史数据格式）

## 使用方法

### 1. 基本使用

```bash
python tools/fetch_1m_data.py
```

这会拉取默认的5只测试股票过去7天的1分钟K线数据。

### 2. 自定义股票列表

修改脚本中的 `test_stocks` 列表：

```python
test_stocks = [
    '600519.SH',  # 添加你的股票
    '000001.SZ',
    # ... 更多股票
]
```

### 3. 自定义时间范围

```python
data = fetch_minute_data(
    code_list=test_stocks,
    start_date='20260101',  # 自定义开始日期
    end_date='20260209',     # 自定义结束日期
    verbose=True
)
```

### 4. 保存数据

数据会自动保存到 `data/minute_data/` 目录，格式为 `{代码}_1m.csv`。

### 5. 加载数据

```python
from tools.fetch_1m_data import load_data_from_csv

data = load_data_from_csv('data/minute_data')
```

## 数据格式

每只股票的CSV文件包含以下列：

| 列名 | 说明 | 示例 |
|------|------|------|
| time | 时间戳（毫秒） | 1707456000000 |
| open | 开盘价 | 10.5 |
| high | 最高价 | 10.8 |
| low | 最低价 | 10.3 |
| close | 收盘价 | 10.6 |
| volume | 成交量 | 1000000 |
| amount | 成交额 | 10600000 |
| time_str | 可读时间 | 2024-02-09 09:30:00 |

## 与Tick数据的对比

| 特性 | Tick数据 | 1分钟K线 |
|------|---------|----------|
| 权限要求 | L2（付费） | 免费 |
| 数据量 | 大（20-60条/分钟） | 小（1条/分钟） |
| 样本丢失风险 | 高（流式数据） | 低（可补全） |
| 适用场景 | 盘口分析 | 趋势分析 |
| 回测友好度 | 低 | 高 |

## 常见问题

### Q1: 为什么我的Tick数据会丢失？

**A**: Tick数据是流式推送的，如果：
- 网络抖动1秒
- Python脚本处理太慢
- QMT客户端卡顿

这些都会导致Tick数据永久丢失，无法找回。

### Q2: 1分钟K线真的不会丢失吗？

**A**: 不会。因为：
1. K线数据是服务器端合成的
2. 即使你的脚本挂了，数据还在服务器
3. 重启后可以重新下载完整数据

### Q3: 1分钟K线能做什么？

**A**: 绝大部分策略都可以：
- ✅ 趋势分析
- ✅ 量价关系
- ✅ 诱多检测（基于量价）
- ✅ 形态识别
- ✅ 技术指标计算

唯一不能做的是：
- ❌ 盘口细节（十档挂单）
- ❌ 逐笔成交分析
- ❌ 大单对倒识别

### Q4: 需要L2权限吗？

**A**: 不需要。1分钟K线属于基础历史数据，所有QMT用户都可免费使用。

## 集成到你的项目

### 修改 full_market_scanner.py

```python
# 原来的Tick数据流
tick_data = get_tick_stream(stock_code)  # ❌ 容易丢失

# 改为分钟K线
minute_data = fetch_minute_data([stock_code])  # ✅ 完整数据
```

### 建议的迁移步骤

1. **第一阶段**：并行运行
   - 继续运行Tick数据流
   - 同时拉取分钟K线数据
   - 对比数据完整性

2. **第二阶段**：逐步切换
   - 诱多检测 → 切换到分钟K线
   - 趋势分析 → 切换到分钟K线
   - 盘口分析 → 保留Tick数据

3. **第三阶段**：完全迁移
   - 大部分功能使用分钟K线
   - 只有需要盘口细节的功能使用Tick

## 性能对比

| 指标 | Tick数据 | 1分钟K线 |
|------|---------|----------|
| 全市场数据量 | ~2GB/天 | ~20MB/天 |
| 处理时间 | 长（需处理大量数据） | 短（数据量小） |
| 内存占用 | 高 | 低 |
| 样本完整性 | 差 | 优 |

## 总结

**建议**：
1. 立即切换到分钟K线解决样本丢失问题
2. 保留Tick数据用于需要盘口细节的功能
3. 用分钟K线进行策略回测和验证

**优势**：
- 解决样本丢失问题
- 降低系统复杂度
- 提高数据可靠性
- 便于回测和分析

---

**最后更新**: 2026-02-09
**版本**: V1.0