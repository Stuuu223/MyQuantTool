# MyQuantTool 项目进度追踪（Portfolio层 + 回测引擎 + 实盘验证）

**版本**: V17.0.0 - Portfolio层重构
**开始日期**: 2026-02-16
**目标日期**: 2026-02-24（节后第一个交易日）
**状态**: 🚀 执行中

---

## 1. 项目概览

### 1.1 核心目标重新定义

**旧目标**：
- 单只股票30%-50%收益
- 死守某只股票等待兑现

**新目标**（CTO + 老板最终决定）：
- ✅ **账户曲线向上** > 单笔收益故事
- ✅ **机会成本最小化** > 死守某只股票
- ✅ **哪里赚钱最优去哪里**
- ✅ **能赚就赚** > 风格教条

### 1.2 关键参数配置

**Portfolio层核心参数**（基于老板的3个参数）：

| 参数 | 值 | 说明 |
|------|-----|------|
| 最大回撤 | -12%（软约束） | 不是硬性红线，动态风险管理 |
| 最大持仓数 | 3只 | 小资金没必要过度分散 |
| 断层优势阈值 | 1.5倍（可调） | Top1评分 > Top2的1.5倍时单吊 |
| T+1约束 | 是 | A股T+1，今日买入今日不能卖出 |
| 风格 | 不限 | 日内/隔夜/持有几天都可以 |

**回测引擎核心参数**：

| 参数 | 值 | 说明 |
|------|-----|------|
| Tick数据源 | QMT Level-1 | 3秒延迟 |
| 回测周期 | 3个月热门股 | 老板已确认有数据 |
| 滑点设置 | 0.3%（买入）+ 0.3%（卖出） | 可配置 |
| 手续费 | 0.03%（双边） | 可配置 |
| 初始资金 | 200,000元 | 可配置 |

### 1.3 成功标准

**Day 7（2026-02-24）必须达成**：
- ✅ 系统能实时输出持仓评分 vs 候选池评分
- ✅ 系统能自动识别"昨天断层今天普通"的情况
- ✅ 系统能根据实时优势对比做换仓决策
- ✅ 每日业务报告包含：账户收益、调仓次数、换仓收益、退出原因分布
- ✅ 回测报告包含：3个月总收益、最大回撤、胜率、调仓次数统计

---

## 2. QMT Tick数据（重要信息）

### 2.1 数据位置和结构

**数据目录**：
```
data/qmt_data/datadir/
├── SH\0\                      # 上证Tick数据（195只股票）
│   ├── 600007\              # 股票代码目录
│   │   ├── 20251114          # Tick数据文件（按日期命名）
│   │   ├── 20251117
│   │   └── ...（约64个文件）
│   ├── 600017\
│   └── ...（195只股票）
├── SZ\0\                      # 深证Tick数据（344只股票）
│   ├── 000002\              # 股票代码目录
│   │   ├── 20251114          # Tick数据文件（按日期命名）
│   │   ├── 20251117
│   │   └── ...（约64个文件）
│   ├── 000011\
│   └── ...（344只股票）
├── SH\60\                     # 上证60分钟数据（4,614个文件）
├── SZ\60\                     # 深证60分钟数据（5,766个文件）
└── SH\86400\ / SZ\86400\      # 日线数据
```

**数据统计**：
- 股票数量：539只（上证195只 + 深证344只）
- Tick数据大小：19.09GB（SH 7.07GB + SZ 12.02GB）
- 数据格式：QMT专有的Tick数据格式（以日期命名的文件）
- 文件大小：每个文件约694KB
- 每只股票：约64个文件（对应约64个交易日）

**数据时间范围**：
- 起始日期：2025年11月14日
- 截止日期：2026年2月16日
- 时间跨度：约3个月

**VIP站点配置**：
- VIP Token: [已隐藏，防止泄露]
- VIP站点1: vipsxmd1.thinktrader.net:55310
- VIP站点2: vipsxmd2.thinktrader.net:55310
- VIP站点3: dxzzmd1.thinktrader.net:55300
- VIP站点4: dxzzmd2.thinktrader.net:55300
- VIP站点5: ltzzmd1.thinktrader.net:55300
- VIP站点6: ltzzmd2.thinktrader.net:55300

**VIP Token存储位置**：
- 本地配置文件：C:\Users\a'b\.iflow\AGENTS.md
- ⚠️ 不要将VIP Token提交到Git仓库

**数据访问方式**：
```python
from xtquant import xtdata

# 连接QMT VIP站点
xtdata.connect(ip='vipsxmd1.thinktrader.net', port=55310, remember_if_success=False)

# 读取Tick数据
data = xtdata.get_local_data(
    stock_list=['000002.SZ'],
    period='tick',
    start_time='20251114 09:30:00',
    end_time='20260216 15:00:00'
)
```

### 2.2 热门股数据验证

| 股票代码 | 股票名称 | 市场状态 | Tick数据状态 |
|---------|---------|---------|-------------|
| 300997.SZ | 欢乐家 | ✅ 深证市场 | ✅ 存在（65个文件） |
| 603697.SH | 有友食品 | ❓ 上证市场 | ❌ 未找到（可能不在539只中） |
| 000001.SZ | 平安银行 | ✅ 深证市场 | ✅ 存在 |
| 600519.SH | 贵州茅台 | ❓ 上证市场 | ❓ 待确认 |

---

## 2.5 V12标准样本池规格（新增）

### 2.5.1 设计原则

**配置驱动**：所有参数从 `config/auction_sample_config.json` 读取，禁止硬编码。

**分层抽样**：
- **配额分配维度（2维）**：交易所 + 成交额三分位
- **辅助标签（2维）**：价格层 + 涨跌层（仅统计，不参与配额）

**可复现性**：固定随机种子（random_seed=42），保证相同样本池可重建。

### 2.5.2 配置参数

**Profile: v12_standard（默认）**

| 参数 | 值 | 说明 |
|------|-----|------|
| price_min | 3.0 | 最低价格过滤（排除仙股） |
| price_max | 100.0 | 最高价格过滤（排除超高价股） |
| min_auction_amount | 1,000,000 | 最小竞价成交额（排除僵尸股） |
| target_count | 80 | 目标样本数量 |
| random_seed | 42 | 随机种子，保证可复现 |
| exchange_min_quota | 2 | 每交易所最少样本数 |
| liquidity_buckets | 3 | 成交额分层层数（三分位） |

**其他Profiles**：
- `v12_low_price_focus`: 价格范围2-30元，适合低价股策略研究
- `v12_high_liquidity`: 成交额门槛500万，目标50只，适合高流动性策略

### 2.5.3 存储位置

```
config/auction_sample_config.json          # 配置文件
scripts/generate_stratified_sample_v2.py   # 生成脚本
scripts/samples/test_80_stocks_v12_standard.txt  # 样本池输出
```

### 2.5.4 使用方式

```python
from scripts.generate_stratified_sample_v2 import generate_stratified_sample

# 使用默认v12_standard配置
codes = generate_stratified_sample()

# 使用其他profile
codes = generate_stratified_sample(config_profile='v12_low_price_focus')
```

### 2.5.5 样本池状态

| 版本 | 状态 | 说明 |
|------|------|------|
| test_80_stocks.txt | V11旧版 | 顺序抽样（539只tick数据前80只），仅作对照 |
| test_80_stocks_v12_standard.txt | **V12标准** ✅ APPROVED_IN_MILESTONE | 分层抽样（交易所+成交额），可用于正式回测 |

**✅ CTO审批状态**：
- **审批日期**：2026-02-18
- **审批人**：CTO
- **用途限定**："V12流动性分层基础样本池生成器"
- **适用范围**：正式回测流水线（需标注使用的profile名）

**⚠️ 重要限制**：
- 当前样本池**不含情绪/龙头/周期标签**，仅用于回测引擎参数探索
- 如需情绪周期标签，需接入额外数据源（Tushare DDE/顽主杯等）
- 所有基于该样本池的回测报告必须标注使用的profile名（如v12_standard）

---

## 3. 项目当前状态（真实情况）

### 3.1 现有系统能力盘点

**✅ 已有的核心能力**：
- 三把斧风控体系（防守斧、时机斧、资金斧）
- 三漏斗扫描器（Level 1技术面粗筛 → Level 2资金流向分析 → Level 3诱多陷阱检测）
- 板块共振检查（Leaders≥3 + Breadth≥35%）
- 诱多检测器（4种模式）
- 数据抽象层（ICapitalFlowProvider + DataProviderFactory）

**✅ 已有的基础设施**：
- Portfolio优化器（马科维茨、风险平价、Black-Litterman）
- 回测框架（基于历史快照重建）
- QMT Tick数据接口
- 日志系统

### 2.2 痛点分析

**❌ 核心痛点**：

| 痛点 | 严重性 | 说明 |
|------|--------|------|
| 违反铁律2：30秒固定间隔扫描 | 🔴 极高 | 错过90%的起爆机会 |
| 违反铁律5：54个文件直接调用akshare | 🔴 极高 | 数据源切换困难，回测和实施数据不一致 |
| Portfolio层缺失 | 🔴 高 | 现有PortfolioOptimizer是学术型静态优化器，不符合实战需求 |
| 事件驱动机制不明确 | 🔴 高 | EventDrivenMonitor名不副实，实际是定时轮询 |
| Tick级回测引擎不完整 | 🟡 中 | 缺少参数优化功能 |

### 2.3 技术债务

```
技术债务总览:
├── 数据抽象层债务: 54个文件需要重构（91个akshare直接调用）
├── 事件驱动债务: EventDrivenMonitor需要重新设计（移除30秒固定间隔）
├── Portfolio层债务: 需要从零开始（现有PortfolioOptimizer不可用）
├── 回测引擎债务: 需要完善和集成（缺少参数优化）
└── 测试债务: pytest框架需要QMT mock
```

---

## 3. 7天实施计划

### 3.1 Day 1-2: Portfolio层核心代码

**目标**：创建符合CTO要求的Portfolio层

**任务清单**：

| 任务 | 负责人 | 完成时间 | 状态 |
|------|--------|----------|------|
| 创建logic/portfolio目录结构 | AI总监 | Day 1 上午 | ⏳ 待开始 |
| 创建portfolio_config.json | AI总监 | Day 1 上午 | ⏳ 待开始 |
| 实现CapitalAllocator核心类 | CTO | Day 1 下午 | ⏳ 待开始 |
| 实现实时重新评分逻辑 | CTO | Day 2 上午 | ⏳ 待开始 |
| 实现换仓决策（基于实时对比） | CTO | Day 2 下午 | ⏳ 待开始 |
| 单元测试 | 开发者 | Day 2 下午 | ⏳ 待开始 |

**关键交付物**：
- `logic/portfolio/capital_allocator.py`（核心500行）
- `config/portfolio_config.json`（参数化配置）
- `tests/test_capital_allocator.py`（单元测试）

**成功标准**：
- ✅ CapitalAllocator能实时重新计算持仓评分
- ✅ 能识别断层优势（Top1 > Top2的1.5倍）
- ✅ 能根据实时优势对比做换仓决策
- ✅ 所有单元测试通过

---

### 3.2 Day 3-4: Tick级回测引擎

**目标**：完善Tick级回测引擎，支持参数优化

**任务清单**：

| 任务 | 负责人 | 完成时间 | 状态 |
|------|--------|----------|------|
| 实现TickBacktestEngine核心类 | 开发者 | Day 3 | ⏳ 待开始 |
| 实现3个月热门股Tick数据加载 | 开发者 | Day 3 | ⏳ 待开始 |
| 实现ParameterOptimizer网格搜索 | 开发者 | Day 4 | ⏳ 待开始 |
| 单元测试 | 测试者 | Day 4 | ⏳ 待开始 |

**关键交付物**：
- `backtest/tick_backtest_engine.py`（核心300行）
- `backtest/parameter_optimizer.py`（网格搜索）
- `tests/test_tick_backtest.py`（单元测试）

**成功标准**：
- ✅ 能加载3个月热门股Tick数据
- ✅ 能逐Tick回放
- ✅ 能运行网格搜索参数优化
- ✅ 所有单元测试通过

---

### 3.3 Day 5: 参数优化

**目标**：找到最优参数组合

**任务清单**：

| 任务 | 负责人 | 完成时间 | 状态 |
|------|--------|----------|------|
| 运行参数优化（网格搜索） | 开发者 | Day 5 上午 | ⏳ 待开始 |
| 分析回测报告 | CTO | Day 5 下午 | ⏳ 待开始 |
| 更新portfolio_config.json | CTO | Day 5 下午 | ⏳ 待开始 |

**关键交付物**：
- 回测报告（3个月总收益、最大回撤、胜率、调仓次数）
- 最优参数组合
- 更新后的portfolio_config.json

**成功标准**：
- ✅ 找到最优参数（收益/回撤比最高）
- ✅ 回测报告包含所有关键指标
- ✅ portfolio_config.json更新为最优参数

---

### 3.4 Day 6: 集成测试

**目标**：将Portfolio层集成到EventDrivenMonitor

**任务清单**：

| 任务 | 负责人 | 完成时间 | 状态 |
|------|--------|----------|------|
| 集成CapitalAllocator到EventDrivenMonitor | CTO | Day 6 上午 | ⏳ 待开始 |
| 集成测试 | 测试者 | Day 6 下午 | ⏳ 待开始 |
| 性能测试 | 开发者 | Day 6 下午 | ⏳ 待开始 |

**关键交付物**：
- 集成后的EventDrivenMonitor
- 集成测试报告
- 性能测试报告

**成功标准**：
- ✅ Portfolio层与EventDrivenMonitor集成成功
- ✅ 所有集成测试通过
- ✅ 性能满足要求（响应时间<100ms）

---

### 3.5 Day 7: 实盘验证

**目标**：节后第一个交易日实盘验证

**任务清单**：

| 任务 | 负责人 | 完成时间 | 状态 |
|------|--------|----------|------|
| 实盘监控Portfolio决策 | 全员 | Day 7 全天 | ⏳ 待开始 |
| 记录每次换仓的依据和结果 | 测试者 | Day 7 全天 | ⏳ 待开始 |
| 收盘后生成每日报告 | CTO | Day 7 收盘 | ⏳ 待开始 |
| 对比回测参数是否需要调整 | CTO | Day 7 收盘 | ⏳ 待开始 |

**关键交付物**：
- 实盘决策日志
- 每日业务报告
- 参数调整建议

**成功标准**：
- ✅ 系统能实时输出持仓评分 vs 候选池评分
- ✅ 系统能自动识别"昨天断层今天普通"的情况
- ✅ 系统能根据实时优势对比做换仓决策
- ✅ 每日业务报告包含所有关键指标

---

## 4. 每日进度追踪

### 4.1 Day 1（2026-02-16）：Portfolio层核心代码 + QMT数据探索

**✅ 已完成**：
- CapitalAllocator核心类（370行）
- PortfolioMetrics业务指标（237行）
- 配置文件参数化
- 单元测试（13个测试用例全部通过）
- QMT VIP连接测试（6个站点全部连接成功）
- QMT Tick数据探索（发现539只股票的19.09GB数据）

**📊 发现的数据**：
- 数据位置：data/qmt_data\datadir\SH\0\ 和 data/qmt_data\datadir\SZ\0\
- 数据大小：19.09GB（SH 7.07GB + SZ 12.02GB）
- 数据时间：2025年11月14日 ~ 2026年2月16日（约3个月）
- 股票数量：539只（上证195只 + 深证344只）

**⚠️ CTO的质疑（已验证）**：
- ✅ 代码质量高（8/10）
- ❌ 缺乏真实数据测试（3/10）
- ❌ 参数缺乏回测验证（2/10）
- ❌ 与EventDrivenMonitor未集成（2/10）

**Git提交**：
- 提交1：V17.0.0 - Portfolio层重构（0dfb933）
- 提交2：项目理念更新（ed3c08a）
- 提交3：QMT数据位置文档（4e7ce7a）

**下一步**：用真实Tick数据测试Portfolio层

**计划开始**: 2026-02-16 18:00
**计划结束**: 2026-02-16 23:59
**实际开始**: 2026-02-16 18:00
**实际结束**: 2026-02-16 18:45
**状态**: ✅ 已完成

**任务清单**：

| 任务 | 计划开始 | 计划结束 | 实际开始 | 实际结束 | 状态 | 备注 |
|------|----------|----------|----------|----------|------|------|
| 创建logic/portfolio目录结构 | 18:00 | 18:30 | 18:00 | 18:00 | ✅ 完成 | 目录已存在 |
| 创建portfolio_config.json | 18:30 | 19:00 | 18:00 | 18:00 | ✅ 完成 | 参数化配置 |
| 实现CapitalAllocator核心类 | 19:00 | 23:59 | 18:00 | 18:30 | ✅ 完成 | 核心功能完整 |
| 实现PortfolioMetrics类 | 19:00 | 23:59 | 18:30 | 18:40 | ✅ 完成 | 业务指标完整 |
| 单元测试 | 19:00 | 23:59 | 18:40 | 18:45 | ✅ 完成 | 所有测试通过 |

**关键交付物**：
- ✅ `logic/portfolio/capital_allocator.py`（核心500行）
- ✅ `logic/portfolio/portfolio_metrics.py`（业务指标）
- ✅ `config/portfolio_config.json`（参数化配置）
- ✅ `tests/test_capital_allocator.py`（单元测试）

**测试结果**：
```
✅ 测试通过: CapitalAllocator初始化
✅ 测试通过: 综合评分 (高分=0.82, 低分=0.00)
✅ 测试通过: 平仓检查（主力出逃、风险恶化、极限回撤、机会成本过高）
✅ 测试通过: 单只股票仓位分配 (90000.0元)
✅ 测试通过: 断层优势识别（单吊000001.SZ）
✅ 测试通过: 2只股票分散（000001.SZ=60000.0元, 000002.SZ=40000.0元）
✅ 测试通过: 3只股票分散（50%+30%+20%）
✅ 测试通过: Position属性（市值、浮动盈亏、收益率）
✅ 测试通过: Position平仓（T+1约束）
✅ 测试通过: 记录起爆点捕捉
✅ 测试通过: 记录调仓操作
✅ 测试通过: 记录平仓操作
✅ 测试通过: 生成每日报告
```

**备注**：
- ✅ Day 1所有任务已完成（用时45分钟）
- ✅ 所有单元测试通过
- ✅ CapitalAllocator核心功能完整：
  - 实时重新评分（不看历史标签）
  - 换仓决策（持仓 vs 候选池实时PK）
  - 动态仓位分配（1只/2只/3只）
  - T+1约束处理
- ✅ PortfolioMetrics业务指标完整：
  - 每日业务报告
  - 实时仪表盘
  - 业务指标追踪

---

### 4.2 Day 2（2026-02-17）进度

**计划开始**: 2026-02-17 09:00
**计划结束**: 2026-02-17 23:59
**状态**: ⏳ 待开始

**任务清单**：

| 任务 | 计划开始 | 计划结束 | 实际开始 | 实际结束 | 状态 | 备注 |
|------|----------|----------|----------|----------|------|------|
| 实现实时重新评分逻辑 | 09:00 | 12:00 | - | - | ⏳ 待开始 | |
| 实现换仓决策（基于实时对比） | 13:00 | 18:00 | - | - | ⏳ 待开始 | |
| 单元测试 | 19:00 | 23:59 | - | - | ⏳ 待开始 | |

**备注**：
- 必须完成Portfolio层核心代码
- 所有单元测试必须通过

---

### 4.3 Day 3-7 进度

**待更新**...

---

## 5. 风险点和检查点

### 5.1 技术风险

| 风险描述 | 可能性 | 影响程度 | 缓解措施 | 负责人 | 状态 |
|----------|--------|----------|----------|--------|------|
| Portfolio层开发时间不足 | 🔴 高 | 🔴 高 | 优先完成核心功能，延后次要功能 | CTO | ⏳ 监控中 |
| Tick数据加载失败 | 🟡 中 | 🔴 高 | 提前验证数据可用性 | 开发者 | ⏳ 监控中 |
| 参数优化时间过长 | 🟡 中 | 🟡 中 | 限制参数搜索空间 | 开发者 | ⏳ 监控中 |
| 集成测试发现严重bug | 🟡 中 | 🔴 高 | 每天进行集成测试 | 测试者 | ⏳ 监控中 |
| 实盘验证失败 | 🟡 中 | 🔴 高 | 提前进行充分测试 | 全员 | ⏳ 监控中 |

### 5.2 业务风险

| 风险描述 | 可能性 | 影响程度 | 缓解措施 | 负责人 | 状态 |
|----------|--------|----------|----------|--------|------|
| 参数优化结果不理想 | 🟡 中 | 🟡 中 | 准备多组参数备选方案 | CTO | ⏳ 监控中 |
| 实盘表现与回测差距大 | 🟡 中 | 🔴 高 | 充分考虑滑点和冲击成本 | CTO | ⏳ 监控中 |
| 换仓频率过高 | 🟡 中 | 🟡 中 | 设置最小持有天数 | CTO | ⏳ 监控中 |

### 5.3 检查点清单

**Day 2检查点**：
- [ ] Portfolio层核心代码完成
- [ ] 所有单元测试通过
- [ ] 实时重新评分逻辑正确
- [ ] 换仓决策逻辑正确

**Day 4检查点**：
- [ ] Tick级回测引擎完成
- [ ] 能加载3个月热门股Tick数据
- [ ] 参数优化功能正常
- [ ] 所有单元测试通过

**Day 6检查点**：
- [ ] Portfolio层与EventDrivenMonitor集成成功
- [ ] 所有集成测试通过
- [ ] 性能满足要求（响应时间<100ms）

**Day 7检查点**：
- [ ] 实盘验证成功
- [ ] 系统能实时输出持仓评分 vs 候选池评分
- [ ] 系统能自动识别"昨天断层今天普通"的情况
- [ ] 系统能根据实时优势对比做换仓决策
- [ ] 每日业务报告包含所有关键指标

---

## 6. 关键依赖和里程碑

### 6.1 模块依赖图

```
┌─────────────────────────────────────────────────────────────┐
│                     MyQuantTool V17.0 架构                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────┐
│  Event-Driven   │  ← 需要改造（移除30秒固定间隔）
│    Monitor      │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│   Portfolio     │  ← 新增（核心模块）
│    Manager      │
└────────┬────────┘
         │
    ┌────┴────┬─────────────┬─────────────┐
    ↓         ↓             ↓             ↓
┌───────┐ ┌───────┐   ┌──────────┐  ┌──────────┐
│Data   │ │Tick   │   │Parameter │  │Risk      │
│Provider││Backtest│   │Optimizer │  │Controller│
└───┬───┘ └───┬───┘   └──────────┘  └──────────┘
    │         │
    ↓         ↓
┌───────┐ ┌───────┐
│QMT    │ │Hot    │
│Level1 │ │Stocks │
└───┬───┘ └───┬───┘
    │         │
    └────┬────┘
         ↓
    ❌ 54个文件直接调用akshare（延后处理）
```

### 6.2 里程碑时间表

| 里程碑 | 日期 | 状态 | 备注 |
|--------|------|------|------|
| Portfolio层核心代码完成 | 2026-02-17 | ⏳ 待完成 | Day 2检查点 |
| Tick级回测引擎完成 | 2026-02-19 | ⏳ 待完成 | Day 4检查点 |
| 参数优化完成 | 2026-02-20 | ⏳ 待完成 | Day 5检查点 |
| 集成测试通过 | 2026-02-21 | ⏳ 待完成 | Day 6检查点 |
| 实盘验证成功 | 2026-02-24 | ⏳ 待完成 | Day 7检查点 |

---

## 7. 附录

### 7.1 技术架构图

见上文"6.1 模块依赖图"

### 7.2 数据流图

```
Tick数据（QMT）
    ↓
实时评分（CapitalAllocator）
    ↓
持仓评分 vs 候选池评分
    ↓
换仓决策（实时对比）
    ↓
执行交易（TradeGatekeeper）
    ↓
更新持仓（PortfolioManager）
    ↓
生成报告（PortfolioMetrics）
```

### 7.3 参考资料

- CTO深度审计报告（2026-02-16 17:50）
- 老板最终决定（2026-02-16）
- V11开发指南（11条铁律）
- 知识库V12.1.0

---

**文档维护**：
- 创建人：AI项目总监
- 最后更新：2026-02-18 20:45
- 更新频率：每日更新

---

## 8. 2026-02-18 重要更新（V17.1.0关键决策）

### 8.1 V12.1.0过滤器问题发现与处置

**发现过程**：
- 在顽主杯分析框架中启用V12.1.0过滤器（板块共振+动态阈值+竞价校验）
- 发现回测通过率仅0.11%（13561只→15只交易）
- 实际数据表现：-21%收益，25%胜率（vs模拟数据+9%，93%胜率）

**根因分析**：
1. 板块共振阈值过高（涨停≥3只/上涨≥35%）→通过率3.8%
2. 市值过滤误杀（<50亿或>1000亿）→右侧起爆股被截杀
3. 串联一票否决架构→单点失效
4. 竞价数据估算失真（prev_close*0.99）

**处置决策**（CTO+老板拍板）：
- ✅ V12.1.0标记为EXPERIMENTAL，默认禁用（`enable_filters=False`）
- ✅ 回滚到V11 TripleFunnel评分制防守轴
- ✅ 新过滤逻辑必须基于已验证的"评分制"抽象
- ✅ 禁止在新引擎里单独硬写条件树

**文档更新**：
- `docs/CORE_ARCHITECTURE.md`：新增0.2、0.3、0.4节
- `docs/V17_TECH_DEBT.md`：新增技术债务条目#1、#2

---

### 8.2 资金攻击检测实验（网宿科技验证）

**实验脚本**：`backtest/exp_capital_attack_backtest.py`

**核心发现**：
| 日期 | 净流入 | 价格强度 | 评分 | 结果 |
|-----|--------|---------|------|------|
| 1月26日 | 122亿 | 12.7% | 1.00 | ✅ **触发** |
| 1月27日 | 117万 | -3.2% | 0.00 | ❌ |
| 2月5日 | 456万 | 4.8% | 0.00 | ❌ |

**关键验证**：
- ✅ 1月26日涨停日被正确识别（资金攻击评分满分）
- ✅ 资金检测有效，但阈值需从"绝对值"改为"相对分位数"
- ⚠️ 发现1月27日/2月5日数据异常（可能Tick解析问题）

**架构铁律新增**（老板定调）：
> "心中无顶底，跟随市场。资金强度是相对概念，不是绝对数值。"

**禁止**：
- ❌ 硬编码阈值（`> 100_000_000`、`> 0.05`）
- ❌ 核心引擎中出现魔法数字

**正确做法**：
- ✅ 使用相对比率：`ratio = main_inflow / circ_mv`
- ✅ 市场分位数：每天自动计算分布，前1%触发
- ✅ 配置驱动：实验参数放`config/exp_*.json`

---

### 8.3 Tick Provider统一封装规范

**问题发现**：
- Tick下载逻辑散落在5+个脚本（data_prefetch、download_wanzhu_tick_data、test_wangsu_*等）
- 重复踩坑：VIP直连错误、端口占用、日期格式混乱

**规范输出**：`.iflow/tick_provider_spec.md`

**核心接口**：
```python
class TickProvider:
    def ensure_history(self, code: str, start: str, end: str) -> None
    def load_ticks(self, code: str, start: str, end: str) -> pd.DataFrame
    def get_coverage(self, code: str) -> List[str]  # 返回有数据的日期列表
```

**Code Review红线**：
- 🔴 禁止直接`import xtdata`/`import xtdatacenter`
- 🔴 禁止脚本自己连VIP/算数据目录
- ✅ 必须通过`TickProvider`统一接口

---

### 8.4 热门样本回测原则确立

**强制样本集合**（任何策略修改必须验证）：

| 样本类型 | 标的 | 时间区间 | 验证重点 |
|---------|------|---------|---------|
| 基准强势股 | 网宿科技 300017.SZ | 2025-11-13~2026-02-13 | 资金攻击识别 |
| 顽主杯真实区间 | TopList 131只 | 2026-02-04~2026-02-13 | 上榜前触发率 |
| 经典形态票 | 志特新材等 | 主升启动日±5天 | 平台突破适配 |

**工程规范**：
- 提供`backtest/exp_*_backtest.py`独立实验脚本
- 热门票列表：`config/hot_sample_stocks.json`
- CI/CD检查：PR必须附带热门票回测报告
- ❌ 未经热门票验证禁止全市场扫描

---

## 9. 下一步行动（更新）

### 立即执行（今天）
- [x] 禁用V12.1.0过滤器（标记EXPERIMENTAL）
- [x] 撤销核心引擎硬编码（恢复干净）
- [x] 创建独立资金攻击实验脚本
- [x] 输出Tick Provider规范文档
- [x] 验证网宿科技资金攻击检测

### 明天完成
- [ ] TRIVIAL基线（网宿）- 确认Trivial在热门票上的表现
- [ ] HALFWAY形态（网宿）- 确认Halfway是否错过1月26日
- [ ] 顽主131只资金扫描 - 批量检测资金攻击分布
- [ ] 对比触发率 - 形态错过但资金捕捉的情况统计

### 本周完成
- [ ] TickProvider封装实现
- [ ] 所有脚本迁移到统一接口
- [ ] V11 TripleFunnel抽象为通用过滤层

---

**关键决策记录**（CTO+老板）：
1. ✅ V12.1.0过滤器默认禁用，不可用于生产
2. ✅ 资金强度使用相对分位数，禁止硬编码绝对值
3. ✅ 任何修改必须在热门票样本验证后才能进主线
4. ✅ Tick数据通路必须统一封装，禁止各自为政

**下一步行动**：
- [ ] 创建logic/portfolio目录结构
- [ ] 创建portfolio_config.json
- [ ] 开始实现CapitalAllocator核心类

---

## 11. 技术债务清理报告 (2026-02-19)

### 11.1 清理摘要

| 类别 | 清理前 | 清理后 | 减少 |
|------|--------|--------|------|
| docs/ | 15个md | 13个md | -2 |
| logic/子目录 | 30个 | 25个 | -5 |
| config/配置 | 27个 | 17个 | -10 |
| data/主目录 | 5个wanzhu | 0个 | -5 |

### 11.2 已删除文件清单

**docs/ (2个过时文档)**：
- BACKTEST_SYSTEM_V2_ARCHITECTURE.md - 包含V14过时内容
- NAMING_CONVENTIONS.md - 包含过时标记

**logic/ (5个孤立目录)**：
- data/ - 空目录
- exp/ - 空目录
- adjustment/ - 无引用（online_parameter_adjustment.py）
- mobile/ - 无引用（mobile_adapter.py）
- recommenders/ - 无引用（smart_recommender.py）

**config/ (10个配置)**：
- phase1_config.yaml - 未引用
- phase2_config.yaml - 未引用
- wanzhu_top50_tick_download.json - 已被wanzhu_selected_150.csv替代
- wanzhu_name_to_code_mapping.json - 未引用
- wanzhu_top_120.json - 已迁移到CSV
- wanzhu_top50_usable.json - 已迁移到CSV
- wanzhu_big_movers.json - 已迁移到CSV
- wanzhu_top150_tick_download.json - 已迁移到CSV
- active_stocks_detail.json - 未引用
- auction_sample_config.json - 未引用
- balanced_monitor_list.json - 未引用
- halfway_sample_dates.json - 未引用
- hot_stocks_detail.json - 未引用

**data/ (5个重复/未引用文件)**：
- wanzhu_first_rank_cleaned.json
- wanzhu_history_cleaned.csv
- wanzhu_history_from_api.csv
- wanzhu_history_mapped.csv
- wanzhu_history_mock.csv
- wanzhu_data/processed/wanzhu_history_fixed.csv (重复)

### 11.3 代码修改

**修改文件**：
- logic/services/config_service.py - 移除wanzhu json映射，统一使用CSV
- backtest/run_hot_cases_suite.py - 改用wanzhu_selected_150.csv
- backtest/run_comprehensive_backtest.py - 改用wanzhu_selected_150.csv
- backtest/exp_capital_attack_backtest.py - 改用wanzhu_selected_150.csv

### 11.4 .gitignore更新

新增忽略规则：
```
xtquant/  # QMT SDK，通过pip安装
```

### 11.5 验证结果

```
✅ ConfigService.get_stock_universe(): 150只股票
✅ backtest/run_hot_cases_suite.py 语法正确
✅ backtest/run_comprehensive_backtest.py 语法正确
✅ backtest/exp_capital_attack_backtest.py 语法正确
✅ wanzhu_selected_150.csv: 150只股票
```

### 11.6 清理原则

1. **复现难度优先**：可从上游数据重建的派生数据直接删除，不进legacy
2. **引用检查**：无引用的文件直接删除
3. **统一数据源**：wanzhu股票池统一使用wanzhu_selected_150.csv，后续迁移到远程DB
4. **小目录合并**：孤立小目录（<=2文件）检查引用后决定删除或保留