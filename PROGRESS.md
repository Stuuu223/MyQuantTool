# MyQuantTool 项目进度追踪（Portfolio层 + 回测引擎 + 实盘验证）

**版本**: V17.0.0 - Portfolio层重构
**开始日期**: 2026-02-16
**目标日期**: 2026-02-24（节后第一个交易日）
**状态**: 🚀 执行中

---

## 1. 项目概览

### 1.1 核心目标重新定义

**旧目标**：
- 单只股票30%-50%收益
- 死守某只股票等待兑现

**新目标**（CTO + 老板最终决定）：
- ✅ **账户曲线向上** > 单笔收益故事
- ✅ **机会成本最小化** > 死守某只股票
- ✅ **哪里赚钱最优去哪里**
- ✅ **能赚就赚** > 风格教条

### 1.2 关键参数配置

**Portfolio层核心参数**（基于老板的3个参数）：

| 参数 | 值 | 说明 |
|------|-----|------|
| 最大回撤 | -12%（软约束） | 不是硬性红线，动态风险管理 |
| 最大持仓数 | 3只 | 小资金没必要过度分散 |
| 断层优势阈值 | 1.5倍（可调） | Top1评分 > Top2的1.5倍时单吊 |
| T+1约束 | 是 | A股T+1，今日买入今日不能卖出 |
| 风格 | 不限 | 日内/隔夜/持有几天都可以 |

**回测引擎核心参数**：

| 参数 | 值 | 说明 |
|------|-----|------|
| Tick数据源 | QMT Level-1 | 3秒延迟 |
| 回测周期 | 3个月热门股 | 老板已确认有数据 |
| 滑点设置 | 0.3%（买入）+ 0.3%（卖出） | 可配置 |
| 手续费 | 0.03%（双边） | 可配置 |
| 初始资金 | 200,000元 | 可配置 |

### 1.3 成功标准

**Day 7（2026-02-24）必须达成**：
- ✅ 系统能实时输出持仓评分 vs 候选池评分
- ✅ 系统能自动识别"昨天断层今天普通"的情况
- ✅ 系统能根据实时优势对比做换仓决策
- ✅ 每日业务报告包含：账户收益、调仓次数、换仓收益、退出原因分布
- ✅ 回测报告包含：3个月总收益、最大回撤、胜率、调仓次数统计

---

## 2. QMT Tick数据（重要信息）

### 2.1 数据位置和结构

**数据目录**：
```
data/qmt_data/datadir/
├── SH\0\                      # 上证Tick数据（195只股票）
│   ├── 600007\              # 股票代码目录
│   │   ├── 20251114          # Tick数据文件（按日期命名）
│   │   ├── 20251117
│   │   └── ...（约64个文件）
│   ├── 600017\
│   └── ...（195只股票）
├── SZ\0\                      # 深证Tick数据（344只股票）
│   ├── 000002\              # 股票代码目录
│   │   ├── 20251114          # Tick数据文件（按日期命名）
│   │   ├── 20251117
│   │   └── ...（约64个文件）
│   ├── 000011\
│   └── ...（344只股票）
├── SH\60\                     # 上证60分钟数据（4,614个文件）
├── SZ\60\                     # 深证60分钟数据（5,766个文件）
└── SH\86400\ / SZ\86400\      # 日线数据
```

**数据统计**：
- 股票数量：539只（上证195只 + 深证344只）
- Tick数据大小：19.09GB（SH 7.07GB + SZ 12.02GB）
- 数据格式：QMT专有的Tick数据格式（以日期命名的文件）
- 文件大小：每个文件约694KB
- 每只股票：约64个文件（对应约64个交易日）

**数据时间范围**：
- 起始日期：2025年11月14日
- 截止日期：2026年2月16日
- 时间跨度：约3个月

**VIP站点配置**：
- VIP Token: 6b1446e317ed67596f13d2e808291a01e0dd9839
- VIP站点1: vipsxmd1.thinktrader.net:55310
- VIP站点2: vipsxmd2.thinktrader.net:55310
- VIP站点3: dxzzmd1.thinktrader.net:55300
- VIP站点4: dxzzmd2.thinktrader.net:55300
- VIP站点5: ltzzmd1.thinktrader.net:55300
- VIP站点6: ltzzmd2.thinktrader.net:55300

**数据访问方式**：
```python
from xtquant import xtdata

# 连接QMT VIP站点
xtdata.connect(ip='vipsxmd1.thinktrader.net', port=55310, remember_if_success=False)

# 读取Tick数据
data = xtdata.get_local_data(
    stock_list=['000002.SZ'],
    period='tick',
    start_time='20251114 09:30:00',
    end_time='20260216 15:00:00'
)
```

### 2.2 热门股数据验证

| 股票代码 | 股票名称 | 市场状态 | Tick数据状态 |
|---------|---------|---------|-------------|
| 300997.SZ | 欢乐家 | ✅ 深证市场 | ✅ 存在（65个文件） |
| 603697.SH | 有友食品 | ❓ 上证市场 | ❌ 未找到（可能不在539只中） |
| 000001.SZ | 平安银行 | ✅ 深证市场 | ✅ 存在 |
| 600519.SH | 贵州茅台 | ❓ 上证市场 | ❓ 待确认 |

---

## 3. 项目当前状态（真实情况）

### 3.1 现有系统能力盘点

**✅ 已有的核心能力**：
- 三把斧风控体系（防守斧、时机斧、资金斧）
- 三漏斗扫描器（Level 1技术面粗筛 → Level 2资金流向分析 → Level 3诱多陷阱检测）
- 板块共振检查（Leaders≥3 + Breadth≥35%）
- 诱多检测器（4种模式）
- 数据抽象层（ICapitalFlowProvider + DataProviderFactory）

**✅ 已有的基础设施**：
- Portfolio优化器（马科维茨、风险平价、Black-Litterman）
- 回测框架（基于历史快照重建）
- QMT Tick数据接口
- 日志系统

### 2.2 痛点分析

**❌ 核心痛点**：

| 痛点 | 严重性 | 说明 |
|------|--------|------|
| 违反铁律2：30秒固定间隔扫描 | 🔴 极高 | 错过90%的起爆机会 |
| 违反铁律5：54个文件直接调用akshare | 🔴 极高 | 数据源切换困难，回测和实施数据不一致 |
| Portfolio层缺失 | 🔴 高 | 现有PortfolioOptimizer是学术型静态优化器，不符合实战需求 |
| 事件驱动机制不明确 | 🔴 高 | EventDrivenMonitor名不副实，实际是定时轮询 |
| Tick级回测引擎不完整 | 🟡 中 | 缺少参数优化功能 |

### 2.3 技术债务

```
技术债务总览:
├── 数据抽象层债务: 54个文件需要重构（91个akshare直接调用）
├── 事件驱动债务: EventDrivenMonitor需要重新设计（移除30秒固定间隔）
├── Portfolio层债务: 需要从零开始（现有PortfolioOptimizer不可用）
├── 回测引擎债务: 需要完善和集成（缺少参数优化）
└── 测试债务: pytest框架需要QMT mock
```

---

## 3. 7天实施计划

### 3.1 Day 1-2: Portfolio层核心代码

**目标**：创建符合CTO要求的Portfolio层

**任务清单**：

| 任务 | 负责人 | 完成时间 | 状态 |
|------|--------|----------|------|
| 创建logic/portfolio目录结构 | AI总监 | Day 1 上午 | ⏳ 待开始 |
| 创建portfolio_config.json | AI总监 | Day 1 上午 | ⏳ 待开始 |
| 实现CapitalAllocator核心类 | CTO | Day 1 下午 | ⏳ 待开始 |
| 实现实时重新评分逻辑 | CTO | Day 2 上午 | ⏳ 待开始 |
| 实现换仓决策（基于实时对比） | CTO | Day 2 下午 | ⏳ 待开始 |
| 单元测试 | 开发者 | Day 2 下午 | ⏳ 待开始 |

**关键交付物**：
- `logic/portfolio/capital_allocator.py`（核心500行）
- `config/portfolio_config.json`（参数化配置）
- `tests/test_capital_allocator.py`（单元测试）

**成功标准**：
- ✅ CapitalAllocator能实时重新计算持仓评分
- ✅ 能识别断层优势（Top1 > Top2的1.5倍）
- ✅ 能根据实时优势对比做换仓决策
- ✅ 所有单元测试通过

---

### 3.2 Day 3-4: Tick级回测引擎

**目标**：完善Tick级回测引擎，支持参数优化

**任务清单**：

| 任务 | 负责人 | 完成时间 | 状态 |
|------|--------|----------|------|
| 实现TickBacktestEngine核心类 | 开发者 | Day 3 | ⏳ 待开始 |
| 实现3个月热门股Tick数据加载 | 开发者 | Day 3 | ⏳ 待开始 |
| 实现ParameterOptimizer网格搜索 | 开发者 | Day 4 | ⏳ 待开始 |
| 单元测试 | 测试者 | Day 4 | ⏳ 待开始 |

**关键交付物**：
- `backtest/tick_backtest_engine.py`（核心300行）
- `backtest/parameter_optimizer.py`（网格搜索）
- `tests/test_tick_backtest.py`（单元测试）

**成功标准**：
- ✅ 能加载3个月热门股Tick数据
- ✅ 能逐Tick回放
- ✅ 能运行网格搜索参数优化
- ✅ 所有单元测试通过

---

### 3.3 Day 5: 参数优化

**目标**：找到最优参数组合

**任务清单**：

| 任务 | 负责人 | 完成时间 | 状态 |
|------|--------|----------|------|
| 运行参数优化（网格搜索） | 开发者 | Day 5 上午 | ⏳ 待开始 |
| 分析回测报告 | CTO | Day 5 下午 | ⏳ 待开始 |
| 更新portfolio_config.json | CTO | Day 5 下午 | ⏳ 待开始 |

**关键交付物**：
- 回测报告（3个月总收益、最大回撤、胜率、调仓次数）
- 最优参数组合
- 更新后的portfolio_config.json

**成功标准**：
- ✅ 找到最优参数（收益/回撤比最高）
- ✅ 回测报告包含所有关键指标
- ✅ portfolio_config.json更新为最优参数

---

### 3.4 Day 6: 集成测试

**目标**：将Portfolio层集成到EventDrivenMonitor

**任务清单**：

| 任务 | 负责人 | 完成时间 | 状态 |
|------|--------|----------|------|
| 集成CapitalAllocator到EventDrivenMonitor | CTO | Day 6 上午 | ⏳ 待开始 |
| 集成测试 | 测试者 | Day 6 下午 | ⏳ 待开始 |
| 性能测试 | 开发者 | Day 6 下午 | ⏳ 待开始 |

**关键交付物**：
- 集成后的EventDrivenMonitor
- 集成测试报告
- 性能测试报告

**成功标准**：
- ✅ Portfolio层与EventDrivenMonitor集成成功
- ✅ 所有集成测试通过
- ✅ 性能满足要求（响应时间<100ms）

---

### 3.5 Day 7: 实盘验证

**目标**：节后第一个交易日实盘验证

**任务清单**：

| 任务 | 负责人 | 完成时间 | 状态 |
|------|--------|----------|------|
| 实盘监控Portfolio决策 | 全员 | Day 7 全天 | ⏳ 待开始 |
| 记录每次换仓的依据和结果 | 测试者 | Day 7 全天 | ⏳ 待开始 |
| 收盘后生成每日报告 | CTO | Day 7 收盘 | ⏳ 待开始 |
| 对比回测参数是否需要调整 | CTO | Day 7 收盘 | ⏳ 待开始 |

**关键交付物**：
- 实盘决策日志
- 每日业务报告
- 参数调整建议

**成功标准**：
- ✅ 系统能实时输出持仓评分 vs 候选池评分
- ✅ 系统能自动识别"昨天断层今天普通"的情况
- ✅ 系统能根据实时优势对比做换仓决策
- ✅ 每日业务报告包含所有关键指标

---

## 4. 每日进度追踪

### 4.1 Day 1（2026-02-16）进度

**计划开始**: 2026-02-16 18:00
**计划结束**: 2026-02-16 23:59
**实际开始**: 2026-02-16 18:00
**实际结束**: 2026-02-16 18:45
**状态**: ✅ 已完成

**任务清单**：

| 任务 | 计划开始 | 计划结束 | 实际开始 | 实际结束 | 状态 | 备注 |
|------|----------|----------|----------|----------|------|------|
| 创建logic/portfolio目录结构 | 18:00 | 18:30 | 18:00 | 18:00 | ✅ 完成 | 目录已存在 |
| 创建portfolio_config.json | 18:30 | 19:00 | 18:00 | 18:00 | ✅ 完成 | 参数化配置 |
| 实现CapitalAllocator核心类 | 19:00 | 23:59 | 18:00 | 18:30 | ✅ 完成 | 核心功能完整 |
| 实现PortfolioMetrics类 | 19:00 | 23:59 | 18:30 | 18:40 | ✅ 完成 | 业务指标完整 |
| 单元测试 | 19:00 | 23:59 | 18:40 | 18:45 | ✅ 完成 | 所有测试通过 |

**关键交付物**：
- ✅ `logic/portfolio/capital_allocator.py`（核心500行）
- ✅ `logic/portfolio/portfolio_metrics.py`（业务指标）
- ✅ `config/portfolio_config.json`（参数化配置）
- ✅ `tests/test_capital_allocator.py`（单元测试）

**测试结果**：
```
✅ 测试通过: CapitalAllocator初始化
✅ 测试通过: 综合评分 (高分=0.82, 低分=0.00)
✅ 测试通过: 平仓检查（主力出逃、风险恶化、极限回撤、机会成本过高）
✅ 测试通过: 单只股票仓位分配 (90000.0元)
✅ 测试通过: 断层优势识别（单吊000001.SZ）
✅ 测试通过: 2只股票分散（000001.SZ=60000.0元, 000002.SZ=40000.0元）
✅ 测试通过: 3只股票分散（50%+30%+20%）
✅ 测试通过: Position属性（市值、浮动盈亏、收益率）
✅ 测试通过: Position平仓（T+1约束）
✅ 测试通过: 记录起爆点捕捉
✅ 测试通过: 记录调仓操作
✅ 测试通过: 记录平仓操作
✅ 测试通过: 生成每日报告
```

**备注**：
- ✅ Day 1所有任务已完成（用时45分钟）
- ✅ 所有单元测试通过
- ✅ CapitalAllocator核心功能完整：
  - 实时重新评分（不看历史标签）
  - 换仓决策（持仓 vs 候选池实时PK）
  - 动态仓位分配（1只/2只/3只）
  - T+1约束处理
- ✅ PortfolioMetrics业务指标完整：
  - 每日业务报告
  - 实时仪表盘
  - 业务指标追踪

---

### 4.2 Day 2（2026-02-17）进度

**计划开始**: 2026-02-17 09:00
**计划结束**: 2026-02-17 23:59
**状态**: ⏳ 待开始

**任务清单**：

| 任务 | 计划开始 | 计划结束 | 实际开始 | 实际结束 | 状态 | 备注 |
|------|----------|----------|----------|----------|------|------|
| 实现实时重新评分逻辑 | 09:00 | 12:00 | - | - | ⏳ 待开始 | |
| 实现换仓决策（基于实时对比） | 13:00 | 18:00 | - | - | ⏳ 待开始 | |
| 单元测试 | 19:00 | 23:59 | - | - | ⏳ 待开始 | |

**备注**：
- 必须完成Portfolio层核心代码
- 所有单元测试必须通过

---

### 4.3 Day 3-7 进度

**待更新**...

---

## 5. 风险点和检查点

### 5.1 技术风险

| 风险描述 | 可能性 | 影响程度 | 缓解措施 | 负责人 | 状态 |
|----------|--------|----------|----------|--------|------|
| Portfolio层开发时间不足 | 🔴 高 | 🔴 高 | 优先完成核心功能，延后次要功能 | CTO | ⏳ 监控中 |
| Tick数据加载失败 | 🟡 中 | 🔴 高 | 提前验证数据可用性 | 开发者 | ⏳ 监控中 |
| 参数优化时间过长 | 🟡 中 | 🟡 中 | 限制参数搜索空间 | 开发者 | ⏳ 监控中 |
| 集成测试发现严重bug | 🟡 中 | 🔴 高 | 每天进行集成测试 | 测试者 | ⏳ 监控中 |
| 实盘验证失败 | 🟡 中 | 🔴 高 | 提前进行充分测试 | 全员 | ⏳ 监控中 |

### 5.2 业务风险

| 风险描述 | 可能性 | 影响程度 | 缓解措施 | 负责人 | 状态 |
|----------|--------|----------|----------|--------|------|
| 参数优化结果不理想 | 🟡 中 | 🟡 中 | 准备多组参数备选方案 | CTO | ⏳ 监控中 |
| 实盘表现与回测差距大 | 🟡 中 | 🔴 高 | 充分考虑滑点和冲击成本 | CTO | ⏳ 监控中 |
| 换仓频率过高 | 🟡 中 | 🟡 中 | 设置最小持有天数 | CTO | ⏳ 监控中 |

### 5.3 检查点清单

**Day 2检查点**：
- [ ] Portfolio层核心代码完成
- [ ] 所有单元测试通过
- [ ] 实时重新评分逻辑正确
- [ ] 换仓决策逻辑正确

**Day 4检查点**：
- [ ] Tick级回测引擎完成
- [ ] 能加载3个月热门股Tick数据
- [ ] 参数优化功能正常
- [ ] 所有单元测试通过

**Day 6检查点**：
- [ ] Portfolio层与EventDrivenMonitor集成成功
- [ ] 所有集成测试通过
- [ ] 性能满足要求（响应时间<100ms）

**Day 7检查点**：
- [ ] 实盘验证成功
- [ ] 系统能实时输出持仓评分 vs 候选池评分
- [ ] 系统能自动识别"昨天断层今天普通"的情况
- [ ] 系统能根据实时优势对比做换仓决策
- [ ] 每日业务报告包含所有关键指标

---

## 6. 关键依赖和里程碑

### 6.1 模块依赖图

```
┌─────────────────────────────────────────────────────────────┐
│                     MyQuantTool V17.0 架构                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────┐
│  Event-Driven   │  ← 需要改造（移除30秒固定间隔）
│    Monitor      │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│   Portfolio     │  ← 新增（核心模块）
│    Manager      │
└────────┬────────┘
         │
    ┌────┴────┬─────────────┬─────────────┐
    ↓         ↓             ↓             ↓
┌───────┐ ┌───────┐   ┌──────────┐  ┌──────────┐
│Data   │ │Tick   │   │Parameter │  │Risk      │
│Provider││Backtest│   │Optimizer │  │Controller│
└───┬───┘ └───┬───┘   └──────────┘  └──────────┘
    │         │
    ↓         ↓
┌───────┐ ┌───────┐
│QMT    │ │Hot    │
│Level1 │ │Stocks │
└───┬───┘ └───┬───┘
    │         │
    └────┬────┘
         ↓
    ❌ 54个文件直接调用akshare（延后处理）
```

### 6.2 里程碑时间表

| 里程碑 | 日期 | 状态 | 备注 |
|--------|------|------|------|
| Portfolio层核心代码完成 | 2026-02-17 | ⏳ 待完成 | Day 2检查点 |
| Tick级回测引擎完成 | 2026-02-19 | ⏳ 待完成 | Day 4检查点 |
| 参数优化完成 | 2026-02-20 | ⏳ 待完成 | Day 5检查点 |
| 集成测试通过 | 2026-02-21 | ⏳ 待完成 | Day 6检查点 |
| 实盘验证成功 | 2026-02-24 | ⏳ 待完成 | Day 7检查点 |

---

## 7. 附录

### 7.1 技术架构图

见上文"6.1 模块依赖图"

### 7.2 数据流图

```
Tick数据（QMT）
    ↓
实时评分（CapitalAllocator）
    ↓
持仓评分 vs 候选池评分
    ↓
换仓决策（实时对比）
    ↓
执行交易（TradeGatekeeper）
    ↓
更新持仓（PortfolioManager）
    ↓
生成报告（PortfolioMetrics）
```

### 7.3 参考资料

- CTO深度审计报告（2026-02-16 17:50）
- 老板最终决定（2026-02-16）
- V11开发指南（11条铁律）
- 知识库V12.1.0

---

**文档维护**：
- 创建人：AI项目总监
- 最后更新：2026-02-16 18:00
- 更新频率：每日更新

**下一步行动**：
- [ ] 创建logic/portfolio目录结构
- [ ] 创建portfolio_config.json
- [ ] 开始实现CapitalAllocator核心类