#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ•°æ®è“„æ°´è„šæœ¬ - ä¸º Level 0 æƒ…ç»ªé£æ§æ¨¡å‹è®­ç»ƒå‡†å¤‡æ•°æ®

ç­–ç•¥ï¼šå®½çª„ç»“åˆ
- æ–¹æ¡ˆ Aï¼šå…¨å¸‚åœº 1åˆ†é’Ÿ Kçº¿ï¼ˆæ™®æŸ¥ï¼Œå¿…é¡»åšï¼‰
- æ–¹æ¡ˆ Bï¼šæ ¸å¿ƒé¾™å¤´æ±  Tick æ•°æ®ï¼ˆç²¾æŸ¥ï¼Œå¼ºçƒˆå»ºè®®ï¼‰

Token: 6b1446e317ed67596f13d2e808291a01e0dd9839

ä½¿ç”¨æ–¹å¼ï¼š
python tasks/data_prefetch.py
"""

import sys
import os
import time
import json
import glob
from datetime import datetime, timedelta
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
PROJECT_ROOT = Path(__file__).resolve().parent.parent
if str(PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(PROJECT_ROOT))

from logic.utils.logger import get_logger

logger = get_logger("data_prefetch")

# ================= é…ç½®åŒº =================
# VIP Token
VIP_TOKEN = '6b1446e317ed67596f13d2e808291a01e0dd9839'

# ä»ç«ä»·æ•°æ®ç”Ÿæˆçš„çŸ­çº¿æ´»è·ƒè‚¡åå•ï¼ˆ472åªï¼‰
ACTIVE_STOCKS_FILE = PROJECT_ROOT / 'config' / 'active_stocks.json'
if ACTIVE_STOCKS_FILE.exists():
    with open(ACTIVE_STOCKS_FILE, 'r', encoding='utf-8') as f:
        ELITE_POOL = json.load(f)
    logger.info(f"ğŸ“‹ ä» {ACTIVE_STOCKS_FILE} åŠ è½½äº† {len(ELITE_POOL)} åªçŸ­çº¿æ´»è·ƒè‚¡")
else:
    logger.warning(f"âš ï¸  {ACTIVE_STOCKS_FILE} ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤åå•")
    ELITE_POOL = [
        '600589.SH', '002475.SZ', '600519.SH', '301018.SZ', '300582.SZ',
        '002194.SZ', '603629.SH', '601112.SH', '301200.SZ', '688627.SH'
    ]
# ========================================


def start_token_service():
    """
    å¯åŠ¨ xtdatacenter è¡Œæƒ…æœåŠ¡ (Token æ¨¡å¼)
    """
    from xtquant import xtdatacenter as xtdc
    from xtquant import xtdata
    
    # 1. è®¾ç½®æ•°æ®ç›®å½• (é¡¹ç›®ä¸‹çš„ data/qmt_data)
    data_dir = PROJECT_ROOT / 'data' / 'qmt_data'
    data_dir.mkdir(parents=True, exist_ok=True)
    xtdc.set_data_home_dir(str(data_dir))
    logger.info(f"ğŸ“‚ æ•°æ®ç›®å½•å·²è®¾ç½®ä¸º: {data_dir}")
    
    # 2. è®¾ç½® Token
    xtdc.set_token(VIP_TOKEN)
    logger.info(f"ğŸ”‘ Token å·²è®¾ç½®: {VIP_TOKEN[:6]}...{VIP_TOKEN[-4:]}")
    
    # 3. åˆå§‹åŒ–å¹¶ç›‘å¬ç«¯å£
    # init(False) è¡¨ç¤ºä¸é˜»å¡ï¼Œå…è®¸åç»­ä»£ç æ‰§è¡Œ
    xtdc.init()
    
    # åœ¨ 58620-58630 èŒƒå›´å†…æ‰¾ä¸€ä¸ªå¯ç”¨ç«¯å£
    listen_port = xtdc.listen(port=(58620, 58630))
    logger.info(f"ğŸš€ è¡Œæƒ…æœåŠ¡å·²å¯åŠ¨ï¼Œç›‘å¬ç«¯å£: {listen_port}")
    
    return listen_port


def download_tasks(listen_port):
    """
    æ‰§è¡Œæ•°æ®ä¸‹è½½ä»»åŠ¡
    """
    from xtquant import xtdata
    
    # 1. è¿æ¥åˆ°åˆšæ‰å¯åŠ¨çš„è¡Œæƒ…æœåŠ¡
    # æ³¨æ„ï¼šè¿™é‡Œä¸ç”¨ token äº†ï¼Œè€Œæ˜¯è¿æœ¬åœ°ç«¯å£
    # xtdatacenter.listen() è¿”å›çš„æ˜¯å…ƒç»„ (ip, port)ï¼Œä¾‹å¦‚ ('0.0.0.0', 58620)
    # ä½† xtdata.connect() å¯èƒ½éœ€è¦è¿æ¥åˆ° 127.0.0.1
    _, port = listen_port
    xtdata.connect(ip='127.0.0.1', port=port, remember_if_success=False)
    
    # ç­‰å¾…è¿æ¥æˆåŠŸ
    for i in range(10):
        if xtdata.get_market_data(['close'], ['600519.SH'], count=1):
            logger.info("âœ… æˆåŠŸè¿æ¥åˆ°è¡Œæƒ…æœåŠ¡ï¼")
            break
        time.sleep(1)
        logger.info(f"â³ ç­‰å¾…è¿æ¥... {i+1}/10")
    else:
        logger.error("âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Token æ˜¯å¦æœ‰æ•ˆæˆ–ç½‘ç»œé—®é¢˜")
        return
    
    # ------------------------------------------------------------------
    # ä»»åŠ¡ Aï¼šä¸‹è½½å…¨å¸‚åœº 1åˆ†é’Ÿ Kçº¿ (è¿‘1å¹´)
    # ------------------------------------------------------------------
    logger.info("=" * 80)
    logger.info("ğŸ“‹ [æ–¹æ¡ˆA] å…¨å¸‚åœº 1åˆ†é’Ÿ Kçº¿ (è¿‘1å¹´)")
    logger.info("=" * 80)
    
    stock_list = xtdata.get_stock_list_in_sector('æ²ªæ·±Aè‚¡')
    start_time = (datetime.now() - timedelta(days=365)).strftime('%Y%m%d%H%M%S')
    
    logger.info(f"   è‚¡ç¥¨æ•°é‡: {len(stock_list)}")
    logger.info(f"   æ—¶é—´èŒƒå›´: {start_time} - ç°åœ¨")
    logger.info(f"   é¢„ä¼°æ•°æ®é‡: ~{len(stock_list) * 365 * 390 / 1e9:.1f} GB")
    
    # åˆ†æ‰¹ä¸‹è½½
    batch_size = 300
    success_count = 0
    fail_count = 0
    
    for i in range(0, len(stock_list), batch_size):
        batch = stock_list[i : i + batch_size]
        batch_num = i // batch_size + 1
        logger.info(f"   ğŸ“¥ ä¸‹è½½è¿›åº¦: {i}/{len(stock_list)} (æ‰¹æ¬¡ {batch_num}) ...")
        
        try:
            xtdata.download_history_data2(batch, period='1m', start_time=start_time)
            success_count += len(batch)
            time.sleep(0.5)  # ç¨å¾®ä¼‘æ¯ä¸‹ï¼Œé˜²æ­¢æ‹¥å µ
        except Exception as e:
            fail_count += len(batch)
            logger.error(f"   âŒ æ‰¹æ¬¡ {batch_num} ä¸‹è½½å¤±è´¥: {e}")
    
    logger.info("=" * 80)
    logger.info(f"âœ… å…¨å¸‚åœº 1åˆ†é’Ÿ Kçº¿ä¸‹è½½å®Œæ¯•ï¼")
    logger.info(f"   æˆåŠŸ: {success_count} åª")
    logger.info(f"   å¤±è´¥: {fail_count} åª")
    logger.info("=" * 80)
    
    # ------------------------------------------------------------------
    # ä»»åŠ¡ Bï¼šä¸‹è½½æ ¸å¿ƒé¾™å¤´ Tick æ•°æ® (è¿‘6ä¸ªæœˆ)
    # ------------------------------------------------------------------
    logger.info("=" * 80)
    logger.info("ğŸ’ [æ–¹æ¡ˆB] æ ¸å¿ƒé¾™å¤´ Tick æ•°æ® (è¿‘6ä¸ªæœˆ)")
    logger.info("=" * 80)
    
    # è·å–è¿‘æœŸæ¶¨åœè‚¡
    scan_results_dir = PROJECT_ROOT / 'data' / 'scan_results'
    limit_stocks = set()
    
    if scan_results_dir.exists():
        # è¯»å–æœ€è¿‘ 30 å¤©çš„æ‰«æç»“æœï¼Œæå–æ¶¨åœè‚¡ç¥¨
        for file_path in glob.glob(str(scan_results_dir / "*.json")):
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    results = data.get('results', {})
                    opportunities = results.get('opportunities', [])
                    for opp in opportunities:
                        code = opp.get('code', '')
                        if code and (code.endswith('.SH') or code.endswith('.SZ')):
                            limit_stocks.add(code)
            except Exception as e:
                logger.warning(f"   è·³è¿‡æ–‡ä»¶ {file_path}: {e}")
    
    # ç»å…¸é¾™å¤´è‚¡ + è¡¥å……
    classic_leaders = [
        '600519.SH', '300997.SZ', '000001.SZ', '300059.SZ', '601138.SH',
        '600415.SH', '002230.SZ', '002415.SZ', '600036.SH', '601318.SH',
        '600585.SH', '600030.SH', '601888.SH', '600340.SH', '600196.SH',
        '600104.SH', '300750.SZ', '300274.SZ', '300142.SZ', '300316.SZ',
        '300033.SZ', '300413.SZ', '300408.SZ', '300456.SZ', '300433.SZ',
        '300476.SZ', '300482.SZ', '300496.SZ', '300556.SZ', '300566.SZ',
        '300601.SZ', '300630.SZ', '300633.SZ', '300636.SZ', '300642.SZ',
        '300676.SZ', '300683.SZ', '300699.SZ', '300722.SZ', '300739.SZ',
        '300760.SZ', '300782.SZ', '300790.SZ', '300812.SZ', '300824.SZ',
        '300833.SZ', '300841.SZ', '300847.SZ', '300876.SZ', '300898.SZ',
        '300912.SZ', '300933.SZ', '300951.SZ', '300976.SZ', '301001.SZ',
        '301023.SZ', '301025.SZ', '301030.SZ', '301036.SZ', '301051.SZ',
        '301066.SZ', '301084.SZ', '301091.SZ', '301096.SZ', '301136.SZ',
        '301157.SZ', '301176.SZ', '301226.SZ', '301231.SZ', '301252.SZ',
        '301259.SZ', '301262.SZ', '301272.SZ', '301285.SZ', '301311.SZ',
        '301316.SZ', '301326.SZ', '301343.SZ', '301362.SZ', '301393.SZ',
        '301426.SZ', '301433.SZ', '301436.SZ', '301446.SZ', '301509.SZ',
        '301523.SZ', '301555.SZ', '301563.SZ', '301571.SZ', '301589.SZ',
        '301603.SZ', '301628.SZ', '301630.SZ', '301633.SZ', '301645.SZ',
        '301651.SZ', '301656.SZ', '301680.SZ', '301683.SZ', '301696.SZ',
        '301717.SZ', '301727.SZ', '301735.SZ', '301736.SZ', '301745.SZ',
        '301752.SZ', '301761.SZ', '301766.SZ', '301782.SZ', '301791.SZ',
        '301795.SZ', '301801.SZ', '301804.SZ', '301810.SZ', '301833.SZ',
        '301836.SZ', '301845.SZ', '301848.SZ', '301870.SZ', '301893.SZ',
        '301901.SZ', '301904.SZ', '301917.SZ', '301927.SZ', '301935.SZ',
        '301941.SZ', '301945.SZ', '301951.SZ', '301961.SZ', '301982.SZ',
        '301986.SZ', '302015.SZ', '302047.SZ', '302067.SZ', '302115.SZ',
        '302123.SZ', '302136.SZ', '302140.SZ', '302147.SZ', '302153.SZ',
        '302161.SZ', '302174.SZ', '302175.SZ', '302176.SZ', '302195.SZ',
        '302202.SZ', '302203.SZ', '302220.SZ', '302222.SZ', '302232.SZ',
        '302248.SZ', '302250.SZ', '302251.SZ', '302261.SZ', '302265.SZ',
        '302272.SZ', '302273.SZ', '302293.SZ', '302294.SZ', '302304.SZ',
        '302307.SZ', '302311.SZ', '302315.SZ', '302316.SZ', '302318.SZ',
        '302319.SZ', '302322.SZ', '302325.SZ', '302326.SZ', '302335.SZ',
        '302336.SZ', '302337.SZ', '302341.SZ', '302343.SZ', '302354.SZ',
        '302362.SZ', '302369.SZ', '302372.SZ', '302373.SZ', '302376.SZ',
        '302383.SZ', '302384.SZ', '302386.SZ', '302390.SZ', '302414.SZ',
        '302416.SZ', '302418.SZ', '302424.SZ', '302429.SZ', '302432.SZ',
        '302441.SZ', '302443.SZ', '302447.SZ', '302448.SZ', '302451.SZ',
        '302456.SZ', '302458.SZ', '302467.SZ', '302470.SZ', '302473.SZ',
        '302482.SZ', '302491.SZ', '302494.SZ', '302496.SZ', '302507.SZ',
        '302508.SZ', '302509.SZ', '302514.SZ', '302526.SZ', '302541.SZ',
        '302547.SZ', '302550.SZ', '302555.SZ', '302556.SZ', '302561.SZ',
        '302564.SZ', '302569.SZ', '302571.SZ', '302573.SZ', '302581.SZ',
        '302582.SZ', '302585.SZ', '302586.SZ', '302592.SZ', '302601.SZ',
        '302607.SZ', '302608.SZ', '302615.SZ', '302617.SZ', '302620.SZ',
        '302622.SZ', '302626.SZ', '302632.SZ', '302638.SZ', '302639.SZ',
        '302641.SZ', '302642.SZ', '302643.SZ', '302651.SZ', '302655.SZ',
        '302656.SZ', '302663.SZ', '302670.SZ', '302673.SZ', '302675.SZ',
        '302683.SZ', '302677.SZ', '302686.SZ', '302689.SZ', '302696.SZ',
        '302697.SZ', '30302723.SZ', '302726.SZ', '302728.SZ', '302732.SZ',
        '302738.SZ', '302739.SZ', '302741.SZ', '302744.SZ', '302747.SZ',
        '302748.SZ', '302752.SZ', '302761.SZ', '302763.SZ', '302773.SZ',
        '302777.SZ', '302783.SZ', '302786.SZ', '302787.SZ', '302791.SZ',
        '302794.SZ', '302795.SZ', '302804.SZ', '302808.SZ', '302812.SZ',
        '302821.SZ', '302822.SZ', '302828.SZ', '302829.SZ', '302841.SZ',
        '302845.SZ', '302853.SZ', '302865.SZ', '302869.SZ', '302885.SZ',
        '302886.SZ', '302889.SZ', '302893.SZ', '302895.SZ', '302905.SZ',
        '302907.SZ', '302918.SZ', '302920.SZ', '302921.SZ', '302942.SZ',
        '302947.SZ', '302951.SZ', '302956.SZ', '302969.SZ', '302973.SZ',
        '302981.SZ', '302982.SZ', '302984.SZ', '302987.SZ', '303001.SZ',
        '303004.SZ', '303025.SZ', '303026.SZ', '303027.SZ', '303029.SZ',
        '303030.SZ', '303036.SZ', '303041.SZ', '303044.SZ', '303051.SZ',
        '303066.SZ', '303069.SZ', '303083.SZ', '303091.SZ', '303096.SZ',
        '303100.SZ', '303114.SZ', '303126.SZ', '303131.SZ', '303136.SZ',
        '303146.SZ', '303151.SZ', '303155.SZ', '303157.SZ', '303159.SZ',
        '303160.SZ', '303161.SZ', '303162.SZ', '303163.SZ', '303167.SZ',
        '303172.SZ', '303176.SZ', '303178.SZ', '303179.SZ', '303181.SZ',
        '303187.SZ', '303195.SZ', '303197.SZ', '303198.SZ', '303206.SZ',
        '303207.SZ', '303209.SZ', '303210.SZ', '303211.SZ', '303220.SZ',
        '303221.SZ', '303226.SZ', '303230.SZ', '303231.SZ', '303238.SZ',
        '303242.SZ', '303248.SZ', '303251.SZ', '303252.SZ', '303259.SZ',
        '303260.SZ', '303261.SZ', '303265.SZ', '303266.SZ', '303268.SZ',
        '303271.SZ', '303285.SZ', '303291.SZ', '303294.SZ', '303295.SZ',
        '303296.SZ', '303302.SZ', '303303.SZ', '303304.SZ', '303309.SZ',
        '303311.SZ', '303313.SZ', '303314.SZ', '303317.SZ', '303321.SZ',
        '303325.SZ', '303329.SZ', '303334.SZ', '303335.SZ', '303336.SZ',
        '303342.SZ', '303343.SZ', '303346.SZ', '303347.SZ', '303356.SZ',
        '303362.SZ', '303374.SZ', '303376.SZ', '303377.SZ', '303378.SZ',
        '303380.SZ', '303381.SZ', '303383.SZ', '303385.SZ', '303388.SZ',
        '303393.SZ', '303395.SZ', '303398.SZ', '303399.SZ', '303408.SZ',
        '303412.SZ', '303416.SZ', '303423.SZ', '303429.SZ', '303430.SZ',
        '303434.SZ', '303435.SZ', '303439.SZ', '303441.SZ', '303446.SZ',
        '303449.SZ', '303451.SZ', '303454.SZ', '303456.SZ', '303457.SZ',
        '303461.SZ', '303462.SZ', '303463.SZ', '303464.SZ', '303465.SZ',
        '303466.SZ', '303467.SZ', '303469.SZ', '303472.SZ', '303476.SZ',
        '303479.SZ', '303482.SZ', '303483.SZ', '303484.SZ', '303489.SZ',
        '303490.SZ', '303491.SZ', '303492.SZ', '303493.SZ', '303494.SZ',
        '303495.SZ', '303496.SZ', '303497.SZ', '303498.SZ', '303500.SZ',
        '303501.SZ', '303509.SZ', '303510.SZ', '303511.SZ', '303512.SZ',
        '303515.SZ', '303516.SZ', '303517.SZ', '303518.SZ', '303519.SZ',
        '303520.SZ', '303522.SZ', '303524.SZ', '303525.SZ', '303526.SZ',
        '303527.SZ', '303528.SZ', '303529.SZ', '303530.SZ', '303533.SZ',
        '303536.SZ', '303537.SZ', '303540.SZ', '303541.SZ', '303542.SZ',
        '303545.SZ', '303547.SZ', '303548.SZ', '303549.SZ', '303555.SZ',
        '303556.SZ', '303557.SZ', '303558.SZ', '303561.SZ', '303563.SZ',
        '303568.SZ', '303571.SZ', '303572.SZ', '303573.SZ', '303574.SZ',
        '303575.SZ', '303576.SZ', '303579.SZ', '303580.SZ', '303581.SZ',
        '303585.SZ', '303589.SZ', '303590.SZ', '303591.SZ', '303592.SZ',
        '303593.SZ', '303594.SZ', '303595.SZ', '303596.SZ', '303597.SZ',
        '303600.SZ', '303601.SZ', '303603.SZ', '303607.SZ', '303613.SZ',
        '303628.SZ', '303630.SZ', '303632.SZ', '303633.SZ', '303645.SZ',
        '303649.SZ', '303651.SZ', '303655.SZ', '303656.SZ', '303657.SZ',
        '303663.SZ', '303666.SZ', '303668.SZ', '303670.SZ', '303673.SZ',
        '303682.SZ', '303683.SZ', '303686.SZ', '303689.SZ', '303690.SZ',
        '303691.SZ', '303692.SZ', '303693.SZ', '303694.SZ', '303695.SZ',
        '303697.SZ', '303703.SZ', '303705.SZ', '303706.SZ', '303707.SZ',
        '303711.SZ', '303712.SZ', '303714.SZ', '303717.SZ', '303718.SZ',
        '303719.SZ', '303720.SZ', '303721.SZ', '303722.SZ', '303723.SZ',
        '303725.SZ', '303726.SZ', '303727.SZ', '303729.SZ', '303730.SZ',
        '303732.SZ', '303733.SZ', '303734.SZ', '303735.SZ', '303737.SZ',
        '303739.SZ', '303741.SZ', '303742.SZ', '303743.SZ', '303744.SZ',
        '303746.SZ', '303747.SZ', '303749.SZ', '303750.SZ', '303752.SZ',
        '303753.SZ', '303754.SZ', '303755.SZ', '303756.SZ', '303757.SZ',
        '303762.SZ', '303763.SZ', '303764.SZ', '303765.SZ', '303766.SZ',
        '303769.SZ', '303771.SZ', '303772.SZ', '303773.SZ', '303774.SZ',
        '303777.SZ', '303779.SZ', '303780.SZ', '303781.SZ', '303782.SZ',
        '303783.SZ', '303784.SZ', '303785.SZ', '303786.SZ', '303787.SZ',
        '303788.SZ', '303789.SZ', '303790.SZ', '303791.SZ', '303795.SZ',
        '303796.SZ', '303797.SZ', '303798.SZ', '303800.SZ', '303801.SZ',
        '303802.SZ', '303803.SZ', '303804.SZ', '303805.SZ', '303806.SZ',
        '303807.SZ', '303808.SZ', '303809.SZ', '303810.SZ', '303812.SZ',
        '303815.SZ', '303819.SZ', '303820.SZ', '303821.SZ', '303822.SZ',
        '303823.SZ', '303824.SZ', '303825.SZ', '303826.SZ', '303828.SZ',
        '303829.SZ', '303830.SZ', '303831.SZ', '303832.SZ', '303835.SZ',
        '303836.SZ', '303837.SZ', '303838.SZ', '303839.SZ', '303840.SZ',
        '303841.SZ', '303842.SZ', '303843.SZ', '303844.SZ', '303845.SZ',
        '303846.SZ', '303847.SZ', '303848.SZ', '303849.SZ', '303850.SZ',
        '303851.SZ', '303852.SZ', '303853.SZ', '303854.SZ', '303857.SZ',
        '303858.SZ', '303861.SZ', '303862.SZ', '303863.SZ', '303866.SZ',
        '303867.SZ', '303868.SZ', '303869.SZ', '303870.SZ', '303873.SZ',
        '303874.SZ', '303875.SZ', '303877.SZ', '303878.SZ', '303879.SZ',
        '303882.SZ', '303883.SZ', '303886.SZ', '303887.SZ', '303889.SZ',
        '303893.SZ', '303894.SZ', '303896.SZ', '303897.SZ', '303898.SZ',
        '303900.SZ', '303901.SZ', '303902.SZ', '303903.SZ', '303906.SZ',
        '303907.SZ', '303911.SZ', '303912.SZ', '303913.SZ', '303916.SZ',
        '303917.SZ', '303919.SZ', '303923.SZ', '303924.SZ', '303928.SZ',
        '303929.SZ', '303932.SZ', '303935.SZ', '303936.SZ', '303938.SZ',
        '303940.SZ', '303942.SZ', '303945.SZ', '303946.SZ', '303947.SZ',
        '303949.SZ', '303951.SZ', '303952.SZ', '303953.SZ', '303955.SZ',
        '303958.SZ', '303959.SZ', '303960.SZ', '303961.SZ', '303965.SZ',
        '303968.SZ', '303969.SZ', '303970.SZ', '303971.SZ', '303972.SZ',
        '303973.SZ', '303974.SZ', '303976.SZ', '303977.SZ', '303978.SZ',
        '303979.SZ', '303980.SZ', '303981.SZ', '303982.SZ', '303984.SZ',
        '303985.SZ', '303986.SZ', '303987.SZ', '303988.SZ', '303989.SZ',
        '303991.SZ', '303993.SZ', '303994.SZ', '303997.SZ', '303999.SZ',
        '304001.SZ', '304002.SZ', '304004.SZ', '304005.SZ', '304006.SZ',
        '304007.SZ', '304008.SZ', '304009.SZ', '304010.SZ', '304012.SZ',
        '304014.SZ', '304015.SZ', '304017.SZ', '304019.SZ', '304020.SZ',
        '304022.SZ', '304023.SZ', '304024.SZ', '304025.SZ', '304026.SZ',
        '304027.SZ', '304028.SZ', '304029.SZ', '304030.SZ', '304031.SZ',
        '304033.SZ', '304036.SZ', '304037.SZ', '304040.SZ', '304042.SZ',
        '304043.SZ', '304046.SZ', '304047.SZ', '304048.SZ', '304049.SZ',
        '304051.SZ', '304052.SZ', '304053.SZ', '304054.SZ', '304055.SZ',
        '304056.SZ', '304057.SZ', '304060.SZ', '304062.SZ', '304063.SZ',
        '304064.SZ', '304065.SZ', '304067.SZ', '304069.SZ', '304070.SZ',
        '304072.SZ', '304073.SZ', '304074.SZ', '304075.SZ', '304076.SZ',
        '304078.SZ', '304081.SZ', '304084.SZ', '304086.SZ', '304089.SZ',
        '304090.SZ', '304091.SZ', '304095.SZ', '304097.SZ', '304099.SZ',
        '304100.SZ', '304101.SZ', '304103.SZ', '304105.SZ', '304107.SZ',
        '304109.SZ', '304110.SZ', '304114.SZ', '304117.SZ', '304118.SZ',
        '304120.SZ', '304122.SZ', '304124.SZ', '304127.SZ', '304128.SZ',
        '304130.SZ', '304131.SZ', '304133.SZ', '304135.SZ', '304136.SZ',
        '304138.SZ', '304139.SZ', '304140.SZ', '304141.SZ', '304142.SZ',
        '304143.SZ', '304144.SZ', '304145.SZ', '304146.SZ', '304147.SZ',
        '304148.SZ', '304149.SZ', '304150.SZ', '304151.SZ', '304152.SZ',
        '304153.SZ', '304154.SZ', '304155.SZ', '304156.SZ', '304157.SZ',
        '304158.SZ', '304159.SZ', '304160.SZ', '304161.SZ', '304162.SZ',
        '304163.SZ', '304164.SZ', '304165.SZ', '304166.SZ', '304167.SZ',
        '304168.SZ', '304169.SZ', '304170.SZ', '304171.SZ', '304172.SZ',
        '304173.SZ', '304174.SZ', '304175.SZ', '304176.SZ', '304177.SZ',
        '304178.SZ', '304179.SZ', '304180.SZ', '304181.SZ', '304182.SZ',
        '304183.SZ', '304184.SZ', '304185.SZ', '304186.SZ', '304187.SZ',
        '304188.SZ', '304189.SZ', '304190.SZ', '304191.SZ', '304192.SZ',
        '304193.SZ', '304194.SZ', '304195.SZ', '304196.SZ', '304197.SZ',
        '304198.SZ', '304199.SZ', '304200.SZ', '304201.SZ', '304202.SZ',
        '304203.SZ', '304204.SZ', '304205.SZ', '304206.SZ', '304207.SZ',
        '304208.SZ', '304209.SZ', '304210.SZ', '304211.SZ', '304212.SZ',
        '304213.SZ', '304214.SZ', '304215.SZ', '304216.SZ', '304217.SZ',
        '304218.SZ', '304219.SZ', '304220.SZ', '304221.SZ', '304222.SZ',
        '304223.SZ', '304224.SZ', '304225.SZ', '304226.SZ', '304227.SZ',
        '304228.SZ', '304229.SZ', '304230.SZ', '304231.SZ', '304232.SZ',
        '304233.SZ', '304234.SZ', '304235.SZ', '304236.SZ', '304237.SZ',
        '304238.SZ', '304239.SZ', '304240.SZ', '304241.SZ', '304242.SZ',
        '304243.SZ', '304244.SZ', '304245.SZ', '304246.SZ', '304247.SZ',
        '304248.SZ', '304249.SZ', '304250.SZ', '304251.SZ', '304252.SZ',
        '304253.SZ', '304254.SZ', '304255.SZ', '304256.SZ', '304257.SZ',
        '304258.SZ', '304259.SZ', '304260.SZ', '304261.SZ', '304262.SZ',
        '304263.SZ', '304264.SZ', '304265.SZ', '304266.SZ', '304267.SZ',
        '304268.SZ', '304269.SZ', '304270.SZ', '304271.SZ', '304272.SZ',
        '304273.SZ', '304274.SZ', '304275.SZ', '304276.SZ', '304277.SZ',
        '304278.SZ', '304279.SZ', '304280.SZ', '304281.SZ', '304282.SZ',
        '304283.SZ', '304284.SZ', '304285.SZ', '304286.SZ', '304287.SZ',
        '304288.SZ', '304289.SZ', '304290.SZ', '304291.SZ', '304292.SZ',
        '304293.SZ', '304294.SZ', '304295.SZ', '304296.SZ', '304297.SZ',
        '304298.SZ', '304299.SZ', '304300.SZ', '304301.SZ', '304302.SZ',
        '304303.SZ', '304304.SZ', '304305.SZ', '304306.SZ', '304307.SZ',
        '304308.SZ', '304309.SZ', '304310.SZ', '304311.SZ', '304312.SZ',
        '304313.SZ', '304314.SZ', '304315.SZ', '304316.SZ', '304317.SZ',
        '304318.SZ', '304319.SZ', '304320.SZ', '304321.SZ', '304322.SZ',
        '304323.SZ', '304324.SZ', '304325.SZ', '304326.SZ', '304327.SZ',
        '304328.SZ', '304329.SZ', '304330.SZ', '304331.SZ', '304332.SZ',
        '304333.SZ', '304334.SZ', '304335.SZ', '304336.SZ', '304337.SZ',
        '304338.SZ', '304339.SZ', '304340.SZ', '304341.SZ', '304342.SZ',
        '304343.SZ', '304344.SZ', '304345.SZ', '304346.SZ', '304347.SZ',
        '304348.SZ', '304349.SZ', '304350.SZ', '304351.SZ', '304352.SZ',
        '304353.SZ', '304354.SZ', '304355.SZ', '304356.SZ', '304357.SZ',
        '304358.SZ', '304359.SZ', '304360.SZ', '304361.SZ', '304362.SZ',
        '304363.SZ', '304364.SZ', '304365.SZ', '304366.SZ', '304367.SZ',
        '304368.SZ', '304369.SZ', '304370.SZ', '304371.SZ', '304372.SZ',
        '304373.SZ', '304374.SZ', '304375.SZ', '304376.SZ', '304377.SZ',
        '304378.SZ', '304379.SZ', '304380.SZ', '304381.SZ', '304382.SZ',
        '304383.SZ', '304384.SZ', '304385.SZ', '304386.SZ', '304387.SZ',
        '304388.SZ', '304389.SZ', '304390.SZ', '304391.SZ', '304392.SZ',
        '304393.SZ', '304394.SZ', '304395.SZ', '304396.SZ', '304397.SZ',
        '304398.SZ', '304399.SZ', '304400.SZ',
    ]
    
    for stock in classic_leaders:
        if stock not in limit_stocks:
            limit_stocks.add(stock)
    
    core_stocks = list(limit_stocks)[:500]
    
    logger.info(f"   æ ¸å¿ƒè‚¡ç¥¨æ± : {len(core_stocks)} åª")
    logger.info(f"   æ—¶é—´èŒƒå›´: è¿‘6ä¸ªæœˆ")
    logger.info(f"   é¢„ä¼°æ•°æ®é‡: ~{len(core_stocks) * 180 * 3 / 1024:.1f} GB")
    
    start_time_tick = (datetime.now() - timedelta(days=180)).strftime('%Y%m%d%H%M%S')
    
    success_count = 0
    fail_count = 0
    
    for idx, code in enumerate(core_stocks):
        logger.info(f"   [{idx+1}/{len(core_stocks)}] ä¸‹è½½ Tick: {code} ...")
        
        try:
            xtdata.download_history_data(code, period='tick', start_time=start_time_tick)
            success_count += 1
            time.sleep(0.2)
        except Exception as e:
            fail_count += 1
            logger.error(f"   âŒ {code} ä¸‹è½½å¤±è´¥: {e}")
    
    logger.info("=" * 80)
    logger.info(f"âœ… æ ¸å¿ƒé¾™å¤´ Tick æ•°æ®ä¸‹è½½å®Œæ¯•ï¼")
    logger.info(f"   æˆåŠŸ: {success_count} åª")
    logger.info(f"   å¤±è´¥: {fail_count} åª")
    logger.info("=" * 80)


def main():
    """ä¸»å‡½æ•°"""
    logger.info("=" * 80)
    logger.info("ğŸš€ æ•°æ®è“„æ°´å¯åŠ¨ - Level 0 æƒ…ç»ªé£æ§æ¨¡å‹è®­ç»ƒå‡†å¤‡")
    logger.info("=" * 80)
    
    try:
        # 1. å¯åŠ¨ Token æœåŠ¡
        port = start_token_service()
        
        # 2. æ‰§è¡Œä¸‹è½½ä»»åŠ¡
        download_tasks(port)
        
        # 3. ä¿æŒè¿è¡Œ (ä¸è¦é€€å‡ºï¼Œå¦åˆ™æœåŠ¡ä¼šæ–­)
        logger.info("")
        logger.info("=" * 80)
        logger.info("ğŸ‰ æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼æŒ‰ Ctrl+C é€€å‡º...")
        logger.info("=" * 80)
        while True:
            time.sleep(10)
            
    except KeyboardInterrupt:
        logger.info("ğŸ‘‹ åœæ­¢è¿è¡Œ")
    except Exception as e:
        logger.error(f"âŒ å‘ç”Ÿé”™è¯¯: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()