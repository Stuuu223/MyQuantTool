# 全息回演工具复用性分析

## TimeMachineEngine能力盘点

### ✅ 已有的能力
1. **Tick数据下载** - `download_tick_data()`
2. **V18评分算法** - `_calculate_morning_score()`
   - 量比计算 (volume_ratio = volume_0940 / avg_volume_5d)
   - 换手率计算
   - 双Ratio化过滤
   - 时间衰减权重 (1.2/1.0/0.8/0.5)
   - 从ConfigManager读取参数
3. **单日回测** - `run_daily_backtest()`
4. **连续回测** - `run_continuous_backtest()`

### ❌ 缺失的能力
1. **逐笔遍历** - 只取09:40快照，不是遍历所有Tick找起爆点
2. **盘中量比** - 只计算09:40的量比，不是盘中任意时刻
3. **起爆点检测** - 没有"首次突破"检测逻辑
4. **战果计算** - 没有起爆后盈亏分析
5. **战报生成** - 输出是Top20列表，不是热复盘战报

## 核心差异

| 功能 | TimeMachineEngine | 热复盘需求 |
|------|-------------------|------------|
| 时间精度 | 09:40快照 | Tick级逐笔 |
| 量比计算 | 单点计算 | 盘中动态计算 |
| 起爆检测 | ❌ 无 | ✅ 需要 |
| 战果分析 | ❌ 无 | ✅ 需要 |
| 输出格式 | Top20列表 | 战报格式 |

## 可行方案

### 方案A：扩展TimeMachineEngine（推荐）
在现有引擎上添加热复盘模式：
```python
class TimeMachineEngine:
    # 已有方法...
    
    # 新增热复盘方法
    def run_hot_replay(self, date: str) -> HotReplayReport:
        """热复盘模式 - 逐笔遍历找起爆点"""
        # 1. 复用现有数据下载
        # 2. 逐笔遍历Tick（新增）
        # 3. 调用V18算法（复用）
        # 4. 生成战报（新增）
```

**优势**:
- 复用数据下载逻辑
- 复用V18评分算法
- 复用配置读取
- 避免重复代码

**工作量**: 中等（1-2天）

### 方案B：独立新建（原方案）
完全新建TickHotReplayEngine

**优势**:
- 职责清晰
- 不受既有逻辑约束

**劣势**:
- 重复实现数据下载
- 重复实现V18算法
- 维护两份相似代码

## 总监建议

**推荐方案A：扩展TimeMachineEngine**

理由：
1. V18算法已经完整实现，直接复用
2. 配置系统已经对齐，无需重新对接
3. Tick数据下载逻辑成熟，避免踩坑
4. 只需新增"逐笔遍历+起爆检测+战果计算"

具体实施：
- 新增 `run_hot_replay()` 方法
- 新增 `_detect_explosion_points()` 逐笔遍历
- 新增 `_calculate_battle_result()` 战果计算
- 复用 `_calculate_morning_score()` 中的V18算法
