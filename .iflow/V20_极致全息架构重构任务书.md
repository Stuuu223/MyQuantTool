# V20.0 极致全息架构重构任务书

## Boss战略意图理解

### 核心诉求
1. **全息下载上下文切片**: 不只是当日Tick，而是前30天+后30天(共60天)完整生命周期
2. **宽进严出下载策略**: 粗筛不过三道防线，保留"异动基因股"(量比>0.85+换手>2%)
3. **两段式混合回测架构**: 
   - 阶段1: 向量化极速定位起爆点(毫秒级)
   - 阶段2: 事件驱动逐笔模拟(起爆后关键几十秒)
4. **微观盘口三道防线**: 利用Tick五档数据识别诱多/撤单/封单衰减
5. **极致精度追求**: 热复盘用Tick而非1分钟K线，哪怕慢也要准

### 现有问题(CTO发现)
1. **文档幽灵**: true_dictionary.py仍残留大量Tushare代码/注释
2. **截面回测造假**: TimeMachineEngine只取09:40快照，非真正逐笔
3. **静态防线**: 三道防线基于日K，无法识别微观盘口陷阱

---

## 重构Phase规划

### Phase A1: 肃清文档幽灵(Tushare残留)
**目标**: 彻底清理true_dictionary.py中的Tushare代码和注释
**文件**: `logic/data_providers/true_dictionary.py`
**动作**:
- 删除_warmup_tushare_data()方法
- 删除所有Tushare相关注释
- 保留QMT本地计算5日均量逻辑
- 更新docstring

### Phase A2: 重构全息下载器(上下文切片)
**目标**: 实现前30后30天的上下文Tick下载
**文件**: `tools/unified_downloader.py`
**新功能**:
- 新增`download_holographic_context()`方法
- 异动基因标记: 量比>0.85 && 换手>2%
- 日期范围计算: T-30到T+30(共60个交易日)
- 去重合并: 同股票多天触发合并区间
- 最新日期处理: 往前下载60天

### Phase A3: 升级三道防线(微观盘口级)
**目标**: 基于Tick五档数据的动态防线
**文件**: `logic/execution/trade_gatekeeper.py` (新建micro_defense.py)
**新防线**:
1. **诱多撤单防线**: 起爆前3秒买一托单突然撤单识别
2. **散户跟风防线**: 散碎小单vs千手大单识别
3. **封单衰减防线**: 涨停后封单1分钟内衰减50%预警

### Phase A4: 重构TimeMachineEngine(两段式混合)
**目标**: 向量化定位+事件驱动模拟
**文件**: `logic/backtest/time_machine_engine.py`
**架构**:
```python
class TimeMachineEngineV20:
    # 阶段1: 向量化极速雷达(上帝视角)
    def vectorized_detect_explosion(self, tick_df) -> ExplosionPoint:
        df['dynamic_volume_ratio'] = ...  # 向量化计算
        return df[df['volume_ratio'] > 0.95].first_valid_index()
    
    # 阶段2: 事件驱动微观模拟(散户视角)
    def event_driven_simulation(self, tick_slice, entry_idx) -> TradeResult:
        for tick in tick_slice:  # 逐笔模拟
            check_micro_defense(tick)  # 微观防线
            simulate_order_matching(tick)  # 撮合判定
```

### Phase A5: 测试验证与审计
**目标**: 真实数据验证两段式架构
**测试**:
- 向量化算法正确性
- 事件驱动模拟精度
- 微观防线有效性
- 60天下载完整性

---

## 关键算法设计

### 1. 上下文切片下载算法
```python
def calculate_download_range(trigger_dates: List[str]) -> Dict[str, Tuple[str, str]]:
    """
    计算每只股票需要下载的日期范围
    
    Returns:
        {stock_code: (start_date, end_date)}
    """
    for stock, dates in trigger_dates.items():
        min_date = min(dates) - 30个交易日
        max_date = max(dates) + 30个交易日
        # 合并重叠区间
        # 返回(start, end)
```

### 2. 向量化起爆点检测
```python
def vectorized_explosion_detect(df: pd.DataFrame) -> Optional[int]:
    """
    毫秒级向量化起爆点定位
    
    核心: 严禁for循环！
    """
    df['volume_cumsum'] = df['volume'].cumsum()
    df['time_progress'] = (df['timestamp'] - market_open).dt.seconds / (4*3600)
    df['dynamic_ratio'] = df['volume_cumsum'] / (avg_5d * df['time_progress'])
    
    # 向量化布尔索引定位
    mask = (df['dynamic_ratio'] > 0.95) & (df['turnover_per_min'] > 0.2)
    if mask.any():
        return df[mask].index[0]  # O(1)定位
    return None
```

### 3. 微观盘口防线算法
```python
class MicroDefenseSystem:
    def check_fake_support(self, tick_window: List[Tick]) -> bool:
        """诱多撤单检测"""
        # 起爆前3秒买一托单量
        pre_support = sum(t['bid1_vol'] for t in tick_window[:3])
        # 起爆瞬间买一托单量
        post_support = tick_window[3]['bid1_vol']
        # 托单撤走70%以上判定为诱多
        return (pre_support - post_support) / pre_support > 0.7
    
    def check_retail_hype(self, tick_slice: pd.DataFrame) -> bool:
        """散户跟风检测"""
        # 分析成交量分布
        small_orders = tick_slice[tick_slice['volume'] < 100]['volume'].sum()
        total_volume = tick_slice['volume'].sum()
        # 小单占比>80%判定为散户自嗨
        return small_orders / total_volume > 0.8
```

---

## 数据流重构

### 下载期(宽进)
```
全市场扫描 → 异动基因标记(量比>0.85+换手>2%) → 
上下文切片(T-30~T+30) → VIP下载Tick → 本地存储
```

### 回测期(严出)
```
加载60天Tick → 向量化定位起爆点 → 
事件驱动模拟(起爆后30秒) → 微观防线检查 → 
撮合判定(排队位置/废单概率) → 战果统计
```

---

## 性能指标

| 阶段 | 性能要求 | 技术方案 |
|------|----------|----------|
| 向量化定位 | <100ms/只 | pandas向量化 |
| 事件模拟 | 逐笔3ms | C++回调 |
| 60天下载 | <2小时/只 | VIP并发 |
| 全市场回测 | <30分钟 | 8核并行 |

---

## 验收标准

1. **零Tushare残留**: 代码/注释/文档清理干净
2. **上下文下载**: 可下载任意股票前30后30天Tick
3. **两段式回测**: 向量化定位+事件驱动模拟无缝衔接
4. **微观防线**: 能识别诱多撤单/散户跟风/封单衰减
5. **极致精度**: 回测起爆时间与实盘Tick级一致

---

任务发布: AI项目总监
战略拍板: Boss + CTO
执行团队: AI开发专家团队
