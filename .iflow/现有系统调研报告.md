# 现有回测系统深度调研报告

## 一、现有系统盘点

### 1. TimeMachineEngine (time_machine_engine.py)
**用途**: 连续多日回测
**Tick使用方式**: ❌ 只取09:40快照
```python
tick_0940 = tick_data[tick_data['time_str'] <= '09:40:00']
price_0940 = float(tick_0940.iloc[-1]['price'])  # 只取一个时间点！
```
**配置对齐**: ✅ 使用ConfigManager
**问题**: 不是逐笔遍历，无法检测起爆时刻

### 2. BehaviorReplayEngine (behavior_replay_engine.py)
**用途**: 策略回测验证
**Tick使用方式**: ✅ 逐笔遍历
```python
for tick in provider.iter_ticks():
    metrics = calc.add_tick(tick, last_tick)
    true_change = (tick['lastPrice'] - pre_close) / pre_close * 100
```
**配置对齐**: ❌ 硬编码参数
**核心功能**: 
- 资金流计算 (RollingFlowCalculator)
- 事件检测 (HALFWAY/TRUE_ATTACK/LEADER/TRAP)
- 模拟交易 (Portfolio逻辑)
- 特征提取 (维持能力)

**与热复盘的区别**:
1. 用于策略回测，不是每日复盘
2. 关注资金流，不计算量比
3. 模拟交易盈亏，不是生成战报
4. 使用不同的数据服务层

---

## 二、关键差异分析

| 维度 | BehaviorReplayEngine | 热复盘系统 (新需求) |
|------|---------------------|-------------------|
| **目的** | 策略历史回测 | 每日收盘复盘 |
| **扫描范围** | 指定股票列表 | 全市场5191只 |
| **核心算法** | 资金流+事件检测 | 量比+V18评分 |
| **时间精度** | Tick级 | Tick级 |
| **输出** | 交易记录+统计 | 起爆点战报 |
| **配置来源** | 硬编码 | ConfigManager |
| **V18评分** | ❌ 无 | ✅ 有 |
| **盘中量比** | ❌ 无 | ✅ 有 |

---

## 三、结论

### 是否必须新建文件？
**答案: 是，但有复用空间**

**必须新建的原因**:
1. **目标不同**: 回测 vs 复盘
2. **算法不同**: 资金流 vs 量比+V18
3. **输出不同**: 交易记录 vs 起爆点战报
4. **扫描范围不同**: 指定列表 vs 全市场

**可以复用的组件**:
1. Tick数据加载逻辑 (借鉴)
2. DataFrame处理模式
3. 多进程并行方案

### 建议方案
**改造而非完全新建**:
```
方案A: 完全新建 (工作量大，重复代码)
方案B: 扩展BehaviorReplayEngine (耦合度高)
方案C: 提取公共基类 + 新建热复盘引擎 (推荐)
```

**推荐方案C**:
1. 提取 `TickDataLoader` 公共组件
2. 新建 `TickHotReplayEngine` 专注热复盘
3. 复用并行处理框架
