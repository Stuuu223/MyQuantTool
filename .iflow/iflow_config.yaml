# iFlow CLI V20.0 - AI-Nativeç»ˆæå¼€å‘å½¢æ€é…ç½®
# æ­¤æ–‡ä»¶å®šä¹‰iFlow CLIä¼šè¯å¯åŠ¨æ—¶çš„è¡Œä¸ºä¸é»‘ç§‘æŠ€ç‰¹æ€§
# 
# è§’è‰²åˆ†å·¥é“¾:
#   Boss(æˆ˜ç•¥å®šè°ƒ) â†’ CTO(æ¶æ„å®¡è®¡) â†’ iFlow(AIé¡¹ç›®æ€»ç›‘) â†’ Sub-Agents(å¼€å‘ä¸“å®¶)
#
# ç‰ˆæœ¬: V20.0 - æè‡´å…¨æ¯æ¶æ„ç‰ˆ
# æ›´æ–°: 2026-02-26
#
# =============================================================================
# CTOé“è¡€å››å¾‹ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰
# =============================================================================
# ã€é“å¾‹ä¸€ï¼šé˜…åå³ç„šã€‘è¿‡ç¨‹æ–‡æ¡£è‡ªåŠ¨åŒ–æ¸…ç†
#   - æ‰€æœ‰æ€è€ƒ/åˆ†æ/æ¨æ¼”æ€§è´¨çš„ä¸­é—´æ–‡æ¡£ï¼ˆPhase_*.md, è°ƒç ”æŠ¥å‘Š.mdç­‰ï¼‰æ ‡è®°ä¸ºã€é˜…åå³ç„šã€‘
#   - å½“Phaseå¼€å‘ã€æµ‹è¯•å¹¶Commitå®Œæ¯•åï¼Œå¿…é¡»ç‰©ç†åˆ é™¤è¯¥Phaseäº§ç”Ÿçš„æ‰€æœ‰è¿‡ç¨‹æ–‡æ¡£
#   - ä»“åº“é‡Œç»å¯¹ä¸å‡†ç•™ä¸‹ä»»ä½•è‰ç¨¿çº¸
#
# ã€é“å¾‹äºŒï¼šæ–‡æ¡£å³ä»£ç ã€‘Doc-as-Codeå¼ºåˆ¶åŒæ­¥
#   - ä»£ç é‡æ„å¦‚æœæ²¡æœ‰ä½“ç°åˆ°ä¸»æ–‡æ¡£ä¸­ï¼Œè§†ä¸ºä»»åŠ¡æœªå®Œæˆ
#   - æ¯æ¬¡æäº¤æ ¸å¿ƒåŠŸèƒ½å‰ï¼Œå¿…é¡»æ‰§è¡Œã€æ–‡æ¡£å¯¹é½å®¡æŸ¥ã€‘
#   - å¼ºåˆ¶æ›´æ–°: SYSTEM_CONSTITUTION.md, TRADING_PHILOSOPHY.md, README.md
#
# ã€é“å¾‹ä¸‰ï¼šä¸¥ç¦ç”©é”…ã€‘ç¦æ­¢åºŸè¯è¯·ç¤º
#   - CTOå’ŒBosså·²ç¡®å®šçš„æ¶æ„å‚æ•°ï¼ˆ0.90é™ç»´ã€60å¤©ä¸Šä¸‹æ–‡ã€3.0%æ¢æ‰‹ï¼‰ç«‹å³æ‰§è¡Œ
#   - ä¸å‡†å†å‘èµ·æ‰€è°“çš„"å‚æ•°ç¡®è®¤"ï¼Œä¸å‡†æŠ›å‡º0.92ç­‰é­”æ³•æ•°å­—è®©è€æ¿åšé€‰æ‹©é¢˜
#
# ã€é“å¾‹å››ï¼šè®°å¿†æ”¶æ•›ã€‘ç»Ÿä¸€JSONæº
#   - æ‰€æœ‰çŠ¶æ€è¿›åº¦ã€å½“å‰æ‰€å¤„é˜¶æ®µï¼Œç»Ÿä¸€ä¸”å”¯ä¸€åœ°å†™å…¥ShortTermMemory.json
#   - ä¸¥ç¦åœ¨å¤–é¢ä¹±å»ºMarkdownè®°å½•è¿›åº¦
# =============================================================================

# =============================================================================
# é»‘ç§‘æŠ€1: è®°å¿†é’©å­(Memory Hooks) - æ²»æ„ˆAIå¤±å¿†ç—‡
# =============================================================================
memory_persistence:
  enabled: true
  short_term_memory: data/memory/ShortTermMemory.json
  auto_save_on_phase_complete: true
  
  # æ¯æ¬¡ä¼šè¯å¯åŠ¨æ—¶å¼ºåˆ¶åŠ è½½çš„å…³é”®è®°å¿†
  bootstrap_memories:
    - key: architecture_version
      value: "V20.0 - æè‡´å…¨æ¯æ¶æ„"
      echo: true  # å¯åŠ¨æ—¶é«˜äº®æ˜¾ç¤º
      
    - key: data_source_policy
      value: "100% QMTæœ¬åœ°æ¶æ„ï¼ŒTushareå·²ç‰©ç†æ­»äº¡"
      echo: true
      
    - key: zero_magic_number_rule
      value: "ä¸¥ç¦ç¡¬ç¼–ç ï¼æ‰€æœ‰é˜ˆå€¼å¿…é¡»ä»ConfigManagerè¯»å–live_sniperé…ç½®"
      echo: true
      
    - key: holographic_architecture
      value: "ä¸¤æ®µå¼: Pandaså‘é‡åŒ–ç§’å®šä½ + Tickçº§äº‹ä»¶é©±åŠ¨å¾®è§‚æ¨¡æ‹Ÿ"
      echo: true
      
    - key: current_phase
      value: "Phase A2-A4: å…¨æ¯ä¸‹è½½å™¨+å¾®è§‚é˜²çº¿+å›æµ‹å¼•æ“"
      echo: true

  # é˜¶æ®µå®Œæˆæ—¶è‡ªåŠ¨è®°å½•
  phase_completion_hooks:
    - trigger: phase_complete
      action: append_to_memory
      fields:
        - timestamp
        - phase_name
        - key_decisions
        - next_phase_ready

# =============================================================================
# é»‘ç§‘æŠ€2: è‡ªæ„ˆæ–­è¨€(Self-Healing Assertions) - çº¢çº¿å¼ºåˆ¶æ‹¦æˆª
# =============================================================================
redline_hooks:
  enabled: true
  audit_script: .iflow/audit_rules.py
  
  # ä»£ç æäº¤å‰å¼ºåˆ¶æ£€æŸ¥
  pre_commit_checks:
    - name: magic_number_scan
      description: "æ‰«æé­”æ³•æ•°å­—ç¡¬ç¼–ç "
      pattern: "(?<![a-zA-Z_])(0\.8[0-9]|0\.9[0-9]|3\.0|5\.0)(?![0-9])"
      forbidden_contexts:
        - "volume_ratio"
        - "turnover"
        - "change_pct"
        - "threshold"
      severity: error
      auto_reject: true
      message: "æ£€æµ‹åˆ°é­”æ³•æ•°å­—ç¡¬ç¼–ç ï¼å¿…é¡»ä»ConfigManagerè¯»å–é…ç½®"
      
    - name: tushare_residue_scan
      description: "æ‰«æTushareæ®‹ç•™"
      pattern: "(?i)(tushare|ts\.pro_api|daily_basic|ts_code)"
      severity: error
      auto_reject: true
      message: "æ£€æµ‹åˆ°Tushareæ®‹ç•™ï¼å¿…é¡»ä½¿ç”¨QMTæœ¬åœ°æ•°æ®"
      
    - name: hardcoded_path_scan
      description: "æ‰«æç¡¬ç¼–ç è·¯å¾„"
      pattern: "[C-Z]:\\\\[^\"'\s]+|/home/[^\"'\s]+|/Users/[^\"'\s]+"
      allowed_paths:
        - "__file__"
        - "PathResolver"
        - "get_root"
      severity: warning
      message: "æ£€æµ‹åˆ°å¯ç–‘ç¡¬ç¼–ç è·¯å¾„ï¼Œè¯·ä½¿ç”¨PathResolver"
      
    - name: for_loop_tick_scan
      description: "æ‰«æTické€è¡Œéå†"
      pattern: "for.*tick.*in.*ticks|for.*row.*in.*df\."
      allowed_contexts:
        - "event_driven_simulation"
        - "micro_defense_check"
      severity: error
      auto_reject: true
      message: "ä¸¥ç¦Forå¾ªç¯éå†Tickæ•°æ®ï¼å¿…é¡»ä½¿ç”¨Pandaså‘é‡åŒ–"
      
    - name: config_manager_check
      description: "éªŒè¯ConfigManagerä½¿ç”¨"
      required_patterns:
        - "get_config_manager"
        - "config\.get"
      forbidden_patterns:
        - "volume_ratio.*=.*0\.[0-9]+"
        - "turnover.*=.*[0-9]+\.[0-9]+"
      severity: error
      message: "å¿…é¡»ä½¿ç”¨ConfigManagerè¯»å–é…ç½®ï¼Œä¸¥ç¦ç¡¬ç¼–ç é˜ˆå€¼"

# =============================================================================
# é»‘ç§‘æŠ€3: Agentè§’è‰²æ‰®æ¼”æ²™ç›’(Multi-Persona Sandboxing)
# =============================================================================
expert_routing:
  enabled: true
  default_agent: general_coder
  
  # ä¸“å®¶Agentå®šä¹‰
  expert_agents:
    - name: quant_strategist
      description: "é‡åŒ–ç­–ç•¥ä¸“å®¶ - è´Ÿè´£V18ç®—æ³•ã€å‘é‡åŒ–è®¡ç®—ã€æ—¶é—´è¡°å‡"
      triggers:
        - tags: ["strategy", "v18", "vectorization", "scoring"]
        - keywords: ["volume_ratio", "time_decay", "momentum", "breakout"]
      system_prompt: |
        ä½ æ˜¯é¡¶çº§é‡åŒ–ç­–ç•¥ç ”ç©¶å‘˜ï¼Œä¸“ç²¾çŸ­çº¿å³ä¾§èµ·çˆ†æˆ˜æ³•ã€‚
        æ ¸å¿ƒèƒ½åŠ›ï¼š
        1. Pandaså‘é‡åŒ–è®¡ç®—ï¼ˆä¸¥ç¦Forå¾ªç¯éå†Tickï¼‰
        2. V18åŒRatioç®—æ³•å®ç°ï¼ˆé‡æ¯”+æ¢æ‰‹ç‡æ—¶é—´è¡°å‡ï¼‰
        3. åŠ¨æ€åˆ†ä½æ•°é˜ˆå€¼è®¡ç®—
        4. å¾®è§‚ç›˜å£ç‰¹å¾è¯†åˆ«
        
        é“å¾‹ï¼š
        - æ‰€æœ‰é˜ˆå€¼ä»ConfigManagerè¯»å–
        - é›¶ç¡¬ç¼–ç ï¼Œé›¶Magic Number
        - å¿…é¡»ç”¨cumsum/applyç­‰å‘é‡åŒ–æ“ä½œ
        
    - name: data_engineer
      description: "æ•°æ®å·¥ç¨‹å¸ˆ - è´Ÿè´£ä¸‹è½½å™¨ã€æ•°æ®ç®¡é“ã€QMTæ¥å£"
      triggers:
        - tags: ["data", "downloader", "qmt", "tick"]
        - keywords: ["download", "get_local_data", "xtdata", "holographic"]
      system_prompt: |
        ä½ æ˜¯é‡åŒ–æ•°æ®å·¥ç¨‹å¸ˆï¼Œä¸“ç²¾é«˜é¢‘æ•°æ®ç®¡é“å»ºè®¾ã€‚
        æ ¸å¿ƒèƒ½åŠ›ï¼š
        1. QMTæœ¬åœ°æ•°æ®æ¥å£ä¼˜åŒ–
        2. å¤§è§„æ¨¡Tickæ•°æ®ä¸‹è½½ä¸ç®¡ç†
        3. æ—¥æœŸåŒºé—´è®¡ç®—ä¸å»é‡
        4. å·®é›†ä¸‹è½½ç®—æ³•ï¼ˆé¿å…é‡å¤I/Oï¼‰
        
        é“å¾‹ï¼š
        - 100% QMTæœ¬åœ°ï¼Œé›¶Tushare
        - å¿…é¡»ç»´æŠ¤ä¸‹è½½æ³¨å†Œè¡¨é¿å…é‡å¤
        - ä¸Šä¸‹æ–‡åˆ‡ç‰‡ï¼šå‰30å30å¤©
        
    - name: microstructure_specialist
      description: "å¾®è§‚ç»“æ„ä¸“å®¶ - è´Ÿè´£ç›˜å£é˜²çº¿ã€è¯±å¤šæ£€æµ‹ã€æ’®åˆæ¨¡æ‹Ÿ"
      triggers:
        - tags: ["microstructure", "defense", "orderbook", "trap"]
        - keywords: ["bid1", "ask1", "fake_support", "order_withdraw"]
      system_prompt: |
        ä½ æ˜¯å¸‚åœºå¾®è§‚ç»“æ„ä¸“å®¶ï¼Œä¸“ç²¾ç›˜å£è¯­è¨€è§£è¯»ã€‚
        æ ¸å¿ƒèƒ½åŠ›ï¼š
        1. ä¹°å–äº”æ¡£æ•°æ®åˆ†æ
        2. è¯±å¤šè¯±ç©ºé™·é˜±è¯†åˆ«
        3. å¤§å•å°å•è¡Œä¸ºåŒºåˆ†
        4. å°å•è¡°å‡ç›‘æµ‹
        
        é“å¾‹ï¼š
        - ä½¿ç”¨æ»‘åŠ¨çª—å£ï¼ˆ15ç§’=5ä¸ªTickï¼‰è€Œéå›ºå®šç‚¹
        - æ£€æµ‹æ–­å´–å¼å˜åŒ–ï¼ˆ>70%ï¼‰è€Œéç»å¯¹å€¼
        - ç»“åˆä»·æ ¼è¡Œä¸ºç»¼åˆåˆ¤å®š
        
    - name: backtest_architect
      description: "å›æµ‹æ¶æ„å¸ˆ - è´Ÿè´£ä¸¤æ®µå¼å¼•æ“ã€äº‹ä»¶é©±åŠ¨ã€æ’®åˆæ¨¡æ‹Ÿ"
      triggers:
        - tags: ["backtest", "replay", "simulation", "time_machine"]
        - keywords: ["vectorized", "event_driven", "tick_replay", "match_engine"]
      system_prompt: |
        ä½ æ˜¯å›æµ‹ç³»ç»Ÿæ¶æ„å¸ˆï¼Œä¸“ç²¾é«˜é¢‘äº¤æ˜“å›æµ‹å¼•æ“ã€‚
        æ ¸å¿ƒèƒ½åŠ›ï¼š
        1. ä¸¤æ®µå¼æ··åˆæ¶æ„ï¼ˆå‘é‡åŒ–+äº‹ä»¶é©±åŠ¨ï¼‰
        2. é€ç¬”æ’®åˆæ¨¡æ‹Ÿ
        3. æ»‘ç‚¹ä¸æ’é˜Ÿä½ç½®è®¡ç®—
        4. åºŸå•ä¸æˆäº¤æ¦‚ç‡æ¨¡æ‹Ÿ
        
        é“å¾‹ï¼š
        - é˜¶æ®µ1: Pandaså‘é‡åŒ–O(n)å®šä½èµ·çˆ†ç‚¹
        - é˜¶æ®µ2: äº‹ä»¶é©±åŠ¨é€ç¬”æ¨¡æ‹Ÿï¼ˆä»…é™èµ·çˆ†å30ç§’ï¼‰
        - ä¸¥ç¦å…¨å±€Forå¾ªç¯éå†4800ä¸ªTick
        
    - name: code_auditor
      description: "ä»£ç å®¡è®¡å‘˜ - è´Ÿè´£é™æ€æ£€æŸ¥ã€è§„èŒƒéªŒè¯ã€çº¢çº¿æ‰«æ"
      triggers:
        - tags: ["audit", "review", "check", "validate"]
        - action: pre_commit
      system_prompt: |
        ä½ æ˜¯ä»£ç å®¡è®¡ä¸“å®¶ï¼Œä¸“ç²¾é‡åŒ–ä»£ç è´¨é‡æ§åˆ¶ã€‚
        æ ¸å¿ƒèƒ½åŠ›ï¼š
        1. é™æ€ä»£ç åˆ†æ
        2. æ¶æ„è§„èŒƒéªŒè¯
        3. çº¢çº¿è§„åˆ™æ‰«æ
        4. æ€§èƒ½ç“¶é¢ˆè¯†åˆ«
        
        é“å¾‹ï¼š
        - é›¶å®½å®¹ï¼šMagic Numberç›´æ¥æ‰“å›
        - é›¶å®½å®¹ï¼šTushareæ®‹ç•™ç›´æ¥æ‰“å›
        - é›¶å®½å®¹ï¼šç¡¬ç¼–ç è·¯å¾„è­¦å‘Š
        - å¿…é¡»éªŒè¯ï¼šConfigManagerè¯»å–ã€å‘é‡åŒ–å®ç°

  # è·¯ç”±å†³ç­–æ ‘
  routing_rules:
    - condition: "tags contains 'strategy' or 'v18'"
      target: quant_strategist
      
    - condition: "tags contains 'data' or 'download'"
      target: data_engineer
      
    - condition: "tags contains 'microstructure' or 'defense' or 'bid1'"
      target: microstructure_specialist
      
    - condition: "tags contains 'backtest' or 'replay' or 'simulation'"
      target: backtest_architect
      
    - condition: "action == 'pre_commit' or tags contains 'audit'"
      target: code_auditor

# =============================================================================
# é»‘ç§‘æŠ€4: é›¶äººå·¥å¹²é¢„å¤œé—´åŸºå»º(Nightly Cron Jobs)
# =============================================================================
nightly_tasks:
  enabled: true
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
  log_dir: logs/nightly
  
  tasks:
    - name: daily_k_completeness_check
      description: "æ—¥Kå®Œæ•´æ€§å·¡æ£€"
      script: tools/check_daily_k_completeness.py
      action_if_missing: auto_download
      notify_on_error: true
      
    - name: holographic_download_queue
      description: "å…¨æ¯Tickæ•°æ®ä¸‹è½½é˜Ÿåˆ—"
      script: tools/unified_downloader.py
      args: ["--type", "holographic", "--context", "30"]
      only_if: "market_closed and data_incomplete"
      max_runtime: 3600  # æœ€å¤šè·‘1å°æ—¶
      
    - name: data_integrity_audit
      description: "æ•°æ®å®Œæ•´æ€§å®¡è®¡"
      script: .iflow/audit_data_integrity.py
      generate_report: true
      report_path: data/audit/nightly_audit_YYYYMMDD.json
      
    - name: memory_compaction
      description: "å†…å­˜ä¸ç¼“å­˜å‹ç¼©"
      script: tools/compact_memory_cache.py
      vacuum_old_data: true
      keep_days: 90

  # å·¡æ£€æŠ¥å‘Šç”Ÿæˆ
  morning_report:
    enabled: true
    generate_at: "08:00"
    format: markdown
    include:
      - task_completion_status
      - data_completeness_rate
      - error_summary
      - recommendations
    delivery: terminal_echo  # å¯åŠ¨æ—¶æ˜¾ç¤º

# =============================================================================
# å¿…è¯»æ–‡æ¡£ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
# =============================================================================
required_docs:
  - path: .iflow/DEVELOPMENT_PARADIGM.md
    priority: 1
    description: "å¼€å‘èŒƒå¼ - è§’è‰²åˆ†å·¥ä¸æµç¨‹è§„èŒƒ"
    required: true
    
  - path: SYSTEM_CONSTITUTION.md
    priority: 2
    description: "ç³»ç»Ÿå®ªæ³• - ç»å¯¹é“å¾‹ä¸çº¢çº¿"
    required: true
    
  - path: data/memory/ShortTermMemory.json
    priority: 3
    description: "çŸ­æœŸè®°å¿† - å½“å‰é˜¶æ®µå…³é”®å†³ç­–"
    required: true
    auto_reload: true  # ä¼šè¯ä¸­è‡ªåŠ¨é‡è½½

# =============================================================================
# æ ¸å¿ƒè§„åˆ™æ‘˜è¦ï¼ˆå¯åŠ¨æ—¶æ˜¾ç¤ºï¼‰
# =============================================================================
startup_rules:
  - "ğŸ¯ è§’è‰²é“¾: Bosså®šæˆ˜ç•¥ â†’ CTOå®šæ¶æ„ â†’ iFlowæ‹†ä»»åŠ¡ â†’ AIå†™ä»£ç "
  - "ğŸ“‹ æµæ°´çº¿: éœ€æ±‚å¡ â†’ è®¾è®¡å¡ â†’ å®ç°+è‡ªæµ‹ â†’ çº¢çº¿å®¡è®¡ â†’ CTOå®¡è®¡"
  - "ğŸš« ç»å¯¹çº¢çº¿: é›¶Tushare | é›¶ç¡¬ç¼–ç  | é›¶Forå¾ªç¯éå†Tick"
  - "âš¡ ä¸¤æ®µå¼: å‘é‡åŒ–O(n)å®šä½ + äº‹ä»¶é©±åŠ¨å¾®è§‚æ¨¡æ‹Ÿ"
  - "ğŸ§  è®°å¿†é”šå®š: V20æ¶æ„ | QMTæœ¬åœ° | Configé©±åŠ¨ | å‰å30å¤©ä¸Šä¸‹æ–‡"

# =============================================================================
# ç¦æ­¢è¡Œä¸ºï¼ˆå¯åŠ¨æ—¶è­¦å‘Š+è¿è¡Œæ—¶æ‹¦æˆªï¼‰
# =============================================================================
prohibited_actions:
  - action: use_tushare
    severity: fatal
    message: "Tushareå·²ç‰©ç†æ­»äº¡ï¼å¿…é¡»ä½¿ç”¨QMTæœ¬åœ°æ•°æ®"
    
  - action: hardcode_threshold
    severity: fatal
    message: "ä¸¥ç¦é­”æ³•æ•°å­—ï¼å¿…é¡»ä»ConfigManagerè¯»å–live_sniperé…ç½®"
    
  - action: for_loop_tick_iteration
    severity: fatal
    message: "ä¸¥ç¦Forå¾ªç¯éå†Tickï¼å¿…é¡»ä½¿ç”¨Pandaså‘é‡åŒ–(cumsum/apply)"
    
  - action: modify_core_without_design_card
    severity: error
    message: "ä¿®æ”¹coreæŠ½è±¡å¿…é¡»å…ˆæœ‰CTOæ‰¹å‡†çš„è®¾è®¡å¡"
    
  - action: skip_self_test
    severity: error
    message: "ä¸¥ç¦è·³è¿‡è‡ªæµ‹ï¼å¿…é¡»æä¾›çœŸå®æ•°æ®éªŒè¯æŠ¥å‘Š"
    
  - action: bypass_icapitalflowprovider
    severity: error
    message: "ä¸¥ç¦ç»•è¿‡ICapitalFlowProviderç›´æ¥è°ƒç”¨QMT/AkShare"

# =============================================================================
# é¡¹ç›®è·¯å¾„é…ç½®
# =============================================================================
project_paths:
  root: MyQuantTool
  core_logic: logic/
  config: config/
  data: data/
  docs: docs/
  tasks: tasks/
  tools: tools/
  memory: data/memory/
  audit: .iflow/

# =============================================================================
# Pythonç¯å¢ƒé…ç½®
# =============================================================================
python:
  venv_path: venv_qmt
  executable: venv_qmt/Scripts/python.exe
  version: "3.10"
  required_packages:
    - xtquant
    - pandas>=1.5.0
    - numpy>=1.21.0
    - click>=8.0.0
    - rich>=12.0.0

# =============================================================================
# å½“å‰é˜¶æ®µçŠ¶æ€ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
# =============================================================================
current_phase:
  version: "V20.0"
  name: "æè‡´å…¨æ¯æ¶æ„"
  status: "Phase A2-A4å¹¶è¡Œå¼€å‘"
  completed:
    - "Phase A1: è‚ƒæ¸…Tushareæ–‡æ¡£å¹½çµ âœ“"
    - "iFlowé»‘ç§‘æŠ€å‡çº§: AI-Nativeç»ˆæå½¢æ€ âœ“"
  in_progress:
    - "Phase A2: å…¨æ¯ä¸‹è½½å™¨(ä¸Šä¸‹æ–‡åˆ‡ç‰‡)"
    - "Phase A3: å¾®è§‚ç›˜å£ä¸‰é“é˜²çº¿"
    - "Phase A4: ä¸¤æ®µå¼æ··åˆå›æµ‹å¼•æ“"
  key_decisions:
    - "é‡æ¯”: å®ç›˜0.95 â†’ ä¸‹è½½0.90 (é™ç»´0.05)"
    - "æ¢æ‰‹: ç›´æ¥ä½¿ç”¨min_active_turnover_rate(3.0%)"
    - "ä»·æ ¼: high > pre_close (åªè¦æœ€é«˜ä»·çº¢è¿‡)"
    - "ä¸Šä¸‹æ–‡: å‰30å30å¤©(å…±60ä¸ªäº¤æ˜“æ—¥)"
    - "æ—¥K: å…¨å¸‚åœºè‡ªåŠ¨è¡¥å…¨"
    - "Tick: æ¯å¤©100-150åªé¶å‘ä¸‹è½½"

# =============================================================================
# CTOé“è¡€å››å¾‹ - å·¥ä½œæµå¼ºåˆ¶æ‰§è¡Œ
# =============================================================================
workflow_constraints:
  # ã€é“å¾‹ä¸€ï¼šé˜…åå³ç„šã€‘è¿‡ç¨‹æ–‡æ¡£è‡ªåŠ¨åŒ–æ¸…ç†
  burn_after_reading:
    enabled: true
    description: "è¿‡ç¨‹æ–‡æ¡£é˜…åå³ç„šï¼Œä¸å‡†ç•™è‰ç¨¿çº¸"
    ephemeral_patterns:
      - "PHASE*.md"
      - "*ä»»åŠ¡ä¹¦.md"
      - "*è°ƒç ”æŠ¥å‘Š*.md"
      - "*åˆ†æ*.md"
      - "*ç¡®è®¤ä¸æ‰§è¡Œè®¡åˆ’*.md"
    auto_cleanup_trigger: "phase_complete"
    cleanup_command: "git rm {file} && git commit -m 'é˜…åå³ç„š: æ¸…ç†å·²å®ŒæˆPhaseçš„è¿‡ç¨‹æ–‡æ¡£'"
    exceptions:
      - "DEVELOPMENT_PARADIGM.md"
      - "V20_æè‡´å…¨æ¯æ¶æ„é‡æ„ä»»åŠ¡ä¹¦.md"  # å½“å‰è¿›è¡Œä¸­çš„æ€»çº²ä¿ç•™
    
  # ã€é“å¾‹äºŒï¼šæ–‡æ¡£å³ä»£ç ã€‘Doc-as-Codeå¼ºåˆ¶åŒæ­¥
  doc_as_code:
    enabled: true
    description: "ä»£ç é‡æ„å¿…é¡»åŒæ­¥åˆ°ä¸»æ–‡æ¡£ï¼Œå¦åˆ™ä»»åŠ¡æœªå®Œæˆ"
    required_docs_sync:
      - file: "SYSTEM_CONSTITUTION.md"
        required_sections:
          - "æ•°æ®æ¶æ„"
          - "ä¸‹è½½ç­–ç•¥"
          - "çº¢çº¿è§„èŒƒ"
        auto_check: true
        
      - file: "TRADING_PHILOSOPHY.md"
        required_sections:
          - "å³ä¾§èµ·çˆ†å“²å­¦"
          - "V18ç®—æ³•"
        auto_check: true
        
      - file: "README.md"
        required_sections:
          - "å¿«é€Ÿå¼€å§‹"
          - "æ¶æ„æ¦‚è§ˆ"
          - "ä½¿ç”¨è¯´æ˜"
        auto_check: true
        
    sync_validation:
      pre_commit_hook: true
      check_keywords:
        - "V20"
        - "å…¨æ¯"
        - "ä¸¤æ®µå¼"
        - "é™ç»´ä¸‹è½½"
      fail_if_missing: true
      
  # ã€é“å¾‹ä¸‰ï¼šä¸¥ç¦ç”©é”…ã€‘ç¦æ­¢åºŸè¯è¯·ç¤º
  no_buck_passing:
    enabled: true
    description: "å·²ç¡®å®šå‚æ•°ç«‹å³æ‰§è¡Œï¼Œç¦æ­¢è®©è€æ¿åšé€‰æ‹©é¢˜"
    frozen_parameters:
      - name: "volume_ratio_download"
        value: "live_sniper.volume_ratio_percentile - 0.05"
        source: "CTOæ¶æ„å†³ç­–"
        allow_questions: false
        
      - name: "turnover_rate"
        value: "live_sniper.min_active_turnover_rate"
        source: "ç›´æ¥ä½¿ç”¨å®ç›˜é…ç½®"
        allow_questions: false
        
      - name: "price_condition"
        value: "high > pre_close"
        source: "CTOæ¶æ„å†³ç­–"
        allow_questions: false
        
      - name: "context_days"
        value: "60"
        source: "å‰30å30å¤©"
        allow_questions: false
        
    prohibited_actions:
      - "æŠ›å‡ºå¤‡é€‰å‚æ•°è®©è€æ¿é€‰æ‹©(å¦‚'0.90è¿˜æ˜¯0.92?')"
      - "é‡å¤è¯·ç¤ºå·²ç¡®å®šçš„æ¶æ„å‚æ•°"
      - "ç”¨ç–‘é—®å¥æ›¿ä»£æ‰§è¡Œ(å¦‚'æ˜¯å¦åˆé€‚?')"
      
    enforcement:
      auto_reject_question_patterns:
        - ".*æ˜¯å¦åˆé€‚.*"
        - ".*ç¡®è®¤.*"
        - ".*è¿˜æ˜¯.*"
      severity: error
      
  # ã€é“å¾‹å››ï¼šè®°å¿†æ”¶æ•›ã€‘ç»Ÿä¸€JSONæº
  memory_convergence:
    enabled: true
    description: "æ‰€æœ‰çŠ¶æ€ç»Ÿä¸€å†™å…¥ShortTermMemory.jsonï¼Œä¸¥ç¦ä¹±å»ºMarkdown"
    single_source_of_truth: "data/memory/ShortTermMemory.json"
    
    prohibited:
      - "åœ¨.iflow/å¤–åˆ›å»º*è¿›åº¦*.md"
      - "åœ¨docs/åˆ›å»º*ä¸´æ—¶*.md"
      - "åœ¨æ ¹ç›®å½•åˆ›å»º*è®¡åˆ’*.md"
      
    required_fields:
      - "version"
      - "current_phase"
      - "completed_phases"
      - "key_decisions"
      - "active_constraints"
      
    auto_sync:
      on_phase_complete: true
      on_commit: true
      
    validation:
      check_duplication: true
      fail_if_multiple_sources: true

# =============================================================================
# å·¥ä½œæµæ‰§è¡Œæ£€æŸ¥æ¸…å•ï¼ˆæ¯ä¸ªPhaseç»“æŸæ—¶è‡ªæ£€ï¼‰
# =============================================================================
phase_completion_checklist:
  - item: "ä»£ç åŠŸèƒ½å®Œæ•´å¹¶é€šè¿‡æµ‹è¯•"
    required: true
    
  - item: "é˜…åå³ç„šï¼šæ¸…ç†è¯¥Phaseçš„è¿‡ç¨‹æ–‡æ¡£"
    required: true
    command: "python .iflow/cleanup_ephemeral_docs.py --phase {phase_name}"
    
  - item: "æ–‡æ¡£å³ä»£ç ï¼šæ›´æ–°SYSTEM_CONSTITUTION.md"
    required: true
    validator: "python .iflow/validate_doc_sync.py --file SYSTEM_CONSTITUTION.md"
    
  - item: "æ–‡æ¡£å³ä»£ç ï¼šæ›´æ–°TRADING_PHILOSOPHY.md"
    required: true
    validator: "python .iflow/validate_doc_sync.py --file TRADING_PHILOSOPHY.md"
    
  - item: "æ–‡æ¡£å³ä»£ç ï¼šæ›´æ–°README.md"
    required: false
    validator: "python .iflow/validate_doc_sync.py --file README.md"
    
  - item: "è®°å¿†æ”¶æ•›ï¼šæ›´æ–°ShortTermMemory.json"
    required: true
    command: "python .iflow/update_memory.py --phase {phase_name} --status completed"
    
  - item: "çº¢çº¿å®¡è®¡ï¼šé€šè¿‡audit_rules.pyæ£€æŸ¥"
    required: true
    command: "python .iflow/audit_rules.py --path logic/ --json"
    fail_on_error: true
    
  - item: "Gitæäº¤ï¼šåŒ…å«ä»£ç +æ–‡æ¡£+è®°å¿†æ›´æ–°"
    required: true
    commit_message_template: "V20.0 {phase_name}: {brief_description}\n\n- åŠŸèƒ½å®ç°: {details}\n- æ–‡æ¡£åŒæ­¥: SYSTEM_CONSTITUTION.mdç­‰\n- é˜…åå³ç„š: æ¸…ç†è¿‡ç¨‹æ–‡æ¡£\n- è®°å¿†æ”¶æ•›: ShortTermMemory.json"