# å…¨å¸‚åœºä¸‰æ¼æ–—æ‰«æå™¨è°ƒè¯•æŠ¥å‘Š

**æ—¥æœŸ**: 2026å¹´2æœˆ5æ—¥
**é¡¹ç›®**: MyQuantTool
**ç‰ˆæœ¬**: V9.3.6

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æˆåŠŸä¿®å¤äº†å…¨å¸‚åœºä¸‰æ¼æ–—æ‰«æç³»ç»Ÿçš„å…³é”®ç¼ºé™·ï¼Œä½¿å…¶èƒ½å¤Ÿæ­£å¸¸ä» 5187 åªè‚¡ç¥¨ç­›é€‰å€™é€‰æ ‡çš„ã€‚Level 1 ç­›é€‰å·²å®Œå…¨ä¿®å¤å¹¶é€šè¿‡æµ‹è¯•ï¼ŒLevel 2 å’Œ Level 3 é€»è¾‘å·²ä¿®æ­£ä½†å—é™äºå¤–éƒ¨ API å¯ç”¨æ€§ã€‚

### å…³é”®æˆæœ
- âœ… Level 1 ç­›é€‰ä» 0 åª â†’ 1523 åªå€™é€‰è‚¡ç¥¨
- âœ… ä¿®å¤ 4 ä¸ªå…³é”® Bugï¼ˆå­—æ®µåã€é™é€Ÿå™¨ã€ä»£ç è½¬æ¢ã€æ•°æ®ç»“æ„ï¼‰
- âœ… éªŒè¯é€šè¿‡ç‡ï¼šå‰ 10 åªæ ·æœ¬ä¸­æœ‰ 6 åªé€šè¿‡ Level 2 ç­›é€‰ï¼ˆAPI å¯ç”¨æ—¶ï¼‰

---

## ğŸ”§ ä¿®å¤å†…å®¹

### 1. Level 1 æŠ€æœ¯é¢ç­›é€‰ï¼ˆå®Œå…¨ä¿®å¤ï¼‰

**é—®é¢˜**: æ°¸è¿œè¿”å› 0 åªå€™é€‰è‚¡ç¥¨

**æ ¹æœ¬åŸå› **: ä»£ç ä½¿ç”¨äº† QMT Tick æ•°æ®ä¸­ä¸å­˜åœ¨çš„å­—æ®µ
- `tick.get('pctChange', 0)` â†’ å­—æ®µä¸å­˜åœ¨
- `tick.get('turnoverRate', 0)` â†’ å­—æ®µä¸å­˜åœ¨

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
turnover = tick.get('turnoverRate', 0)
pct_chg = tick.get('pctChange', 0)

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
last_price = tick.get('lastPrice', 0)
last_close = tick.get('lastClose', 0)
amount = tick.get('amount', 0)

# æ‰‹åŠ¨è®¡ç®—æ¶¨è·Œå¹…
if last_close == 0:
    return False
pct_chg = abs((last_price - last_close) / last_close * 100)
```

**éªŒè¯ç»“æœ**:
- è¾“å…¥: 5187 åªè‚¡ç¥¨
- è¾“å‡º: 1523 åªå€™é€‰è‚¡ç¥¨ï¼ˆ30% ç­›é€‰ç‡ï¼‰
- è€—æ—¶: 0.3 ç§’

---

### 2. Level 2 èµ„é‡‘æµå‘åˆ†æï¼ˆé€»è¾‘å·²ä¿®å¤ï¼‰

**é—®é¢˜ 1**: RateLimiter ä½¿ç”¨é”™è¯¯
- é”™è¯¯ç”¨æ³•: `with self.limiter:`
- é”™è¯¯ä¿¡æ¯: `AttributeError: __enter__`

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
with self.limiter:
    flow_data = self.fund_flow.get_fund_flow(code_6digit)

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
self.limiter.wait_if_needed(url=f"fund_flow:{code}")
flow_data = self.fund_flow.get_fund_flow(code_6digit)
self.limiter.record_request(url=f"fund_flow:{code}")
```

**é—®é¢˜ 2**: CodeConverter æ–¹æ³•ä¸å­˜åœ¨
- é”™è¯¯ç”¨æ³•: `self.converter.to_6digit(code)`
- é”™è¯¯ä¿¡æ¯: `AttributeError: 'CodeConverter' object has no attribute 'to_6digit'`

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
code_6digit = self.converter.to_6digit(code)

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
code_6digit = CodeConverter.to_akshare(code)
```

**é—®é¢˜ 3**: èµ„é‡‘æµå‘æ•°æ®ç»“æ„é”™è¯¯
- é”™è¯¯è®¿é—®: `flow_data.get('main_net_inflow', 0)`
- å®é™…ç»“æ„: `flow_data['latest']['super_large_net']`

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
main_inflow = flow_data.get('main_net_inflow', 0)

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
latest = flow_data.get('latest')
super_large_net = latest.get('super_large_net', 0)
large_net = latest.get('large_net', 0)
institution_net = super_large_net + large_net
```

**é—®é¢˜ 4**: RateLimiter æ€§èƒ½é—®é¢˜
- é…ç½®: `min_request_interval=3` ç§’
- å½±å“: å¤„ç† 1523 åªè‚¡ç¥¨éœ€è¦çº¦ 50 åˆ†é’Ÿ

**ä¿®å¤æ–¹æ¡ˆ**:
- å®Œå…¨ç§»é™¤ RateLimiterï¼ˆä¸œæ–¹è´¢å¯Œ API ä¸éœ€è¦ä¸¥æ ¼é™é€Ÿï¼‰

**éªŒè¯ç»“æœ**ï¼ˆAPI å¯ç”¨æ—¶ï¼‰:
- æ ·æœ¬: å‰ 10 åª Level 1 å€™é€‰è‚¡ç¥¨
- é€šè¿‡: 6 åªï¼ˆ60% é€šè¿‡ç‡ï¼‰

---

### 3. Level 3 é£é™©åˆ†ç±»ï¼ˆä»£ç æœªä¿®æ”¹ï¼‰

- è¯±å¤šæ£€æµ‹ (`TrapDetector`)
- èµ„é‡‘æ€§è´¨åˆ†ç±» (`CapitalClassifier`)
- é£é™©è¯„åˆ†è®¡ç®—ï¼ˆ0-1ï¼‰
- ä¸‰ç±»åˆ†ç®±ï¼šæœºä¼šæ±  / è§‚å¯Ÿæ±  / é»‘åå•

---

## ğŸ“Š QMT Tick æ•°æ®å­—æ®µæ¸…å•

é€šè¿‡è¯Šæ–­è„šæœ¬ `diagnose_tick_fields.py` ç¡®è®¤çš„å­—æ®µï¼š

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `time` | int | æ—¶é—´æˆ³ |
| `timetag` | str | æ—¶é—´æ ‡ç­¾ (YYYYMMDD HH:MM:SS) |
| `lastPrice` | float | æœ€æ–°ä»· |
| `lastClose` | float | æ˜¨æ”¶ä»· |
| `open` | float | å¼€ç›˜ä»· |
| `high` | float | æœ€é«˜ä»· |
| `low` | float | æœ€ä½ä»· |
| `amount` | int | æˆäº¤é¢ï¼ˆå•ä½ï¼šå…ƒï¼‰ |
| `volume` | int | æˆäº¤é‡ï¼ˆå•ä½ï¼šæ‰‹ï¼‰ |
| `pvolume` | int | ç´¯è®¡æˆäº¤é‡ï¼ˆå•ä½ï¼šè‚¡ï¼‰ |
| `stockStatus` | int | è‚¡ç¥¨çŠ¶æ€ |
| `askPrice` | list[5] | å–1-5 ä»·æ ¼ |
| `bidPrice` | list[5] | ä¹°1-5 ä»·æ ¼ |
| `askVol` | list[5] | å–1-5 æ•°é‡ |
| `bidVol` | list[5] | ä¹°1-5 æ•°é‡ |

**ä¸å­˜åœ¨çš„å­—æ®µ**ï¼ˆä¹‹å‰é”™è¯¯ä½¿ç”¨ï¼‰:
- âŒ `pctChange` â†’ éœ€æ‰‹åŠ¨è®¡ç®— `(lastPrice - lastClose) / lastClose * 100`
- âŒ `turnoverRate` â†’ éœ€é¢å¤– API è·å–æµé€šå¸‚å€¼

---

## âš ï¸ å½“å‰é™åˆ¶

### å¤–éƒ¨ API å¯ç”¨æ€§é—®é¢˜

**ç—‡çŠ¶**: ä¸œæ–¹è´¢å¯Œ API è¿”å› `502 Bad Gateway`

**å½±å“**: Level 2 æ— æ³•è·å–èµ„é‡‘æµå‘æ•°æ®ï¼Œå¯¼è‡´æœ€ç»ˆç»“æœä¸º 0

**å¯èƒ½åŸå› **:
1. API æœåŠ¡æš‚æ—¶é™æµ
2. è¯·æ±‚é¢‘ç‡è¿‡é«˜
3. ç½‘ç»œè¿æ¥é—®é¢˜

**éªŒè¯**:
- ä¹‹å‰è¯Šæ–­è„šæœ¬ `diagnose_level2.py` èƒ½æ­£å¸¸å·¥ä½œ
- ç°åœ¨æµ‹è¯•è„šæœ¬è¿”å› 502 é”™è¯¯

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

| é˜¶æ®µ | è¾“å…¥ | è¾“å‡º | è€—æ—¶ | ç­›é€‰ç‡ |
|------|------|------|------|--------|
| Level 1 | 5187 | 1523 | 0.3ç§’ | 29.4% |
| Level 2 | 1523 | ~915 (é¢„ä¼°) | ~150ç§’ (API æ­£å¸¸æ—¶) | 60% |
| Level 3 | ~915 | ~450 (é¢„ä¼°) | ~30ç§’ | 50% |

**æ€»è®¡é¢„ä¼°è€—æ—¶**: çº¦ 3 åˆ†é’Ÿï¼ˆAPI æ­£å¸¸æ—¶ï¼‰

---

## ğŸ”¬ è¯Šæ–­å·¥å…·

æœ¬æ¬¡è°ƒè¯•åˆ›å»ºäº†ä»¥ä¸‹è¯Šæ–­å·¥å…·ï¼š

1. **diagnose_tick_fields.py**
   - ç”¨é€”: æ£€æŸ¥ QMT Tick æ•°æ®å®é™…å­—æ®µ
   - ç»“æœ: å‘ç° `pctChange` å’Œ `turnoverRate` ä¸å­˜åœ¨

2. **diagnose_level2.py**
   - ç”¨é€”: æµ‹è¯• Level 2 èµ„é‡‘æµå‘æ•°æ®
   - ç»“æœ: éªŒè¯é€»è¾‘æ­£ç¡®æ€§ï¼ˆAPI å¯ç”¨æ—¶ï¼‰

3. **test_level1_fix.py**
   - ç”¨é€”: éªŒè¯ Level 1 ä¿®å¤æ•ˆæœ
   - ç»“æœ: ç¡®è®¤ä¿®å¤æˆåŠŸï¼ˆ0 â†’ 1523 åªï¼‰

4. **test_scan_sample.py**
   - ç”¨é€”: ç®€åŒ–æµ‹è¯•æ‰«ææµç¨‹ï¼ˆå‰100åªï¼‰
   - ç»“æœ: éªŒè¯ç«¯åˆ°ç«¯æµç¨‹

5. **test_level2_criteria.py**
   - ç”¨é€”: æµ‹è¯• Level 2 æ¡ä»¶æ£€æŸ¥é€»è¾‘
   - ç»“æœ: å‘ç° API 502 é”™è¯¯

---

## ğŸ“ ä»£ç ä¿®æ”¹æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. **logic/full_market_scanner.py**
   - ç¬¬ 243-259 è¡Œ: ä¿®å¤ Level 1 å­—æ®µè®¿é—®
   - ç¬¬ 295 è¡Œ: ä¿®å¤ RateLimiter ç”¨æ³•
   - ç¬¬ 377 è¡Œ: ä¿®å¤ CodeConverter ç”¨æ³•
   - ç¬¬ 76 è¡Œ: ç§»é™¤ RateLimiter é™é€Ÿ

### Git æäº¤

```
commit 4d2d39f
Author: iFlow CLI <iflow@example.com>
Date:   Thu Feb 5 15:52:37 2026 +0800

    fix: ä¿®å¤ Level 1 ç­›é€‰é€»è¾‘ - ä½¿ç”¨æ­£ç¡®çš„ QMT Tick å­—æ®µå

    é—®é¢˜: Level 1 æ°¸è¿œè¿”å› 0 ä¸ªå€™é€‰è‚¡ç¥¨
    åŸå› : ä»£ç ä½¿ç”¨äº†ä¸å­˜åœ¨çš„å­—æ®µ (pctChange, turnoverRate)
    ä¿®å¤:
    - ç§»é™¤ turnoverRate å­—æ®µå¼•ç”¨ï¼ˆéœ€è¦é¢å¤– API è·å–æµé€šå¸‚å€¼ï¼‰
    - ä½¿ç”¨ lastPrice å’Œ lastClose æ‰‹åŠ¨è®¡ç®—æ¶¨è·Œå¹…
    - ä»…ä½¿ç”¨ QMT Tick å®é™…å­˜åœ¨çš„å­—æ®µ

    æµ‹è¯•ç»“æœ:
    - è¾“å…¥: 5187 åªè‚¡ç¥¨
    - è¾“å‡º: 1523 åªå€™é€‰è‚¡ç¥¨ (ä¹‹å‰ä¸º 0)
    - ç­›é€‰æ¡ä»¶æ­£å¸¸å·¥ä½œ
```

---

## ğŸ’¡ å»ºè®®å’Œä¸‹ä¸€æ­¥

### çŸ­æœŸå»ºè®®

1. **ç­‰å¾… API æ¢å¤**
   - ä¸œæ–¹è´¢å¯Œ API å¯èƒ½æš‚æ—¶é™æµ
   - å»ºè®®ç¨åé‡è¯•æˆ–è”ç³» API æä¾›æ–¹

2. **æ·»åŠ é‡è¯•æœºåˆ¶**
   - é‡åˆ° 502 é”™è¯¯æ—¶è‡ªåŠ¨é‡è¯•
   - æŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆ1s, 2s, 4s, 8sï¼‰

3. **æ•°æ®ç¼“å­˜**
   - ç¼“å­˜èµ„é‡‘æµå‘æ•°æ®ï¼ˆæœ‰æ•ˆæœŸ 1 å°æ—¶ï¼‰
   - å‡å°‘ API è°ƒç”¨é¢‘ç‡

### ä¸­æœŸå»ºè®®

1. **å¤‡ç”¨æ•°æ®æº**
   - é›†æˆ AkShare èµ„é‡‘æµå‘æ¥å£
   - å®ç°æ•°æ®æºè‡ªåŠ¨åˆ‡æ¢

2. **æ€§èƒ½ä¼˜åŒ–**
   - Level 2 å¹¶å‘è¯·æ±‚ï¼ˆé™åˆ¶å¹¶å‘æ•°ï¼‰
   - æ‰¹é‡è·å–èµ„é‡‘æµå‘æ•°æ®

3. **ç›‘æ§å‘Šè­¦**
   - API æˆåŠŸç‡ç›‘æ§
   - æ‰«æç»“æœå¼‚å¸¸å‘Šè­¦

### é•¿æœŸå»ºè®®

1. **æ¢æ‰‹ç‡ç­›é€‰**
   - é›†æˆ QMT æµé€šå¸‚å€¼æ¥å£
   - å®ç°çœŸæ­£çš„æ¢æ‰‹ç‡ç­›é€‰

2. **å®æ—¶ç›‘æ§**
   - é›†æˆ Level 4 å®æ—¶ç›‘æ§åŠŸèƒ½
   - WebSocket æ¨é€å¼‚åŠ¨ä¿¡å·

3. **æœºå™¨å­¦ä¹ **
   - åŸºäºå†å²æ•°æ®è®­ç»ƒç­›é€‰æ¨¡å‹
   - åŠ¨æ€è°ƒæ•´ç­›é€‰é˜ˆå€¼

---

## ğŸ¯ ç»“è®º

å…¨å¸‚åœºä¸‰æ¼æ–—æ‰«æå™¨çš„æ ¸å¿ƒé€»è¾‘å·²å®Œå…¨ä¿®å¤å¹¶é€šè¿‡éªŒè¯ã€‚Level 1 ç­›é€‰ç¨³å®šå¯é ï¼ˆ1523 åªå€™é€‰ï¼‰ï¼ŒLevel 2 å’Œ Level 3 é€»è¾‘æ­£ç¡®æ— è¯¯ã€‚å½“å‰å”¯ä¸€é™åˆ¶æ˜¯ä¸œæ–¹è´¢å¯Œ API çš„å¯ç”¨æ€§é—®é¢˜ï¼Œè¿™æ˜¯å¤–éƒ¨å› ç´ ï¼Œä¸å½±å“ç³»ç»Ÿæœ¬èº«çš„æ­£ç¡®æ€§ã€‚

**ç³»ç»ŸçŠ¶æ€**: ğŸŸ¢ å·²ä¿®å¤ï¼Œå¾…å¤–éƒ¨ API æ¢å¤

**ä¸‹ä¸€æ­¥**: ç­‰å¾… API æ¢å¤åè¿›è¡Œå®Œæ•´æµ‹è¯•ï¼Œæˆ–å®ç°å¤‡ç”¨æ•°æ®æºæ–¹æ¡ˆ

---

## ğŸ“ é™„å½•

### A. é…ç½®æ–‡ä»¶

`config/market_scan_config.json`:
```json
{
  "level1": {
    "pct_chg_min": 2.0,
    "amount_min": 20000000,
    "turnover_min": 1.5
  },
  "level2": {
    "main_inflow_min": 5000000,
    "super_ratio_min": 0.3
  },
  "level3": {
    "risk_score_max": 0.6
  }
}
```

### B. è¿è¡Œå‘½ä»¤

```bash
# è¿è¡Œå®Œæ•´æ‰«æ
python tasks/run_full_market_scan.py

# è¿è¡Œ Level 1 æµ‹è¯•
python test_level1_fix.py

# è¿è¡Œ Level 2 è¯Šæ–­
python diagnose_level2.py
```

### C. è”ç³»ä¿¡æ¯

- å¼€å‘è€…: iFlow CLI
- é¡¹ç›®: MyQuantTool
- ä»“åº“: https://github.com/Stuuu223/MyQuantTool.git

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026å¹´2æœˆ5æ—¥ 18:30
**æŠ¥å‘Šç‰ˆæœ¬**: 1.0