# 顽主杯小程序抓包教程（Charles）

## 一、安装 Charles

### Mac
```bash
# 官网下载：https://www.charlesproxy.com/download/
# 或者使用 Homebrew
brew install --cask charles
```

### Windows
```
官网下载安装包：https://www.charlesproxy.com/download/
```

## 二、配置 Charles

### 1. 安装证书（必须）

**Mac:**
- Help → SSL Proxying → Install Charles Root Certificate
- 钥匙串中找到 "Charles Proxy CA" → 双击 → 信任 → 始终信任

**Windows:**
- Help → SSL Proxying → Install Charles Root Certificate
- 安装到 "受信任的根证书颁发机构"

### 2. 开启 SSL 代理
- Proxy → SSL Proxying Settings
- 勾选 "Enable SSL Proxying"
- 点击 Add，填入：
  - Host: `*`
  - Port: `443`
- 点击 OK

## 三、手机配置（关键步骤）

### 1. 查看 Charles 代理地址
- Help → Local IP Address
- 记下 IP（如：192.168.1.100）和端口（默认 8888）

### 2. 手机连接同一 WiFi
- 确保手机和电脑在同一个 WiFi 网络

### 3. 手机设置代理
**iPhone:**
- 设置 → WiFi → 点击当前WiFi右边的 ⓘ
- 配置代理 → 手动
- 服务器：Charles的IP（如 192.168.1.100）
- 端口：8888
- 保存

**Android:**
- 设置 → WLAN → 长按当前WiFi → 修改网络
- 高级选项 → 代理 → 手动
- 服务器：Charles的IP
- 端口：8888
- 保存

### 4. 手机安装证书（必须，否则看不到HTTPS内容）
**iPhone:**
- Safari 访问：`chls.pro/ssl`
- 下载证书 → 设置 → 通用 → VPN与设备管理 → 安装
- 设置 → 通用 → 关于本机 → 证书信任设置 → 开启 Charles Proxy CA

**Android:**
- 浏览器访问：`chls.pro/ssl`
- 下载证书 → 设置 → 安全 → 从存储安装 → 选择下载的证书

## 四、抓包顽主杯小程序

### 1. 清空 Charles
- 点击扫帚图标清空列表

### 2. 打开微信小程序
- 微信搜索 "顽主杯"
- 进入小程序，点击 "排行榜" 或 "榜单"

### 3. 在 Charles 中找接口
- 看左侧列表，找包含以下关键词的请求：
  - `wanzhu`
  - `rank`
  - `list`
  - `api`
  - `hunan`

- 重点关注：
  - 类型：GET 请求
  - 返回：JSON 格式数据
  - 内容：包含股票代码、名称、排名等信息

### 4. 查看请求详情
- 点击找到的请求
- 右侧看几个标签：
  - **Overview**: 基本信息
  - **Request**: 请求头、参数
  - **Response**: 返回数据（JSON）

## 五、导出需要的信息

找到正确的接口后，记录以下内容：

### 1. URL（完整地址）
```
例如：https://api.hunanwanzhu.com/miniprogram/rankings
```

### 2. 请求方法
```
GET 或 POST
```

### 3. 请求头（Headers）
```
点击 Request → Headers，复制所有内容
特别是：
- User-Agent
- Authorization（如果有）
- Cookie（如果有）
- Referer
```

### 4. 请求参数（Query String / Form Data）
```
例如：
- date=20260218
- page=1
- size=200
- token=xxx
```

### 5. 返回数据结构
```json
{
  "list": [
    {
      "stockCode": "000001",
      "stockName": "平安银行",
      "rank": 1,
      ...
    }
  ]
}
```

## 六、验证抓包结果

### 1. 在 Charles 里重放请求
- 右键点击请求 → Repeat
- 看是否能再次获取数据

### 2. 用 curl 测试（Mac/Linux终端）
```bash
# 把抓到的信息填入
curl "https://api.xxx.com/rankings?date=20260218&page=1" \
  -H "User-Agent: xxx" \
  -H "Authorization: xxx"
```

## 七、常见问题

### Q1: 手机连不上代理？
- 检查手机和电脑是否在同一WiFi
- 检查防火墙是否关闭（或允许Charles通过）
- 检查IP地址是否正确

### Q2: HTTPS显示乱码/加密？
- 证书没装好，重新安装并信任
- SSL Proxying 没开启

### Q3: 小程序打不开？
- 部分小程序有防代理机制
- 尝试关闭 Charles 再打开小程序，再开启 Charles

### Q4: 找不到接口？
- 清空列表后，多点击小程序的不同页面
- 关注返回数据量大的请求
- 看 Response 内容是否有股票代码

## 八、抓包成功后

把以下信息发给我，我帮你生成配置文件：

1. **完整 URL**（包含域名和路径）
2. **所有 Headers**（特别是 User-Agent、Authorization 等）
3. **所有参数**（date、page、size 等）
4. **返回数据示例**（JSON格式）

或者直接截图 Charles 的 Request 和 Response 界面。
