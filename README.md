# MyQuantTool - å³ä¾§æç«¯æ¢æ‰‹èµ·çˆ†æ—¶é—´æœºå™¨

**ç‰ˆæœ¬**: V18.0.0 (Phase 13 æœ€ç»ˆæ‰“ç£¨ç‰ˆ)  
**æ ¸å¿ƒå®šä½**: Aè‚¡å³ä¾§æç«¯æ¢æ‰‹èµ·çˆ†ç‚¹ + æ¨ªå‘èµ„é‡‘å¸è¡€PK  
**æ•°æ®æº**: QMT Tick (Level-1) + Tushare  
**æ¶æ„**: å”¯ä¸€äº‹å®æ¥æº + å¸¸è¯†æŠ¤æ  + ç»Ÿä¸€CLIå…¥å£ + ç¯å¢ƒéš”ç¦»

---

## ğŸ¯ å››å¤§åŸºçŸ³ (CTOæœ€ç»ˆå®¡è®¡)

1. **ç¯å¢ƒéš”ç¦»**: æ•æ„Ÿé…ç½®(.env)ä¸ä»£ç åˆ†ç¦»ï¼ŒTokenä¸ä¸ŠGit
2. **ç®—å­æ”¶å£**: æ‰€æœ‰æ ¸å¿ƒç®—å­åœ¨`logic/core/`ï¼Œç¦æ­¢åˆ†æ•£
3. **è·¨æ—¥è®°å¿†**: ShortTermMemoryç»§æ‰¿ï¼Œ9æ—¥è¿è´¯æµéªŒè¯
4. **VWAPæƒ©ç½š**: è·Œç ´å‡ä»·çº¿-20åˆ†ï¼Œfinal_scoreæ°¸ä¸ä¸º0

---

## âš¡ ç³»ç»Ÿå®ªæ³• (8æ¡é“å¾‹)

1. **çœŸå®æ¶¨è·Œå¹…**: å¿…é¡»åŸºäº `pre_close` è®¡ç®—ï¼Œç¦æ­¢ç”¨ `open`
2. **é›¶ç¡¬ç¼–ç è·¯å¾„**: æ‰€æœ‰è·¯å¾„é€šè¿‡ `PathResolver` è§£æ
3. **é›¶é­”æ³•æ•°å­—**: æ‰€æœ‰æŒ‡æ ‡å¿…é¡»æ˜¾å¼å®šä¹‰åœ¨ `MetricDefinitions`
4. **Fail Fast**: å¼‚å¸¸ç«‹å³æŠ›ï¼Œç¦æ­¢é™é»˜åæ²¡
5. **æ¥å£éš”ç¦»**: ä¸šåŠ¡å±‚ä¸¥ç¦ç›´æ¥å¯¼å…¥ `xtdata`
6. **æµé€šå¸‚å€¼å•ä½**: QMTè¿”å› sharesï¼Œæ— éœ€å†ä¹˜10000
7. **æˆäº¤é‡å•ä½**: æ‰‹â†’è‚¡å¿…é¡»æ˜¾å¼è½¬æ¢ (Ã—100)
8. **ç»Ÿä¸€CLIå…¥å£**: æ‰€æœ‰æ“ä½œå¿…é¡»é€šè¿‡ `main.py`

---

## ğŸ§  æ ¸å¿ƒæ¶æ„ (Phase 9.2 çº¯å‡€æ ¸å¿ƒ)

### å”¯ä¸€äº‹å®æ¥æº (SSOT)
```
logic/core/
â”œâ”€â”€ metric_definitions.py   # å…¨çƒåº¦é‡å®šä¹‰
â”œâ”€â”€ path_resolver.py        # è·¯å¾„è§£æå™¨
â”œâ”€â”€ sanity_guards.py        # æ•°æ®éªŒè¯æŠ¤æ 
â””â”€â”€ version.py              # ç‰ˆæœ¬æ§åˆ¶
```

### ä¸‰æ¼æ–—ç²—ç­› (å…¨å¸‚åœº5000â†’çº¦500)
```
ç¬¬ä¸€å±‚: é™æ€è¿‡æ»¤ (ST/é€€å¸‚/åŒ—äº¤æ‰€)
ç¬¬äºŒå±‚: é‡‘é¢è¿‡æ»¤ (5æ—¥æˆäº¤é¢ > 3000ä¸‡)
ç¬¬ä¸‰å±‚: é‡æ¯”è¿‡æ»¤ (é‡æ¯” > 3.0)
```

### V18 éªŒé’æœº (ä¸‰å±‚é˜²çº¿)
```
ç¬¬ä¸€å±‚: é«˜åˆ†è¾¨ç‡åŸºç¡€åˆ† (çº¿æ€§æå€¼æ˜ å°„ 0-100åˆ†)
ç¬¬äºŒå±‚: æ¨ªå‘å¸è¡€ä¹˜æ•° (èµ„é‡‘å‡€æµå…¥å æ¯”æ’å)
ç¬¬ä¸‰å±‚: VWAPæƒ©ç½šæ‰£åˆ† (è·Œç ´å‡ä»·çº¿-20åˆ†)
```

---

## ğŸš€ æç®€ä½¿ç”¨æŒ‡å—

### 1. ç¯å¢ƒé…ç½® (é¦–æ¬¡è¿è¡Œ)
```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
copy .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥Tushare Token
TUSHARE_TOKEN=your_token_here
```

### 2. å…¨æ¯æ—¶é—´æœºå™¨ (æ ¸å¿ƒåŠŸèƒ½ - è·¨æ—¥è¿è´¯æµ)
```bash
# 12æœˆ24æ—¥è‡³1æœˆ5æ—¥è·¨æ—¥å›æµ‹ (CTOå¼ºåˆ¶: Top 20æ¢¯åº¦è§‚å¯Ÿ)
python main.py backtest --start_date 20251224 --end_date 20260105 --full_market --strategy v18 --save

# è¾“å‡º: data/backtest_out/time_machine/time_machine_YYYYMMDD.json (æ¯æ—¥Top 20)
#       data/backtest_out/time_machine/time_machine_summary_*.json (æ±‡æ€»æŠ¥å‘Š)
```

### 3. å•æ—¥éªŒè¯
```bash
# å•æ—¥å›æµ‹ (ç²—ç­› + ä¸‰é˜²çº¿)
python main.py backtest --date 20251231 --full_market --strategy v18
```

### 4. å®ç›˜ç›‘æ§
```bash
# å¯åŠ¨å®æ—¶ç›‘æ§ç³»ç»Ÿ
python main.py monitor
```

---

## ğŸ“‚ é¡¹ç›®æ¶æ„

```
MyQuantTool/
â”œâ”€â”€ main.py                     # ğŸ¯ å”¯ä¸€CLIå…¥å£
â”œâ”€â”€ SYSTEM_CONSTITUTION.md      # ğŸ“œ ç³»ç»Ÿå®ªæ³•
â”‚
â”œâ”€â”€ logic/                      # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ core/                   # å”¯ä¸€äº‹å®æ¥æº (SSOT)
â”‚   â”‚   â”œâ”€â”€ metric_definitions.py
â”‚   â”‚   â”œâ”€â”€ path_resolver.py
â”‚   â”‚   â””â”€â”€ sanity_guards.py
â”‚   â”‚
â”‚   â”œâ”€â”€ strategies/             # ç­–ç•¥å¼•æ“
â”‚   â”‚   â”œâ”€â”€ unified_warfare_core.py      # V18éªŒé’æœº
â”‚   â”‚   â””â”€â”€ unified_warfare_scanner_adapter.py
â”‚   â”‚
â”‚   â”œâ”€â”€ backtest/               # å›æµ‹å¼•æ“
â”‚   â”‚   â”œâ”€â”€ time_machine_engine.py       # è·¨æ—¥è¿è´¯æµ
â”‚   â”‚   â””â”€â”€ trade_interface.py           # æ¨¡æ‹Ÿ/QMTäº¤æ˜“
â”‚   â”‚
â”‚   â”œâ”€â”€ data_providers/         # æ•°æ®æŠ½è±¡å±‚
â”‚   â”‚   â””â”€â”€ qmt_manager.py
â”‚   â”‚
â”‚   â””â”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚       â””â”€â”€ algo_capital.py     # èµ„é‡‘å¸è¡€ç®—æ³•
â”‚
â”œâ”€â”€ config/                     # é…ç½®æ–‡ä»¶
â”œâ”€â”€ data/                       # æ•°æ®æ¹–
â”‚   â”œâ”€â”€ cache/                  # åŸå§‹æ•°æ®ç¼“å­˜
â”‚   â”œâ”€â”€ backtest_out/           # å›æµ‹è¾“å‡º
â”‚   â””â”€â”€ memory/                 # è·¨æ—¥è®°å¿† (ShortTermMemory)
â”‚
â”œâ”€â”€ tests/                      # å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ unit/core/              # æ ¸å¿ƒç®—æ³•æµ‹è¯•
â”‚
â””â”€â”€ docs/                       # æ–‡æ¡£
    â”œâ”€â”€ CLI_USAGE.md
    â””â”€â”€ P9_2_CORE_REFACTOR_REPORT.md
```

---

## ğŸ”¬ V18 æ ¸å¿ƒç‰¹æ€§

### é«˜åˆ†è¾¨ç‡åŸºç¡€åˆ† (çº¿æ€§æå€¼æ˜ å°„)
```python
# æ¢æ‰‹ç‡å’Œæ¶¨å¹…çš„äºŒç»´æ’å€¼
base_score = interpolate2d(
    turnover=[5, 10, 15, 20],      # æ¢æ‰‹ç‡æ¡£ä½
    change=[5, 8, 10],             # æ¶¨å¹…æ¡£ä½
    score_matrix=[[10,20,30],      # 5%æ¢æ‰‹
                  [25,35,45],      # 10%æ¢æ‰‹
                  [40,50,60],      # 15%æ¢æ‰‹
                  [55,65,75]]      # 20%æ¢æ‰‹
)
```

### æ¨ªå‘å¸è¡€ä¹˜æ•° (Cross-Sectional PK)
```python
# èµ„é‡‘å‡€æµå…¥å æ¯” = å‡€æµå…¥ / æµé€šå¸‚å€¼
# å…¨å¸‚åœºæ’åï¼Œå‰10%Ã—1.5ï¼Œå‰30%Ã—1.3ï¼Œå‰50%Ã—1.0ï¼Œå50%Ã—0.7
multiplier = cross_sectional_ranking(ratio_stock, percentile_map)
```

### VWAP æƒ©ç½šæ‰£åˆ†åˆ¶
```python
# ä¿®å¤å‰ (Bug): final_score = base_score Ã— multiplier Ã— (sustain/100)  # å¯¼è‡´0.0
# ä¿®å¤å (æ­£ç¡®): final_score = base_score Ã— multiplier - penalty

final_score = base_score * multiplier
if current_price < vwap:
    final_score -= 20  # æ‰£åˆ†ï¼Œä¸æ˜¯ä¹˜æ•°
final_score = max(0, final_score)  # æ°¸ä¸ä¸º0
```

---

## ğŸ“Š å…¨æ¯æ—¶é—´æœºå™¨ (è·¨æ—¥è¿è´¯æµ)

### è·¨æ—¥è®°å¿†æœºåˆ¶
```python
# ShortTermMemory.json å­˜å‚¨å¼ºåŠ¿ç¥¨
{
  "20251231": {
    "300875.SZ": {
      "score": 85.5,
      "momentum": "STRONG",
      "carry_over": true  # æ¬¡æ—¥ä¼˜å…ˆè§‚å¯Ÿ
    }
  }
}
```

### æ¯æ—¥å›æµ‹æµç¨‹
```
1. Tushareç²—ç­› (5000â†’~500)
2. ä¸‰å±‚é˜²çº¿è¿‡æ»¤ (~500â†’~50)
3. V18éªŒé’æœºæ‰“åˆ†
4. ç”Ÿæˆå½“æ—¥æˆ˜æŠ¥
5. ä¿å­˜è·¨æ—¥è®°å¿†
6. ä¸‹ä¸€æ—¥ç»§æ‰¿è®°å¿†
```

---

## âœ… æµ‹è¯•éªŒè¯

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
pytest tests/unit/core/ -v

# æµ‹è¯•å†…å®¹åŒ…æ‹¬:
# - Test 01: Sustainæƒ©ç½šåˆ¶æµ‹è¯•
# - Test 02: é«˜åˆ†è¾¨ç‡åŸºç¡€åˆ†æµ‹è¯•
# - Test 03: VWAPæƒ©ç½šæ‰£åˆ†åˆ¶æµ‹è¯•
# - Test 04: final_scoreæ°¸ä¸ä¸º0æµ‹è¯•
# - Test 05: ä¼˜è´¨ç¥¨vsåƒåœ¾ç¥¨åŒºåˆ†åº¦æµ‹è¯•
```

---

## ğŸ“ˆ å†å²ç‰ˆæœ¬æ¼”è¿›

| ç‰ˆæœ¬ | æ ¸å¿ƒç‰¹æ€§ | çŠ¶æ€ |
|------|----------|------|
| V11-V16 | åŠè·¯æˆ˜æ³• + é¾™å¤´æˆ˜æ³• | âŒ å·²åºŸå¼ƒ |
| V17 | Portfolioå±‚èµ„é‡‘è°ƒåº¦ | âŒ å·²åºŸå¼ƒ |
| V18 | é«˜åˆ†è¾¨ç‡åŸºç¡€åˆ† + VWAPæƒ©ç½š + è·¨æ—¥è¿è´¯æµ | âœ… å½“å‰ç‰ˆæœ¬ |
| P9 | æ¶æ„é‡æ„ (492,542è¡Œåˆ é™¤) | âœ… å·²åˆå¹¶ |
| P9.2 | çœŸç›¸éš”ç¦» (çœŸCore vs å‡Core) | âœ… å·²åˆå¹¶ |
| P11 | é“è¡€é•‡å‹ (ä¸‰æ¡æ­»å¾‹ä¿®å¤) | âœ… å½“å‰ |

---

## ğŸš¨ ç¦æ­¢äº‹é¡¹

1. âŒ **ç¦æ­¢** åœ¨ä¸»ç›®å½•åˆ›å»º `.py` æ–‡ä»¶ (é‡è„šæœ¬)
2. âŒ **ç¦æ­¢** ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ® (å¿…é¡»çœŸå®Tushare/QMT)
3. âŒ **ç¦æ­¢** ç›´æ¥è¿è¡Œå­æ¨¡å— (`python logic/xxx.py`)
4. âŒ **ç¦æ­¢** ç¡¬ç¼–ç è·¯å¾„æˆ–é­”æ³•æ•°å­—
5. âŒ **ç¦æ­¢** å¼‚å¸¸é™é»˜åæ²¡ (å¿…é¡»Fail Fast)

---

## ğŸ“ é—®é¢˜æ’æŸ¥

| é—®é¢˜ | æ’æŸ¥æ–‡æ¡£ |
|------|----------|
| QMTè¿æ¥å¤±è´¥ | `docs/setup/QMTé…ç½®æŒ‡å—.md` |
| æ•°æ®å•ä½é”™è¯¯ | `SYSTEM_CONSTITUTION.md` è§„åˆ™6-7 |
| è·¯å¾„è§£æé”™è¯¯ | `logic/core/path_resolver.py` |
| æ•°æ®éªŒè¯å¤±è´¥ | `logic/core/sanity_guards.py` |

---

**æœ€åå¼ºè°ƒ**: æ‰€æœ‰æ“ä½œå¿…é¡»é€šè¿‡ `main.py` CLIå…¥å£ã€‚ç³»ç»Ÿå·²å½»åº•é‡æ„ä¸ºå·¥ä¸šçº§ä»£ç ï¼Œè¿½æ±‚æè‡´ç®€æ´å’ŒçœŸå®æ•°æ®é©±åŠ¨ã€‚
