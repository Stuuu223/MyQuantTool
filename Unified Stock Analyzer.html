"""
ä¸€ä½“åŒ–è‚¡ç¥¨åˆ†æå·¥å…· (Unified Stock Analyzer)

åŠŸèƒ½:
1. è‡ªåŠ¨åˆ¤æ–­è°ƒç”¨åœºæ™¯ï¼ˆå¼€ç›˜/åˆä¼‘/æ”¶ç›˜/å‘¨æœ«ï¼‰
2. æ™ºèƒ½é€‰æ‹©åˆ†ææ¨¡å¼ï¼ˆå®æ—¶/å¤ç›˜/æ·±åº¦ï¼‰
3. ä¸‰å±‚æ•°æ®é™çº§ç­–ç•¥ï¼ˆQMT â†’ AkShare â†’ å†å²ï¼‰
4. åŒæ ¼å¼è¾“å‡ºï¼ˆJSON + TXTï¼‰
5. æ—¶é—´åºåˆ—æ—¥å¿—ï¼ˆCSVï¼‰
6. ç»Ÿä¸€å‘½ä»¤è¡Œæ¥å£

ä½œè€…: MyQuantTool Team
ç‰ˆæœ¬: v1.0
åˆ›å»ºæ—¥æœŸ: 2026-02-03

ä½¿ç”¨ç¤ºä¾‹:
    # è‡ªåŠ¨åˆ¤æ–­åœºæ™¯
    python tools/stock_analyzer.py 300997
    
    # å¼ºåˆ¶æŒ‡å®šæ¨¡å¼
    python tools/stock_analyzer.py 300997 --mode realtime
    python tools/stock_analyzer.py 300997 --mode historical
    
    # å¸¦æŒä»“ä¿¡æ¯
    python tools/stock_analyzer.py 300997 --position 1.0 --entry-price 26.50
    
    # æŒ‡å®šè¾“å‡ºæ ¼å¼
    python tools/stock_analyzer.py 300997 --format txt
    python tools/stock_analyzer.py 300997 --format json
    python tools/stock_analyzer.py 300997 --format both
"""

import sys
import os
import json
import csv
from datetime import datetime
from typing import Dict, Any, Literal

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from logic.intraday_monitor import IntraDayMonitor
from tools.intraday_decision import IntraDayDecisionTool
from logic.enhanced_stock_analyzer import EnhancedStockAnalyzer


class UnifiedStockAnalyzer:
    """ä¸€ä½“åŒ–è‚¡ç¥¨åˆ†æå™¨"""
    
    def __init__(self):
        """åˆå§‹åŒ–åˆ†æå™¨"""
        self.monitor = IntraDayMonitor()
        self.decision_tool = IntraDayDecisionTool()
        self.historical_analyzer = EnhancedStockAnalyzer()
        
    def analyze(
        self, 
        stock_code: str,
        mode: Literal['auto', 'realtime', 'historical'] = 'auto',
        position: float = 0.0,
        entry_price: float | None = None,
        output_format: Literal['json', 'txt', 'both'] = 'both'
    ) -> Dict[str, Any]:
        """
        æ™ºèƒ½åˆ†æï¼ˆè‡ªåŠ¨åˆ¤æ–­åœºæ™¯ï¼‰
        
        Args:
            stock_code: è‚¡ç¥¨ä»£ç 
            mode: åˆ†ææ¨¡å¼ï¼ˆauto=è‡ªåŠ¨åˆ¤æ–­ï¼Œrealtime=å®æ—¶ï¼Œhistorical=å†å²ï¼‰
            position: å½“å‰æŒä»“æ¯”ä¾‹ï¼ˆ0-1ï¼‰
            entry_price: å»ºä»“ä»·æ ¼
            output_format: è¾“å‡ºæ ¼å¼ï¼ˆjson/txt/bothï¼‰
        
        Returns:
            ç»Ÿä¸€åˆ†æç»“æœ
        """
        # è·å–äº¤æ˜“é˜¶æ®µ
        phase = self.monitor.get_trading_phase()
        
        # è‡ªåŠ¨åˆ¤æ–­æ¨¡å¼
        if mode == 'auto':
            if phase in ['MORNING', 'AFTERNOON']:
                mode = 'realtime'
            elif phase == 'LUNCH_BREAK':
                mode = 'lunchtime'
            elif phase == 'AFTER_HOURS':
                mode = 'after_hours'
            elif phase == 'WEEKEND':
                mode = 'weekend'
        
        # æ ¹æ®æ¨¡å¼è°ƒç”¨ä¸åŒåˆ†æ
        if mode == 'realtime':
            result = self._realtime_analysis(stock_code, position, entry_price)
        elif mode == 'lunchtime':
            result = self._lunchtime_analysis(stock_code, position, entry_price)
        elif mode == 'after_hours':
            result = self._after_hours_analysis(stock_code, position, entry_price)
        elif mode == 'weekend':
            result = self._weekend_analysis(stock_code)
        elif mode == 'historical':
            result = self._historical_analysis(stock_code)
        else:
            result = {
                'success': False,
                'error': f'æœªçŸ¥åˆ†ææ¨¡å¼: {mode}'
            }
        
        # è¾“å‡ºç»“æœ
        if result['success']:
            self._output_result(stock_code, result, output_format)
            self._log_decision(stock_code, result)
        
        return result
    
    def _realtime_analysis(
        self, 
        stock_code: str, 
        position: float, 
        entry_price: float | None
    ) -> Dict[str, Any]:
        """
        å®æ—¶åˆ†æï¼ˆå¼€ç›˜ä¸­ï¼‰
        
        ç­–ç•¥:
        1. è·å–å®æ—¶å¿«ç…§ï¼ˆQMT/AkShareï¼‰
        2. åŠ è½½æ˜¨æ—¥å†å²åˆ†æ
        3. ç”Ÿæˆäº¤æ˜“å†³ç­–
        4. è¾“å‡ºç›˜ä¸­æŠ¥å‘Š
        """
        print(f"\n{'='*60}")
        print(f"â° ç›˜ä¸­å®æ—¶åˆ†æ - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"{'='*60}\n")
        
        # æŸ¥æ‰¾æ˜¨æ—¥åˆ†ææ–‡ä»¶
        yesterday_file = self._find_latest_analysis(stock_code)
        
        # ç”Ÿæˆå†³ç­–
        decision = self.decision_tool.make_decision(
            stock_code=stock_code,
            yesterday_file=yesterday_file,
            current_position=position,
            entry_price=entry_price
        )
        
        if not decision:
            return {
                'success': False,
                'error': 'å†³ç­–ç”Ÿæˆå¤±è´¥',
                'mode': 'realtime'
            }
        
        # è¡¥å……å®æ—¶æ•°æ®
        today_data = decision.get('data', {}).get('today', {})
        
        result = {
            'success': True,
            'mode': 'realtime',
            'phase': 'TRADING',
            'stock_code': stock_code,
            'analysis_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'realtime_snapshot': {
                'data_source': today_data.get('data_source', 'UNKNOWN'),
                'data_freshness': today_data.get('data_freshness', 'UNKNOWN'),
                'price': today_data.get('price', 0),
                'pct_change': today_data.get('pct_change', 0),
                'bid_ask_pressure': today_data.get('bid_ask_pressure', 0),
                'signal': today_data.get('signal', '')
            },
            'decision': {
                'action': decision['decision'],
                'confidence': decision['confidence'],
                'reason': decision['reason'],
                'operation': decision.get('action', {})
            },
            'risk_assessment': decision.get('risk_assessment', {}),
            'position_info': {
                'current_position': position,
                'entry_price': entry_price
            }
        }
        
        # æ‰“å°å†³ç­–æŠ¥å‘Š
        self.decision_tool.print_decision_report(decision)
        
        return result
    
    def _lunchtime_analysis(
        self, 
        stock_code: str, 
        position: float, 
        entry_price: float | None
    ) -> Dict[str, Any]:
        """
        åˆä¼‘åˆ†æï¼ˆ11:30-13:00ï¼‰
        
        ç­–ç•¥:
        1. è·å–ä¸Šåˆæ”¶ç›˜æ•°æ®ï¼ˆAkShareï¼‰
        2. åˆ†æä¸Šåˆè¡¨ç°
        3. é¢„æµ‹ä¸‹åˆèµ°åŠ¿
        4. è°ƒæ•´æŒä»“ç­–ç•¥
        """
        print(f"\n{'='*60}")
        print(f"ğŸŒ™ åˆä¼‘å¤ç›˜åˆ†æ - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"{'='*60}\n")
        
        # è·å–ä¸Šåˆæ•°æ®
        snapshot = self.monitor.get_intraday_snapshot(stock_code)
        
        if not snapshot['success']:
            return {
                'success': False,
                'error': snapshot['error'],
                'mode': 'lunchtime'
            }
        
        # æŸ¥æ‰¾æ˜¨æ—¥åˆ†æ
        yesterday_file = self._find_latest_analysis(stock_code)
        
        # ç”Ÿæˆå†³ç­–
        decision = self.decision_tool.make_decision(
            stock_code=stock_code,
            yesterday_file=yesterday_file,
            current_position=position,
            entry_price=entry_price
        )
        
        result = {
            'success': True,
            'mode': 'lunchtime',
            'phase': 'LUNCH_BREAK',
            'stock_code': stock_code,
            'analysis_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'morning_summary': {
                'data_freshness': 'DELAYED',
                'price': snapshot.get('price', 0),
                'pct_change': snapshot.get('pct_change', 0),
                'morning_high': snapshot.get('high', 0),
                'morning_low': snapshot.get('low', 0),
                'signal': snapshot.get('signal', '')
            },
            'afternoon_strategy': {
                'action': decision['decision'],
                'confidence': decision['confidence'],
                'reason': decision['reason']
            },
            'risk_assessment': decision.get('risk_assessment', {})
        }
        
        # æ‰“å°æŠ¥å‘Š
        self._print_lunchtime_report(result)
        
        return result
    
    def _after_hours_analysis(
        self, 
        stock_code: str, 
        position: float, 
        entry_price: float | None
    ) -> Dict[str, Any]:
        """
        æ”¶ç›˜ååˆ†æï¼ˆ15:00-æ¬¡æ—¥09:30ï¼‰
        
        ç­–ç•¥:
        1. è·å–å…¨å¤©æ•°æ®ï¼ˆAkShareï¼‰
        2. ç”Ÿæˆ90å¤©å†å²åˆ†æ
        3. é¢„æµ‹æ˜æ—¥èµ°åŠ¿
        4. è¾“å‡ºæ˜æ—¥ç­–ç•¥
        """
        print(f"\n{'='*60}")
        print(f"ğŸŒ† æ”¶ç›˜åæ·±åº¦åˆ†æ - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"{'='*60}\n")
        
        # è·å–ä»Šæ—¥æ”¶ç›˜æ•°æ®
        snapshot = self.monitor.get_intraday_snapshot(stock_code)
        
        # ç”Ÿæˆ90å¤©å†å²åˆ†æ
        print("æ­£åœ¨ç”Ÿæˆ90å¤©å†å²åˆ†æï¼ˆå¢å¼ºç‰ˆï¼‰...")
        historical_result = self.historical_analyzer.analyze_stock(stock_code, days=90)
        
        if not historical_result['success']:
            return {
                'success': False,
                'error': historical_result['message'],
                'mode': 'after_hours'
            }
        
        # ä¿å­˜å†å²åˆ†æ
        output_file = historical_result['output_file']
        
        result = {
            'success': True,
            'mode': 'after_hours',
            'phase': 'AFTER_HOURS',
            'stock_code': stock_code,
            'analysis_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'today_summary': {
                'data_freshness': 'STALE',
                'close': snapshot.get('price', 0) if snapshot['success'] else 0,
                'pct_change': snapshot.get('pct_change', 0) if snapshot['success'] else 0,
                'high': snapshot.get('high', 0) if snapshot['success'] else 0,
                'low': snapshot.get('low', 0) if snapshot['success'] else 0
            },
            'historical_analysis': historical_result['data'],
            'tomorrow_strategy': self._generate_tomorrow_strategy(
                historical_result['data'], 
                position, 
                entry_price
            ),
            'output_file': output_file
        }
        
        # æ‰“å°æŠ¥å‘Š
        self._print_after_hours_report(result)
        
        return result
    
    def _weekend_analysis(self, stock_code: str) -> Dict[str, Any]:
        """
        å‘¨æœ«æ·±åº¦åˆ†æ
        
        ç­–ç•¥:
        1. 90å¤©å†å²åˆ†æ
        2. èµ„é‡‘æµå‘è¶‹åŠ¿
        3. è¯±å¤šé£é™©è¯„ä¼°
        4. ä¸‹å‘¨äº¤æ˜“è®¡åˆ’
        """
        print(f"\n{'='*60}")
        print(f"ğŸ“Š å‘¨æœ«æ·±åº¦åˆ†æ - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"{'='*60}\n")
        
        # ç”Ÿæˆ90å¤©å†å²åˆ†æ
        print("æ­£åœ¨ç”Ÿæˆ90å¤©å†å²åˆ†æï¼ˆå¢å¼ºç‰ˆï¼‰...")
        historical_result = self.historical_analyzer.analyze_stock(stock_code, days=90)
        
        if not historical_result['success']:
            return {
                'success': False,
                'error': historical_result['message'],
                'mode': 'weekend'
            }
        
        result = {
            'success': True,
            'mode': 'weekend',
            'phase': 'WEEKEND',
            'stock_code': stock_code,
            'analysis_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'historical_analysis': historical_result['data'],
            'next_week_plan': self._generate_weekly_plan(historical_result['data']),
            'output_file': historical_result['output_file']
        }
        
        # æ‰“å°æŠ¥å‘Š
        self._print_weekend_report(result)
        
        return result
    
    def _historical_analysis(self, stock_code: str) -> Dict[str, Any]:
        """
        å†å²åˆ†æï¼ˆå¼ºåˆ¶æ¨¡å¼ï¼‰
        
        ç”¨é€”: æ‰‹åŠ¨è§¦å‘90å¤©åˆ†æ
        """
        print(f"\n{'='*60}")
        print(f"ğŸ“ˆ å†å²æ•°æ®åˆ†æ - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"{'='*60}\n")
        
        # ç”Ÿæˆ90å¤©å†å²åˆ†æ
        historical_result = self.historical_analyzer.analyze_stock(stock_code, days=90)
        
        if not historical_result['success']:
            return {
                'success': False,
                'error': historical_result['message'],
                'mode': 'historical'
            }
        
        return {
            'success': True,
            'mode': 'historical',
            'stock_code': stock_code,
            'analysis_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'data': historical_result['data'],
            'output_file': historical_result['output_file']
        }
    
    def _find_latest_analysis(self, stock_code: str) -> str | None:
        """æŸ¥æ‰¾æœ€æ–°çš„å†å²åˆ†ææ–‡ä»¶"""
        analysis_dir = f'data/stock_analysis/{stock_code}'
        
        if not os.path.exists(analysis_dir):
            return None
        
        # æŸ¥æ‰¾æœ€æ–°çš„ enhanced.json æ–‡ä»¶
        files = [f for f in os.listdir(analysis_dir) if f.endswith('_enhanced.json')]
        
        if not files:
            return None
        
        # æŒ‰ä¿®æ”¹æ—¶é—´æ’åº
        files.sort(key=lambda x: os.path.getmtime(os.path.join(analysis_dir, x)), reverse=True)
        
        return os.path.join(analysis_dir, files[0])
    
    def _generate_tomorrow_strategy(
        self, 
        historical_data: Dict, 
        position: float, 
        entry_price: float | None
    ) -> Dict[str, Any]:
        """ç”Ÿæˆæ˜æ—¥ç­–ç•¥"""
        trap_risk = historical_data.get('trap_detection', {}).get('comprehensive_risk_score', 0.5)
        capital_type = historical_data.get('capital_classification', {}).get('type', 'UNKNOWN')
        trend = historical_data.get('fund_flow', {}).get('trend', 'UNKNOWN')
        
        strategy = {
            'open_action': 'WAIT',
            'target_position': position,
            'stop_loss': None,
            'stop_profit': None,
            'notes': []
        }
        
        # é«˜é£é™© â†’ å‡ä»“æˆ–ç©ºä»“
        if trap_risk > 0.7:
            strategy['open_action'] = 'SELL' if position > 0 else 'AVOID'
            strategy['target_position'] = 0.0
            strategy['notes'].append('è¯±å¤šé£é™©é«˜ï¼Œå¼€ç›˜å‡ä»“')
        
        # æ¸¸èµ„ç›˜ + ä¸‹è·Œè¶‹åŠ¿ â†’ è§‚æœ›
        elif capital_type == 'HOT_MONEY' and trend == 'DOWNTREND':
            strategy['open_action'] = 'WAIT'
            strategy['notes'].append('æ¸¸èµ„å‡ºé€ƒï¼Œç­‰å¾…ä¼ç¨³')
        
        # ä½é£é™© + ä¸Šå‡è¶‹åŠ¿ â†’ é€‚åº¦å‚ä¸
        elif trap_risk < 0.3 and trend == 'UPTREND':
            strategy['open_action'] = 'BUY' if position < 1.0 else 'HOLD'
            strategy['target_position'] = min(1.0, position + 0.2)
            strategy['notes'].append('è¶‹åŠ¿å‘å¥½ï¼Œé€‚åº¦åŠ ä»“')
        
        # å…¶ä»– â†’ è§‚å¯Ÿ
        else:
            strategy['open_action'] = 'WAIT'
            strategy['notes'].append('ç›˜é¢ä¸æ˜ç¡®ï¼Œå¼€ç›˜è§‚å¯Ÿ10åˆ†é’Ÿ')
        
        return strategy
    
    def _generate_weekly_plan(self, historical_data: Dict) -> Dict[str, Any]:
        """ç”Ÿæˆä¸‹å‘¨è®¡åˆ’"""
        trap_risk = historical_data.get('trap_detection', {}).get('comprehensive_risk_score', 0.5)
        capital_type = historical_data.get('capital_classification', {}).get('type', 'UNKNOWN')
        total_flow = historical_data.get('fund_flow', {}).get('total_institution', 0)
        
        plan = {
            'week_strategy': 'DEFENSIVE',
            'entry_timing': [],
            'exit_timing': [],
            'notes': []
        }
        
        # é˜²å®ˆç­–ç•¥ï¼ˆé«˜é£é™©ï¼‰
        if trap_risk > 0.6 or total_flow < -5000:
            plan['week_strategy'] = 'DEFENSIVE'
            plan['exit_timing'].append('å‘¨ä¸€å¼€ç›˜å‡ä»“50%')
            plan['exit_timing'].append('åå¼¹ä¸è¶…3%ç«‹å³æ¸…ä»“')
            plan['notes'].append('é£é™©é«˜ï¼Œä»¥é˜²å®ˆä¸ºä¸»')
        
        # è¿›æ”»ç­–ç•¥ï¼ˆä½é£é™© + æœºæ„å¸ç­¹ï¼‰
        elif trap_risk < 0.3 and capital_type == 'INSTITUTION' and total_flow > 5000:
            plan['week_strategy'] = 'OFFENSIVE'
            plan['entry_timing'].append('å‘¨ä¸€å¼€ç›˜é€‚åº¦å»ºä»“20%')
            plan['entry_timing'].append('å›è°ƒ2-3%åŠ ä»“20%')
            plan['notes'].append('æœºæ„å¸ç­¹ï¼Œå¯é€‚åº¦å‚ä¸')
        
        # è§‚æœ›ç­–ç•¥
        else:
            plan['week_strategy'] = 'WAIT_AND_SEE'
            plan['notes'].append('ç›˜é¢ä¸æ˜ç¡®ï¼Œç­‰å¾…ä¿¡å·')
        
        return plan
    
    def _output_result(
        self, 
        stock_code: str, 
        result: Dict, 
        output_format: str
    ):
        """è¾“å‡ºåˆ†æç»“æœ"""
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        output_dir = f'data/stock_analysis/{stock_code}'
        os.makedirs(output_dir, exist_ok=True)
        
        # JSONæ ¼å¼
        if output_format in ['json', 'both']:
            json_file = os.path.join(output_dir, f'{stock_code}_{timestamp}_analysis.json')
            with open(json_file, 'w', encoding='utf-8') as f:
                json.dump(result, f, ensure_ascii=False, indent=2)
            print(f"\nâœ… JSONç»“æœå·²ä¿å­˜: {json_file}")
        
        # TXTæ ¼å¼
        if output_format in ['txt', 'both']:
            txt_file = os.path.join(output_dir, f'{stock_code}_{timestamp}_analysis.txt')
            with open(txt_file, 'w', encoding='utf-8') as f:
                f.write(self._format_to_txt(result))
            print(f"âœ… TXTç»“æœå·²ä¿å­˜: {txt_file}")
    
    def _format_to_txt(self, result: Dict) -> str:
        """æ ¼å¼åŒ–ä¸ºTXTï¼ˆäººç±»å¯è¯»ï¼‰"""
        lines = []
        lines.append("=" * 80)
        lines.append(f"ğŸ“Š è‚¡ç¥¨åˆ†ææŠ¥å‘Š")
        lines.append("=" * 80)
        lines.append(f"è‚¡ç¥¨ä»£ç : {result.get('stock_code', 'N/A')}")
        lines.append(f"åˆ†ææ¨¡å¼: {result.get('mode', 'N/A')}")
        lines.append(f"åˆ†ææ—¶é—´: {result.get('analysis_time', 'N/A')}")
        lines.append("=" * 80)
        
        # å®æ—¶åˆ†æ
        if result.get('mode') == 'realtime':
            snapshot = result.get('realtime_snapshot', {})
            decision = result.get('decision', {})
            
            lines.append("\nâ° å®æ—¶å¿«ç…§:")
            lines.append(f"  æ•°æ®æ¥æº: {snapshot.get('data_source', 'N/A')}")
            lines.append(f"  æ•°æ®æ–°é²œåº¦: {snapshot.get('data_freshness', 'N/A')}")
            lines.append(f"  å½“å‰ä»·æ ¼: {snapshot.get('price', 0):.2f}")
            lines.append(f"  æ¶¨è·Œå¹…: {snapshot.get('pct_change', 0):.2f}%")
            lines.append(f"  ä¹°å–å‹åŠ›: {snapshot.get('bid_ask_pressure', 0):.2f}")
            
            lines.append("\nğŸ¯ äº¤æ˜“å†³ç­–:")
            lines.append(f"  å†³ç­–: {decision.get('action', 'N/A')}")
            lines.append(f"  ç½®ä¿¡åº¦: {decision.get('confidence', 0):.0%}")
            lines.append(f"  ç†ç”±: {decision.get('reason', 'N/A')}")
        
        # åˆä¼‘åˆ†æ
        elif result.get('mode') == 'lunchtime':
            morning = result.get('morning_summary', {})
            afternoon = result.get('afternoon_strategy', {})
            
            lines.append("\nğŸŒ™ ä¸Šåˆè¡¨ç°:")
            lines.append(f"  ä»·æ ¼: {morning.get('price', 0):.2f}")
            lines.append(f"  æ¶¨è·Œå¹…: {morning.get('pct_change', 0):.2f}%")
            lines.append(f"  æœ€é«˜: {morning.get('morning_high', 0):.2f}")
            lines.append(f"  æœ€ä½: {morning.get('morning_low', 0):.2f}")
            
            lines.append("\nğŸ”® ä¸‹åˆç­–ç•¥:")
            lines.append(f"  å»ºè®®: {afternoon.get('action', 'N/A')}")
            lines.append(f"  ç½®ä¿¡åº¦: {afternoon.get('confidence', 0):.0%}")
            lines.append(f"  ç†ç”±: {afternoon.get('reason', 'N/A')}")
        
        # æ”¶ç›˜ååˆ†æ
        elif result.get('mode') == 'after_hours':
            today = result.get('today_summary', {})
            tomorrow = result.get('tomorrow_strategy', {})
            
            lines.append("\nğŸŒ† ä»Šæ—¥æ€»ç»“:")
            lines.append(f"  æ”¶ç›˜ä»·: {today.get('close', 0):.2f}")
            lines.append(f"  æ¶¨è·Œå¹…: {today.get('pct_change', 0):.2f}%")
            lines.append(f"  æœ€é«˜: {today.get('high', 0):.2f}")
            lines.append(f"  æœ€ä½: {today.get('low', 0):.2f}")
            
            lines.append("\nğŸ”® æ˜æ—¥ç­–ç•¥:")
            lines.append(f"  å¼€ç›˜åŠ¨ä½œ: {tomorrow.get('open_action', 'N/A')}")
            lines.append(f"  ç›®æ ‡ä»“ä½: {tomorrow.get('target_position', 0):.0%}")
            if tomorrow.get('notes'):
                for note in tomorrow['notes']:
                    lines.append(f"  - {note}")
        
        # å‘¨æœ«åˆ†æ
        elif result.get('mode') == 'weekend':
            plan = result.get('next_week_plan', {})
            
            lines.append("\nğŸ“… ä¸‹å‘¨è®¡åˆ’:")
            lines.append(f"  ç­–ç•¥: {plan.get('week_strategy', 'N/A')}")
            
            if plan.get('entry_timing'):
                lines.append("  è¿›åœºæ—¶æœº:")
                for timing in plan['entry_timing']:
                    lines.append(f"    - {timing}")
            
            if plan.get('exit_timing'):
                lines.append("  ç¦»åœºæ—¶æœº:")
                for timing in plan['exit_timing']:
                    lines.append(f"    - {timing}")
            
            if plan.get('notes'):
                lines.append("  å¤‡æ³¨:")
                for note in plan['notes']:
                    lines.append(f"    - {note}")
        
        lines.append("\n" + "=" * 80)
        lines.append("é£é™©æç¤º: æœ¬åˆ†æä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®")
        lines.append("=" * 80)
        
        return '\n'.join(lines)
    
    def _log_decision(self, stock_code: str, result: Dict):
        """è®°å½•å†³ç­–æ—¥å¿—ï¼ˆCSVæ—¶é—´åºåˆ—ï¼‰"""
        log_dir = 'data/decision_logs'
        os.makedirs(log_dir, exist_ok=True)
        
        log_file = os.path.join(log_dir, f'{stock_code}_decisions.csv')
        
        # æå–å…³é”®æŒ‡æ ‡
        log_entry = {
            'timestamp': result.get('analysis_time', ''),
            'mode': result.get('mode', ''),
            'phase': result.get('phase', ''),
            'decision': '',
            'confidence': 0,
            'price': 0,
            'pct_change': 0,
            'risk_score': 0
        }
        
        if result.get('mode') == 'realtime':
            decision = result.get('decision', {})
            snapshot = result.get('realtime_snapshot', {})
            risk = result.get('risk_assessment', {})
            
            log_entry.update({
                'decision': decision.get('action', ''),
                'confidence': decision.get('confidence', 0),
                'price': snapshot.get('price', 0),
                'pct_change': snapshot.get('pct_change', 0),
                'risk_score': risk.get('risk_score', 0)
            })
        
        # å†™å…¥CSV
        file_exists = os.path.exists(log_file)
        
        with open(log_file, 'a', newline='', encoding='utf-8') as f:
            writer = csv.DictWriter(f, fieldnames=log_entry.keys())
            
            if not file_exists:
                writer.writeheader()
            
            writer.writerow(log_entry)
    
    def _print_lunchtime_report(self, result: Dict):
        """æ‰“å°åˆä¼‘æŠ¥å‘Š"""
        morning = result.get('morning_summary', {})
        afternoon = result.get('afternoon_strategy', {})
        risk = result.get('risk_assessment', {})
        
        print("\n" + "="*60)
        print(f"ğŸŒ™ ä¸Šåˆè¡¨ç°æ€»ç»“")
        print("="*60)
        print(f"ä»·æ ¼: {morning.get('price', 0):.2f} ({morning.get('pct_change', 0):.2f}%)")
        print(f"åŒºé—´: {morning.get('morning_low', 0):.2f} - {morning.get('morning_high', 0):.2f}")
        print(f"ä¿¡å·: {morning.get('signal', 'N/A')}")
        
        print(f"\nğŸ”® ä¸‹åˆç­–ç•¥å»ºè®®")
        print("="*60)
        print(f"å»ºè®®: {afternoon.get('action', 'N/A')} (ç½®ä¿¡åº¦: {afternoon.get('confidence', 0):.0%})")
        print(f"ç†ç”±: {afternoon.get('reason', 'N/A')}")
        
        print(f"\nğŸš¨ é£é™©è¯„ä¼°")
        print("="*60)
        print(f"ç»¼åˆé£é™©: {risk.get('overall_risk', 'N/A')}")
        print(f"è¯±å¤šé£é™©: {risk.get('trap_risk', 0):.2f}")
        print(f"èµ„é‡‘æ€§è´¨: {risk.get('capital_type', 'N/A')}")
        print("\n" + "="*60 + "\n")
    
    def _print_after_hours_report(self, result: Dict):
        """æ‰“å°æ”¶ç›˜åæŠ¥å‘Š"""
        today = result.get('today_summary', {})
        tomorrow = result.get('tomorrow_strategy', {})
        
        print("\n" + "="*60)
        print(f"ğŸŒ† ä»Šæ—¥äº¤æ˜“æ€»ç»“")
        print("="*60)
        print(f"æ”¶ç›˜ä»·: {today.get('close', 0):.2f} ({today.get('pct_change', 0):.2f}%)")
        print(f"åŒºé—´: {today.get('low', 0):.2f} - {today.get('high', 0):.2f}")
        
        print(f"\nğŸ”® æ˜æ—¥ç­–ç•¥")
        print("="*60)
        print(f"å¼€ç›˜åŠ¨ä½œ: {tomorrow.get('open_action', 'N/A')}")
        print(f"ç›®æ ‡ä»“ä½: {tomorrow.get('target_position', 0):.0%}")
        
        if tomorrow.get('notes'):
            print("\nå¤‡æ³¨:")
            for note in tomorrow['notes']:
                print(f"  - {note}")
        
        print(f"\nğŸ“ è¯¦ç»†åˆ†æå·²ä¿å­˜: {result.get('output_file', 'N/A')}")
        print("\n" + "="*60 + "\n")
    
    def _print_weekend_report(self, result: Dict):
        """æ‰“å°å‘¨æœ«æŠ¥å‘Š"""
        plan = result.get('next_week_plan', {})
        
        print("\n" + "="*60)
        print(f"ğŸ“… ä¸‹å‘¨äº¤æ˜“è®¡åˆ’")
        print("="*60)
        print(f"ç­–ç•¥å®šä½: {plan.get('week_strategy', 'N/A')}")
        
        if plan.get('entry_timing'):
            print("\nè¿›åœºæ—¶æœº:")
            for timing in plan['entry_timing']:
                print(f"  âœ… {timing}")
        
        if plan.get('exit_timing'):
            print("\nç¦»åœºæ—¶æœº:")
            for timing in plan['exit_timing']:
                print(f"  âŒ {timing}")
        
        if plan.get('notes'):
            print("\nç­–ç•¥è¦ç‚¹:")
            for note in plan['notes']:
                print(f"  ğŸ“Œ {note}")
        
        print(f"\nğŸ“ è¯¦ç»†åˆ†æå·²ä¿å­˜: {result.get('output_file', 'N/A')}")
        print("\n" + "="*60 + "\n")


def main():
    """å‘½ä»¤è¡Œå…¥å£"""
    import argparse
    
    parser = argparse.ArgumentParser(description='ä¸€ä½“åŒ–è‚¡ç¥¨åˆ†æå·¥å…·')
    parser.add_argument('stock_code', help='è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ 300997ï¼‰')
    parser.add_argument('--mode', 
                        choices=['auto', 'realtime', 'historical'], 
                        default='auto',
                        help='åˆ†ææ¨¡å¼ï¼ˆauto=è‡ªåŠ¨åˆ¤æ–­ï¼Œrealtime=å®æ—¶ï¼Œhistorical=å†å²ï¼‰')
    parser.add_argument('--position', type=float, default=0.0,
                        help='å½“å‰æŒä»“æ¯”ä¾‹ï¼ˆ0-1ï¼‰')
    parser.add_argument('--entry-price', type=float, default=None,
                        help='å»ºä»“ä»·æ ¼')
    parser.add_argument('--format', 
                        choices=['json', 'txt', 'both'], 
                        default='both',
                        help='è¾“å‡ºæ ¼å¼ï¼ˆjson/txt/bothï¼‰')
    
    args = parser.parse_args()
    
    # æ‰§è¡Œåˆ†æ
    analyzer = UnifiedStockAnalyzer()
    result = analyzer.analyze(
        stock_code=args.stock_code,
        mode=args.mode,
        position=args.position,
        entry_price=args.entry_price,
        output_format=args.format
    )
    
    # å¤„ç†é”™è¯¯
    if not result['success']:
        print(f"\nâŒ åˆ†æå¤±è´¥: {result.get('error', 'æœªçŸ¥é”™è¯¯')}")
        sys.exit(1)


if __name__ == '__main__':
    main()
