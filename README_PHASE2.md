# MyQuantTool - Phase 2: 全市场诱多扫描系统

> **项目阶段**: Phase 2 - 全市场批量扫描  
> **创建日期**: 2026-02-11  
> **版本号**: v2.0.0  

---

## 🎯 项目概述

### 阶段1 vs 阶段2

| 对比项 | 阶段1（单股盘口） | 阶段2（全市场扫描） |
|----------|---------------------|---------------------|
| **监控范围** | 1-5只股票 | 5000+股票（全A股） |
| **数据源** | 实时Tick | 分钟K + 竞价快照 |
| **扫描频率** | 每5秒 | 每天2-3次 |
| **处理速度** | 实时响应 | 5-10分钟/全市场 |
| **输出结果** | 实时预警 | TOP 20-50榜单 |
| **适用场景** | 盯盘狙击 | 市场扫陇 |

### 核心特性

✅ **三阶段渐进式筛选**  
- 阶段1：预筛选（5000股 → 200-400股，1分钟）  
- 阶段2：四维初筛（200-400股 → 50-100股，3分钟）  
- 阶段3：精准QPST（50-100股 → 20-50股，5分钟）

✅ **四维交叉验证（分钟K优化版）**  
- **量**：分钟K成交量标准差代替Tick波动率  
- **价**：分钟K振幅识别暴力拉升  
- **空**：预加载股本批量计算换手率  
- **时**：连续N根分钟K放量判断持续性

✅ **智能多进程**  
- <100股：单进程（稳定）  
- ≥100股：多进程（4-8核，快速）

✅ **数据获取策略**  
- 优先：QMT接口（实时数据）  
- 备份：本地CSV缓存  
- 自动降级：接口失败时使用缓存

✅ **彩色CLI输出 + Markdown报告**  
- 彩色表格（rich库）  
- JSON文件导出  
- 日报/周报自动生成

---

## 🚀 快速开始

### 1. 依赖安装

```bash
# 必须依赖
pip install pandas numpy

# 彩色输出（强烈推荐）
pip install rich

# QMT 接口（已安装QMT则自动支持）
# 无需手动安装，确保QMT客户端已登录
```

### 2. 目录结构

```
MyQuantTool/
├── logic/
│   ├── batch_qpst_analyzer.py   # 批量四维分析器
│   └── market_scanner.py         # 全市场扫描引擎
├── tasks/
│   ├── scan_market.py            # CLI扫描脚本
│   ├── generate_daily_report.py  # 日报生成器
│   └── generate_weekly_report.py # 周报生成器
├── data/
│   ├── equity_info.json          # 股本信息（必需）
│   ├── scan_results/             # 扫描结果目录
│   ├── daily_reports/            # 日报目录
│   └── kline_cache/              # K线缓存目录
└── README_PHASE2.md           # 本文档
```

### 3. 使用示例

#### 基础使用

```bash
# 1. 默认扫描全A股
python tasks/scan_market.py

# 2. 指定扫描时间点
python tasks/scan_market.py --scan-time 09:35

# 3. 只显示Top 20
python tasks/scan_market.py --top 20

# 4. 扫描指定股票列表
python tasks/scan_market.py --codes 300997.SZ,603697.SH,601869.SH

# 5. 组合参数
python tasks/scan_market.py --scan-time 10:00 --top 30 --no-save
```

#### 生成报告

```bash
# 1. 生成今日报告
python tasks/generate_daily_report.py

# 2. 指定日期
python tasks/generate_daily_report.py --date 20260211

# 3. 生成周报（周一运行）
python tasks/generate_weekly_report.py
```

---

## 🔍 功能详解

### 1. 三阶段渐进式筛选

```
╔═══════════════════════════════╗
║  阶段1: 预筛选（硬性条件）  ║
╚═══════════════════════════════╝
5000股 → 200-400股（1分钟）

筛选条件：
1. 涨幅 > 2%
2. 换手率 > 3%（10分钟）
3. 放量 > 1.3倍

         ↓

╔═══════════════════════════════╗
║  阶段2: 四维初筛（简化QPST） ║
╚═══════════════════════════════╝
200-400股 → 50-100股（3分钟）

检测异常：
- 量能异常？
- 价格异常？
- 换手异常？
- 时间异常？
≥ 2个维度异常 → 通过

         ↓

╔═══════════════════════════════╗
║  阶段3: 精准QPST（完整分析） ║
╚═══════════════════════════════╝
50-100股 → 20-50股（5分钟）

完整分析：
- 四维详细分析
- 反诱多检测
- 投票机制综合判断

         ↓

╔═══════════════════════════════╗
║     TOP 20-50 诱多榜单     ║
╚═══════════════════════════════╝
```

### 2. 四维分析优化（分钟K版本）

| 维度 | 阶段1（Tick版） | 阶段2（分钟K版） |
|------|------------------|---------------------|
| **量** | Tick累计成交量 | 分钟K成交量标准差 |
| **价** | Tick级价格波动 | 分钟K振幅（high-low） |
| **空** | 实时换手率 | 批量计算换手率 |
| **时** | 秒级持续性 | 连续N根分钟K放量 |

### 3. 反诱多检测

#### 检测1：尾盘拉升
```
特征：14:30后突然放量，最近5分钟量能 > 前5分钟的2倍
风险：警惕次日低开，机构可能在尾盘出货
```

#### 检测2：放量滞涨
```
特征：成交量异常放大，但价格不涨或微涨
风险：可能是对倒或出货，需进一步验证
```

#### 检测3：连续涨停开板
```
特征：连续涨停后首次开板
风险：可能是出货信号，尤其是开板当日放巨量
```

---

## 📊 输出说明

### 1. JSON文件格式

**文件路径**: `data/scan_results/trap_scan_YYYYMMDD_HHMMSS.json`

```json
{
  "scan_time": "2026-02-11T14:30:00",
  "total_count": 25,
  "results": [
    {
      "code": "300997.SZ",
      "final_signal": "TRAP_WARNING",
      "confidence": 0.9,
      "reason": "诱多预警: 尾盘拉升：警惕次日低开",
      "timestamp": "14:30:15",
      "dimensions": {
        "quantity": {"signal": "STRONG_VOLUME", "volume_ratio": 2.5},
        "price": {"signal": "VIOLENT_RISE", "price_change": 0.035},
        "space": {"signal": "HIGH_TURNOVER_RISING", "turnover": 0.025},
        "time": {"signal": "TAIL_SURGE", "time_period": "AFTERNOON_CLOSE"}
      },
      "trap_signals": ["尾盘拉升：警惕次日低开"]
    }
  ]
}
```

### 2. 日报格式示例

**文件路径**: `data/daily_reports/daily_report_YYYYMMDD.md`

```markdown
# 📈 诱多扫描日报

**报告日期**: 2026年02月11日 星期三
**生成时间**: 2026-02-11 15:30:00

---

## 📊 统计概览

| 项目 | 数量 |
|------|------|
| 🔴 高风险（≥ 80%） | 12 |
| 🟡 中风险（60%-80%） | 8 |
| 🟢 低风险（< 60%） | 5 |
| **总计** | **25** |

---

## 🔴 高风险警报 (置信度 ≥ 80%)

| # | 股票代码 | 预警类型 | 置信度 | 时间 |
|---|----------|----------|--------|------|
| 1 | 300997.SZ | 诱多预警: 尾盘拉升 | 90% | 14:30 |
| 2 | 603697.SH | 诱多预警: 放量滞涨 | 85% | 10:15 |
...
```

### 3. CLI输出示例

```
════════════════════════════════════════════════
🚀 开始全市场扫描
════════════════════════════════════════════════

🔍 阶段1: 预筛选（硬性条件）
────────────────────────────────────────────────
✅ 阶段1完成: 5000 → 312 只股票

🔍 阶段2: 四维初筛（简化QPST）
────────────────────────────────────────────────
✅ 阶段2完成: 312 → 78 只股票

🔍 阶段3: 精准QPST（完整分析）
────────────────────────────────────────────────
  ⚠️  300997.SZ: 诱多预警: 尾盘拉升 (置信度: 90%)
  ⚠️  603697.SH: 诱多预警: 放量滞涨 (置信度: 85%)
✅ 阶段3完成: 78 → 25 只股票

╭──────────────────────────────────────────────╮
│        🚨 诱多预警榜单 TOP 25      │
├──────┬────────────┬──────────┬──────────┬──────────┤
│  #   │ Code       │ Reason   │ Conf     │ Time     │
├──────┼────────────┼──────────┼──────────┼──────────┤
│  1   │ 300997.SZ  │ 尾盘拉升 │ 90%      │ 14:30:15 │
│  2   │ 603697.SH  │ 放量滞涨 │ 85%      │ 10:15:22 │
╰──────┴────────────┴──────────┴──────────┴──────────╯
```

---

## ⏰ 执行流程建议

### 每日扫描建议

| 时间 | 操作 | 原因 |
|------|------|------|
| **09:35** | 第1次扫描 | 捕捉开盘后首次异动 |
| **10:00** | 第2次扫描 | 确认是否持续活跃 |
| **14:00** | 第3次扫描 | 尾盘拉升预警 |
| **15:10** | 生成日报 | 汇总全天扫描结果 |

### 命令示例

```bash
# 早上 09:35
python tasks/scan_market.py --scan-time 09:35 --top 50

# 上午 10:00
python tasks/scan_market.py --scan-time 10:00 --top 50

# 下午 14:00
python tasks/scan_market.py --scan-time 14:00 --top 50

# 收盘后生成日报
python tasks/generate_daily_report.py

# 周一生成周报
python tasks/generate_weekly_report.py
```

---

## ⚙️ 高级配置

### 1. 调整筛选阈值

编辑 `logic/market_scanner.py`，修改 `_phase1_pre_filter` 方法：

```python
# 默认阈值
if price_change > 0.02 and turnover > 0.03 and volume_ratio > 1.3:
    candidates.append(code)

# 更严格（减少候选股票）
if price_change > 0.03 and turnover > 0.05 and volume_ratio > 1.5:
    candidates.append(code)

# 更宽松（增加候选股票）
if price_change > 0.01 and turnover > 0.02 and volume_ratio > 1.2:
    candidates.append(code)
```

### 2. 调整多进程数量

编辑 `logic/market_scanner.py`，修改 `_phase3_qpst_full` 方法：

```python
# 默认：最多8核
with Pool(processes=min(8, cpu_count())) as pool:

# 更多核心（提升速度）
with Pool(processes=min(16, cpu_count())) as pool:

# 更少核心（降低CPU负载）
with Pool(processes=min(4, cpu_count())) as pool:
```

---

## ❌ 故障排除

### 常见错误 1：QMT接口失败

```
错误信息: xtquant 未安装
解决方案:
1. 确认QMT客户端已安装
2. 确认QMT客户端已登录
3. 检查 xtquant 模块路径
```

### 常见错误 2：股本信息缺失

```
错误信息: 换手率分析不可用
解决方案:
1. 检查 data/equity_info.json 是否存在
2. 运行阶段1生成股本信息
3. 手动添加股本信息
```

### 常见错误 3：内存不足

```
错误信息: MemoryError
解决方案:
1. 减少扫描股票数量
2. 调低多进程数量
3. 增大系统内存
```

---

## 📌 注意事项

1. **实盘验证必要**：扫描结果仅供参考，必须结合其他指标和实盘验证。
2. **风险提示**：诱多预警不等于绝对准确，请严格执行止损策略。
3. **数据延迟**：分钟K数据可能存在延迟，建议在扫描后等待数秒再查看结果。
4. **计算资源**：全市场扫描将占用较多CPU和内存，不建议在交易机上频繁执行。
5. **法律声明**：本工具仅供学习交流，不构成投资建议，投资错误风险自担。

---

## 🔗 相关文档

- [README_PHASE1.md](README_PHASE1.md) - 阶段1文档（单股监控）
- [ACCEPTANCE_REPORT_PHASE1.md](ACCEPTANCE_REPORT_PHASE1.md) - 阶段1验收报告

---

**最后更新**: 2026-02-11  
**作者**: MyQuantTool Team  
**版权**: MIT License
