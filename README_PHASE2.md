# Phase 2: 全市场扫描系统（QPST批量分析）

> **阶段目标**：在阶段1验证成功后，扩展到全A股市场，每日扫描5000+股票，输出TOP 20-50诱多榜单
> **实施周期**：2-3周开发 + 2周调优
> **成功标准**：扫描速度 <10分钟/次，榜单准确率 >70%

---

## 🎯 核心功能

### 1. 三阶段渐进式筛选

| 阶段 | 输入 | 输出 | 耗时 | 筛选条件 |
|------|------|------|------|----------|
| **阶段1: 预筛选** | 5000股 | 200-400股 | 1分钟 | 涨幅>2% AND 换手>3% AND 放量>1.3倍 |
| **阶段2: 初筛** | 200-400股 | 50-100股 | 3分钟 | 简化QPST，至少2个维度异常 |
| **阶段3: 精筛** | 50-100股 | 20-50股 | 5分钟 | 完整QPST + 反诱多检测 |

**总耗时**: 5-10分钟（单次扫描）

---

### 2. 分钟K级别QPST优化

| 维度 | 阶段1（Tick） | 阶段2（分钟K） | 优化说明 |
|------|----------------|------------------|----------|
| **量** | Tick级量能波动率 | 分钟K成交量标准差 | 用标准差代替Tick波动 |
| **价** | Tick级价格波动 | 分钟K最高最低价差 | 用振幅识别暴力拉升 |
| **空** | 实时换手率 | 10分钟累计换手率 | 预加载股本，批量计算 |
| **时** | 秒级持续性 | 连续 N根分钟K放量 | 用连续放量判断持续性 |

---

### 3. 扫描时间表

| 时间 | 扫描对象 | 目的 |
|------|----------|------|
| **09:35** | 开盘 5分钟 | 捕捉早盘快速拉升（可能是诱多） |
| **10:00** | 开盘 30分钟 | 验证早盘放量的持续性 |
| **14:00** | 午盘 1小时 | 识别午后异动（尾盘拉升前奏） |

---

## 🚀 快速开始

### 步除1：切换到Phase2分支

```bash
cd MyQuantTool
git fetch origin feature/smart-flow-qpst-phase2
git checkout feature/smart-flow-qpst-phase2
```

### 步除2：安装依赖（新增）

```bash
# 激活虚拟环境
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装rich库（彩色CLI）
pip install rich
```

### 步除3：准备数据

```bash
# 确认股本信息文件存在
ls -lh data/equity_info.json

# 如果不存在，同步数据
python tasks/sync_equity_info.py
```

### 步除4：执行扫描

```bash
# 扫描全市场（默认设置）
python tasks/scan_market_qpst.py

# 自定义扫描时间点
python tasks/scan_market_qpst.py --time 09:35

# 指定输出目录
python tasks/scan_market_qpst.py --output data/scan_results/

# 禁用多进程（单进程模式）
python tasks/scan_market_qpst.py --no-multiprocess
```

---

## 📊 输出示例

### CLI彩色输出

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚀 全市场QPST扫描器 - 阶段2
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
扫描范围: 全A股 5000+ 股票
筛选机制: 三阶段渐进式 (5000→300→100→50)
输出结果: TOP 20-50 诱多榜单

✅ 成功加载 5127 只股票

🔍 扫描时间点: 10:00
📊 扫描股票数: 5127
⚙️  多进程: 开启

[扫描中] 执行QPST四维分析...
✅ 扫描完成! 耗时: 8.3秒

⚠️  发现 35 只疑似诱多股票

╭──────────────────────────────────────────────────────╮
│ 🚨 诱多预警榜单 TOP 35                                    │
├──────────────────────────────────────────────────────┤
│ 排名   股票代码     预警类型              置信度    原因    │
├──────────────────────────────────────────────────────┤
│  #1    300997.SZ    对倒嫌疑               90%     ...│
│  #2    603697.SH    尾盘拉升               90%     ...│
│  #3    601869.SH    连板开板               85%     ...│
...
╰──────────────────────────────────────────────────────╯

💾 扫描结果已保存: data/scan_results/scan_qpst_20260211_100532.json

✨ 扫描任务完成!
```

---

## 📝 日报/周报生成

### 生成日报

```bash
# 生成今日报告
python tasks/generate_daily_report.py

# 指定日期
python tasks/generate_daily_report.py --date 2026-02-11

# 发送邮件（待实现）
python tasks/generate_daily_report.py --send-email
```

**输出文件**: `data/reports/daily/daily_report_20260211.md`

### 生成周报

```bash
# 生成本周报告
python tasks/generate_weekly_report.py

# 指定周的开始日期（周一）
python tasks/generate_weekly_report.py --start-date 2026-02-10
```

**输出文件**: `data/reports/weekly/weekly_report_20260210.md`

---

## 🛠️ 故障排除

### Q1: `rich 模块未安装`

**解决**：
```bash
pip install rich
```

### Q2: `扫描速度过慢`

**原因**：多进程未启用或CPU资源不足

**解决**：
1. 确认多进程已启用（默认开启）
2. 调整进程数：修改 `config/phase2_config.yaml` 中的 `num_processes`
3. 升级硬件（推荐 8核CPU）

### Q3: `内存不足`

**原因**：同时加载过多股票的分钟K数据

**解决**：
1. 减少预筛选的股票数量（提高阈值）
2. 减少进程数
3. 使用批量处理模式（分批扫描）

### Q4: `股本信息缺失`

**解决**：
```bash
# 同步股本信息
python tasks/sync_equity_info.py
```

---

## ✅ 验证标准

### 性能指标

- ✅ 扫描速度: <10分钟/次
- ✅ 内存占用: <4GB
- ✅ CPU利用率: <80%（多核平均）

### 准确率指标

- ✅ 榜单准确率: >70%（预警后1-3天验证）
- ✅ 误报率: <20%
- ✅ 漏报率: <30%（与阶段1对比）

### 验证方法

1. **每日扫描**: 在 09:35, 10:00, 14:00 执行扫描
2. **记录榜单**: 保存每次扫描的TOP 20榜单
3. **跟踪验证**: 1-3个交易日后验证预警准确性
4. **周报汇总**: 每周生成周报，统计准确率

---

## 🔜 下一步：阶段3

当 Phase 2 验证成功后，将开始 **阶段3：深度优化**：

### 计划功能

1. **竞价快照分析**
   - 集合竞价资金意图
   - 开盘前诱多识别

2. **历史数据回测**
   - 使用历史分钟K回测算法
   - 优化四维阈值参数

3. **机器学习增强**
   - 训练诱多识别模型
   - 动态调整置信度权重

4. **实时监控面板**
   - Streamlit Web界面
   - 实时榜单展示
   - 历史走势图表

敬请期待！
