# MyQuantTool 架构铁律

> 说明：本文件是项目级硬规范，优先级高于一般文档和口头约定。  
> 任何代码、配置或流程如与本文件冲突，必须在 PR 中显式说明原因，并经 CTO 确认。

---

## 1. 策略与阈值铁律

### 1.1 禁止魔法数字进入核心引擎

- 核心引擎（回测引擎 / 实盘引擎 / TradeGatekeeper 等）中禁止出现随意拍定的阈值常数。
- 所有阈值必须来源于：
  - 已验证的经验公式（如 `ratio = mainnetinflow / circmv` + 动态阈值）；或
  - 配置文件（`config/*.json`）中明确声明；或
  - 带有注释说明的实验脚本（不允许出现在核心路径中）。

### 1.2 一切强弱判定优先用相对尺度

- 资金强度：
  - 使用 `ratio = mainnetinflow / circulating_cap` 或等价"占比"指标；
  - 禁止仅用净额绝对值（如"1 亿就是强"）。
- 价格强度：
  - 使用相对开盘/前收的涨跌幅；
  - 在需要时使用市场/板块分位数（如"当日前 1%"）进行判定。

### 1.3 情绪与阈值必须联动

- 止损、止盈、资金阈值、过滤器敏感度等参数，必须允许根据情绪阶段（如分歧期/一致期/退潮期）进行调整。
- 禁止在任意市场阶段使用完全相同的一组阈值而不考虑环境变化。

---

## 2. 数据与 Tick 链路铁律

### 2.1 Tick 数据唯一通路

- Tick 数据的下载、缓存和读取必须通过统一 Provider 管理（`TickProvider`）。
- 严禁在业务代码中直接：
  - `import xtquant.xtdata` 或 `import xtquant.xtdatacenter as xtdc`；
  - 直接拼接或访问 QMT 数据目录路径。
- 如需扩展 Tick 行为，必须在 Provider 内部实现。

### 2.2 明示 tick 覆盖范围

- Provider 必须提供接口返回单票的 tick 可用日期范围，并区分：
  - 实时录制产生的数据；
  - 历史回灌可得到的数据；
  - 不存在 tick、只能退化到 1m 的日期。
- 禁止在 tick 实际缺失的日期假定"已经有 tick 数据"。

### 2.3 历史 vs 实时的时效性约束

- 回测与实盘辅助决策必须区分：
  - 纯历史检验（任意日期范围）；
  - 盘中实时判断（需要明确时间戳）。
- 禁止使用超过 4 小时以上的日内数据对当前交易日给出"操作建议"类结论。

---

## 3. 过滤与防守轴铁律

### 3.1 过滤器优先评分制，慎用一票否决

- 板块共振、竞价强度、市值过滤、风险特征等应尽量输出 0–1 分数或多标签结果；
- 只有在确定为高风险场景（如明显 TRAP、尾盘偷袭）时才允许"一票否决"。

### 3.2 禁止在新模块重复发明过滤逻辑

- 所有新过滤逻辑必须基于现有防守轴（如 V11 triplefunnel / defenseaxe）抽象复用；
- 禁止为单一回测/单脚本重新编写一套风格完全不同的过滤器（例如再造一个 wind_filter + 动态阈值 + auction 组合）。

### 3.3 过滤器改动必须有回测对照

- 任意过滤器参数或结构调整，必须在"热门样本集"（见 第 5 章）上跑至少一轮回测。
- PR 需附带：
  - 过滤前后触发次数；
  - 胜率、收益率、最大回撤的变化情况。

---

## 4. 资金为王铁律

### 4.1 形态可以错过，资金不能整体沉默

- 对成交量和持续性明显突出的个股：
  - 若资金轴（TrueAttack / ratio / 资金攻击事件）完全无信号，视为系统缺陷。
- 此时必须检查：
  - Tick → 资金估算链路是否工作；
  - 动态阈值是否明显过严；
  - 是否被不合理过滤器短路。

### 4.2 资金攻击标准必须"跟随市场"

- 资金攻击判定应基于：
  - 单票内的 ratio 与 price_strength；
  - 当日市场/板块分位数（如位于前 1% / 前 3%）。
- 禁止长期依赖固定绝对值作为唯一标准（例如"净流入 1 亿 + 涨 5% 就一定是强攻击"）。

### 4.3 三轴决策必须同时看完再下结论

- 在对任何个股给出系统性判断前，必须同时检查：
  - 行业/板块风向（WindFilter / SectorResonance）；
  - 资金行为（TrueAttack / 资金攻击评分）；
  - 陷阱风险（TrapDetector / TAIL RALLY 等）。
- 禁止只通过单一轴（如仅形态或仅资金）给出全局结论。

---

## 5. 流程与验证铁律

### 5.1 热门样本回测优先

- 对重要策略和过滤改动，必须先在热门样本集上验证，包括但不限于：
  - 顽主榜单真实区间（2026-02-04 至 2026-02-13）的 TopList；
  - 网宿科技（300017.SZ）及其他典型个股案例。
- 未在热门样本集上做回测对照的改动，不得直接推广至全市场扫描或实盘。

### 5.2 决策表述必须是"条件结论"

- 系统输出建议必须采用条件形式，例如：
  - "若资金持续净流入且无陷阱 → 倾向继续持有；
     若资金转为净流出或出现 TRAP → 倾向减仓/退出。"
- 禁止出现"必须买入/应该卖出"此类绝对化指令。

### 5.3 禁止在代码和日志中写未经验证的故事

- 日志和报告应基于可验证字段（时间、价格、成交量、ratio、分位数、事件标记），避免使用未经验证的叙述性描述（如随意定义"节前最后交易日"等）。
- 如需描述市场情绪，应尽量关联到可量化指标（涨跌比例、成交额变化等）。

---

## 6. 探索与知识管理铁律

### 6.1 探索线程必须有 CASE 文档

- 任意中长期探索（策略、新数据源、架构改造等）必须创建对应 CASE 文档，存于：
  - `docs/dev/exploration_log/`
- CASE 文档须包含：
  - 背景与目标；
  - Owner 与 Status；
  - 分日期的进展记录；
  - 未解决问题列表；
  - 相关代码与数据链接。

### 6.2 禁止只在对话和临时脚本中留痕

- 重要探索和结论不得仅停留在聊天记录、临时 .py 或 .ipynb 文件中。
- 若 CASE 未更新超过合理周期，Owner 必须将其 Status 设为 FROZEN 或 CLOSED，并记录原因。

---

## 7. 数字与承诺使用规范

### 7.1 数字必须可溯源

- 在文档或报告中引用具体数量（如"X 处硬编码"、"Y 条铁律"）时，必须附：
  - 对应审计文件路径；或
  - 自动扫描脚本的输出。
- 否则只能用定性表述（如"存在大量硬编码"）。

### 7.2 禁止空口许诺

- 禁止在未有明确设计与排期前，给出类似"本月完成重构"之类的时间承诺。
- 策略/模块的状态应标注为：
  - 已实现（包含代码和回测结果）；
  - 规划中（有设计文档）；
  - 构想（仅在讨论阶段）。

---

本铁律文件由 CTO 发布和维护。  
任何变更须通过正式评审，并在版本控制中保留历史。