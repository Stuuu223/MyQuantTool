# 盘前自动执行脚本使用指南

## 📋 概述

`start_premarket.bat` / `start_premarket.ps1` 是盘前自动执行脚本，可以定时完成以下任务：

| 时间 | 任务 | 说明 |
|------|------|------|
| 08:00 | 数据预热 | 计算全市场均线数据 |
| 09:15 | QMT环境检查 | 检查QMT客户端状态 |
| 09:25 | 采集竞价数据 | 采集09:25竞价快照 |
| 09:30 | 启动监控 | 启动CLI监控终端 |

---

## 🚀 快速开始

### 方法1：Windows批处理（推荐）

```batch
# 定时模式（等待触发时间）
start_premarket.bat

# 立即执行所有任务（测试用）
start_premarket.bat immediate

# 只执行指定任务
start_premarket.bat warmup   # 数据预热
start_premarket.bat check    # QMT检查
start_premarket.bat auction  # 竞价采集
start_premarket.bat monitor  # 启动监控
```

### 方法2：PowerShell脚本

```powershell
# 定时模式
.\start_premarket.ps1

# 立即执行
.\start_premarket.ps1 -Immediate

# 只执行指定任务
.\start_premarket.ps1 -Once warmup
```

### 方法3：Python直接运行

```bash
# 定时模式
E:\MyQuantTool\venv_qmt\Scripts\python.exe tasks/scheduled_premarket.py

# 立即执行
E:\MyQuantTool\venv_qmt\Scripts\python.exe tasks/scheduled_premarket.py --immediate

# 指定日期
E:\MyQuantTool\venv_qmt\Scripts\python.exe tasks/scheduled_premarket.py --date 2026-02-12
```

---

## ⏰ 定时设置

### 手动定时（简单）

直接在对应时间点执行脚本：
- 08:00 启动：等待到09:30会自动完成所有任务
- 08:30 启动：数据预热跳过，其他任务正常执行

### Windows任务计划程序（推荐）

#### 创建任务

1. 打开"任务计划程序"
2. 点击"创建基本任务"
3. **触发器**：每天 07:50（提前10分钟启动）
4. **操作**：启动程序
   - 程序：`E:\MyQuantTool\start_premarket.bat`
5. 完成

#### 高级设置

如果需要在用户未登录时运行：
1. 创建任务时选择"只在用户登录时运行"→"不管用户是否登录都要运行"
2. 配置为最高权限运行
3. 输入Windows账号密码

---

## 📝 执行日志

脚本执行时会输出详细日志：

```
========================================
  MyQuantTool 盘前自动执行
========================================
📅 交易日期: 2026-02-12
🐍 Python环境: E:\MyQuantTool\venv_qmt\Scripts\python.exe

⏰ [08:00] 数据预热 - 已设置
⏰ [09:15] QMT环境检查 - 已设置
⏰ [09:25] 采集竞价数据 - 已设置
⏰ [09:30] 启动监控 - 已设置

✅ 所有定时任务已设置完成

📅 下一个任务: 2026-02-12 09:15:00
⏳ 等待中... (按 Ctrl+C 退出)
```

---

## 🎯 单独执行任务

### 数据预热

```batch
start_premarket.bat warmup
```

**输出示例**：
```
🌅 [08:00] 开始执行数据预热...
--------------------------------------------------------------------------------
✅ 盘前数据预热成功！
📊 缓存信息:
  缓存版本: v1.0
  缓存日期: 2026-02-12
  股票数量: 5190
  是否已加载: True
```

### QMT环境检查

```batch
start_premarket.bat check
```

**输出示例**：
```
🔍 [09:15] 开始检查QMT环境...
--------------------------------------------------------------------------------
======================================================================
QMT真实环境检查
======================================================================

1. 检查股票列表获取...
✅ 成功获取股票列表：5190 只

2. 检查历史K线数据...
✅ 成功获取历史K线数据

3. 检查实时行情...
✅ 成功获取实时行情
   lastPrice: 1504.33

======================================================================
检查完成
======================================================================
```

### 竞价采集

```batch
start_premarket.bat auction
```

**输出示例**：
```
📊 [09:25] 开始采集竞价数据...
--------------------------------------------------------------------------------
📈 批次 1/11 | 进度: 500/5190 (9.6%) | 速度: 1075股/秒
📈 批次 2/11 | 进度: 1000/5190 (19.3%) | 速度: 520股/秒
...
✅ 采集完成 - 耗时: 0.3分钟 - 总数: 5190, 成功: 5190, 失败: 0
```

---

## ⚠️ 重要提醒

### 1. QMT必须提前启动

**QMT客户端启动时间**：09:15之前

**检查方法**：
```batch
start_premarket.bat check
```

如果QMT未启动或未登录，脚本会报错。

### 2. 竞价采集仅一次机会

**采集时间**：09:25:00 ± 10秒

**错过处理**：
- 无法补采历史竞价数据
- 只能等下一个交易日

### 3. 监控终端需手动启动

**原因**：监控终端会持续运行，不应由脚本自动启动

**启动方法**：
```batch
python tools/cli_monitor.py
```

---

## 🔧 故障排查

### 问题1：虚拟环境不存在

**错误信息**：
```
[ERROR] 虚拟环境不存在: venv_qmt
```

**解决方法**：
```bash
cd E:\MyQuantTool
C:\Python310\python.exe -m venv venv_qmt
venv_qmt\Scripts\activate
pip install -r requirements.txt
```

### 问题2：QMT连接失败

**错误信息**：
```
❌ QMT环境检查失败，请检查QMT客户端
```

**解决方法**：
1. 启动QMT客户端
2. 登录账号
3. 确保"数据管理"中今日数据已下载

### 问题3：竞价采集失败

**错误信息**：
```
❌ 竞价数据采集失败
```

**可能原因**：
- QMT未启动
- 时间不对（非09:25）
- 网络问题

**解决方法**：
1. 检查QMT状态：`start_premarket.bat check`
2. 确认时间正确
3. 手动执行：`start_premarket.bat auction`

---

## 📊 完整流程示例

### 08:00 启动脚本

```batch
start_premarket.bat
```

### 08:00-09:30 自动执行

| 时间 | 执行的任务 | 状态 |
|------|-----------|------|
| 08:00 | 数据预热 | ✅ 自动完成 |
| 09:15 | QMT环境检查 | ✅ 自动完成 |
| 09:25 | 竞价采集 | ✅ 自动完成 |
| 09:30 | 启动监控 | ⚠️ 需手动启动 |

### 09:30 手动启动监控

```batch
python tools/cli_monitor.py
```

---

## 🎉 完成

所有任务完成后，系统将进入监控状态：

```
┌─ 时机斧 - 板块雷达 ──────────────────┐
│ 板块名称   Leaders   Breadth   状态   │
│ 半导体      5         45%       🔥共振  │
│ AI应用      4         38%       🔥共振  │
└──────────────────────────────────────┘
```

---

## 📚 相关文档

- [CTO审计优化报告](../docs/CTO_AUDIT_OPTIMIZATION.md)
- [竞价快照系统文档](../docs/phase3_week1_auction_system.md)
- [场景集成总结](../SCENARIO_INTEGRATION_SUMMARY.md)

---

**版本**：V1.0  
**更新日期**：2026-02-12  
**作者**：iFlow CLI