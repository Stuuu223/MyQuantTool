# 持续监控使用指南

## 📖 功能说明

持续监控模块实现了**第一阶段基础框架**，包含以下核心功能：

### 核心特性

1. **自动持续扫描**
   - 在交易时间内自动运行（9:25-15:00）
   - 每5分钟执行一次全市场扫描
   - 自动识别交易时间，非交易时间休眠

2. **智能状态指纹**
   - 每次扫描生成唯一的状态指纹
   - 指纹包含：机会池股票代码、风险评分、系统置信度、仓位限制
   - 使用MD5哈希算法确保指纹唯一性

3. **按需快照保存**
   - **仅在状态变化时保存快照**
   - 避免重复保存相同结果
   - 使用时间戳命名，避免覆盖历史快照

4. **实时日志输出**
   - 命令行实时显示扫描进度
   - 显示机会池TOP3股票
   - 统计累计保存快照次数

---

## 🚀 快速开始

### 方式一：使用启动脚本（推荐）

双击运行：
```
start_continuous_monitor.bat
```

### 方式二：命令行运行

```bash
python tasks/run_continuous_monitor.py
```

### 停止监控

在命令行中按 `Ctrl+C` 停止监控

---

## 🧪 测试验证

### 运行测试脚本

```bash
python test_continuous_monitor.py
```

测试内容包括：
- ✅ 状态指纹生成功能
- ✅ 指纹对比逻辑
- ✅ 真实扫描功能（可选）

---

## 📊 快照文件格式

快照保存在 `data/scan_results/` 目录，文件命名格式：

```
YYYY-MM-DD_HHMMSS_intraday.json
```

示例：`2026-02-06_093000_intraday.json`

### 快照结构

```json
{
  "scan_time": "2026-02-06T09:30:00.123456",
  "mode": "intraday",
  "state_signature": "788c6369e35c8a7a...",
  "state_changed": true,
  "summary": {
    "opportunities": 12,
    "watchlist": 11,
    "blacklist": 0
  },
  "results": {
    "mode": "FULL",
    "evidence_matrix": {...},
    "position_limit": 0.74,
    "confidence": 0.925,
    "risk_reason": "...",
    "risk_warnings": [],
    "opportunities": [...],
    "watchlist": [...],
    "blacklist": [...]
  }
}
```

---

## ⚙️ 配置参数

### 修改扫描间隔

编辑 `tasks/run_continuous_monitor.py`：

```python
# 第274行
monitor = ContinuousMonitor(scan_interval=300)  # 300秒 = 5分钟
```

可调整的间隔：
- `60` 秒 = 1分钟（高频率，适合事件驱动）
- `300` 秒 = 5分钟（推荐，平衡性能和实时性）
- `600` 秒 = 10分钟（低频率，节省资源）

---

## 🎯 状态指纹包含的字段

状态指纹基于以下信息生成：

1. **机会池股票代码**（排序后）
2. **每只机会股的风险评分**（四舍五入到2位小数）
3. **系统置信度**（四舍五入到1位小数）
4. **推荐最大仓位**（四舍五入到1位小数）
5. **池子大小**（机会池/观察池/黑名单数量）

**触发状态变化的条件**：
- 机会池股票代码变化（新增或删除）
- 风险评分变化（>0.01）
- 系统置信度变化（>0.1）
- 推荐最大仓位变化（>0.1）
- 池子大小变化

---

## 📈 监控输出示例

```
================================================================================
📊 扫描完成 #1 - 09:30:00
================================================================================
✅ 机会池: 12 只
⚠️  观察池: 11 只
❌ 黑名单: 0 只
📈 系统置信度: 92.5%
💰 今日建议最大总仓位: 74.0%
🎯 累计保存快照: 1 次

🔥 机会池 TOP3:
   000592.SZ - 风险: 0.00 - 类型: HOT_MONEY
   601869.SH - 风险: 0.20 - 类型: INSTITUTIONAL 诱多信号: 长期流出+单日巨量
   300502.SZ - 风险: 0.40 - 类型: HOT_MONEY
================================================================================
```

---

## 🔧 故障排查

### 问题1：扫描失败

**症状**：日志显示 "❌ 扫描失败"

**可能原因**：
- QMT未启动
- 网络连接问题
- AkShare API限流

**解决方法**：
1. 确保QMT客户端已启动
2. 检查网络连接
3. 等待几分钟后重试

### 问题2：状态未变化但保存了快照

**症状**：日志显示 "💾 [状态变化] 快照已保存"，但实际状态未变化

**可能原因**：
- 风险评分微小变化（<0.01）
- 系统置信度微小变化（<0.1）

**解决方法**：
- 这是正常行为，状态指纹对微小变化敏感
- 如需调整敏感度，修改 `generate_state_signature` 方法中的四舍五入逻辑

### 问题3：监控器在非交易时间不停止

**症状**：监控器在收盘后继续运行

**可能原因**：
- 系统时间不准确
- 时区设置错误

**解决方法**：
1. 检查系统时间是否正确
2. 确认时区为Asia/Shanghai
3. 手动按Ctrl+C停止

---

## 📝 下一步计划

### 第二阶段：事件驱动触发

当前实现的是固定间隔扫描（每5分钟）。下一阶段将实现：

1. **集合竞价战法事件触发**
   - 9:15-9:25期间检测弱转强信号
   - 检测一字板扩散
   - 只在有事件时触发扫描

2. **半路战法事件触发**
   - 检测20cm标的的平台突破
   - 检测分时均线支撑
   - 只在有突破时触发扫描

3. **低吸战法事件触发**
   - 检测5日均线回踩
   - 检测分时均线低吸
   - 只在回踩时触发扫描

4. **龙头战法事件触发**
   - 检测板块龙头
   - 检测竞价弱转强
   - 只在龙头启动时触发扫描

---

## 📚 相关文档

- [全市场扫描器文档](FULL_MARKET_SCANNER_GUIDE.md)
- [用户指南](../docs/user-guide/README.md)
- [开发文档](../docs/dev/README.md)

---

## 🤝 反馈与建议

如有问题或建议，请通过以下方式反馈：

1. 提交Issue到GitHub
2. 联系开发团队
3. 查看项目文档

---

**版本**: V1.0
**最后更新**: 2026-02-06
**作者**: iFlow CLI