---
version: V12.1.0
updated: 2026-02-15
scope: logic/full_market_scanner.py, tasks/run_event_driven_monitor.py
author: MyQuantTool Team
---

# 监控系统使用指南

## 📖 系统概述

MyQuantTool 监控系统包含三大核心模块，实现从市场扫描到事件捕捉再到数据记录的完整闭环：

### 三大模块

1. **持续监控** - 固定间隔全市场扫描，适合新手学习测试
2. **事件驱动监控** - 智能事件检测触发扫描，适合高级用户实盘交易
3. **事件记录器** - 自动记录所有事件，支持统计分析

### 核心扫描引擎

**完美三漏斗全市场扫描系统** - 自动化的A股市场机会发现系统
- 从全市场5000+只股票中精准识别交易机会
- 三层逐级筛选：技术面 → 资金流 → 陷阱检测
- 自动分类：机会池 / 观察池 / 黑名单

---

## 一、完美三漏斗全市场扫描系统

### 1.1 系统简介

**完美三漏斗全市场扫描系统（Perfect Triple Funnel Market Scanner）**是一套自动化的A股市场机会发现系统，通过三层逐级筛选，从全市场5000+只股票中精准识别真正的交易机会。

### 核心优势

1. **全自动化** - 无需人工介入，一键扫描全市场
2. **三层漏斗** - 技术面 → 资金流 → 陷阱检测，层层把关
3. **精准分类** - 机会池/观察池/黑名单，清晰标注
4. **充分复用** - 集成TrapDetector、CapitalClassifier等成熟模块
5. **高效执行** - QMT分批+限速，2-3分钟完成全市场扫描

### 1.2 架构设计

#### 数据流全景

```
┌─────────────────────────────────────────────────┐
│   QMT 全市场股票池（5187 只）                      │
└──────────────┬──────────────────────────────────┘
               ↓
┌──────────────────────────────────────────────────┐
│  分批获取（6 批 × 1000 只，耗时 0.5 秒）            │
│  - 获取字段：lastPrice, volume, amount, pct_chg  │
└──────────────┬───────────────────────────────────┘
               ↓
╔══════════════════════════════════════════════════╗
║  Level 1: 技术面粗筛（本地计算，无 API 调用）        ║
╠══════════════════════════════════════════════════╣
║  条件：                                           ║
║  1. |涨跌幅| > 3%（异动票）                        ║
║  2. 成交额 > 3000 万（流动性要求）                  ║
║  3. 换手率 > 2%（活跃度）                          ║
║  4. 剔除：ST、退市、科创板（风控）                   ║
╚══════════════┬═══════════════════════════════════╝
               ↓
        300-500 只候选（压缩到 6-10%）
               ↓
╔══════════════════════════════════════════════════╗
║  Level 2: 资金流向深度分析（AkShare，限速18/分钟）  ║
╠══════════════════════════════════════════════════╣
║  每只股票单独请求：                                 ║
║  1. 主力净流入 > 0（必须有机构买入）                ║
║  2. 超大单占比 > 30%（非散户行情）                  ║
║  3. 近 3 日资金流向趋势（连续性判断）                ║
╚══════════════┬═══════════════════════════════════╝
               ↓
         50-100 只精选（再压缩到 1-2%）
               ↓
╔══════════════════════════════════════════════════╗
║  Level 3: 坑 vs 机会分类（TrapDetector + CapitalClassifier）║
╠══════════════════════════════════════════════════╣
║  调用现有组件：                                     ║
║  1. TrapDetector（诱多检测）                       ║
║     - 单日暴量 + 隔日反手                          ║
║     - 长期流出 + 单日巨量（游资突袭）                ║
║  2. CapitalClassifier（资金性质）                  ║
║     - 机构长线 / 游资短炒 / 散户接盘                ║
║  3. 风险评分（综合判断）                            ║
║     - >0.8: AVOID（远离）                         ║
║     - 0.6-0.8: WATCH（观察）                      ║
║     - <0.6: CONSIDER（可考虑）                    ║
╚══════════════┬═══════════════════════════════════╝
               ↓
┌──────────────────────────────────────────────────┐
│  最终输出：                                        │
│  - 机会池（10-20 只）：低风险 + 主力建仓            │
│  - 观察池（20-30 只）：有潜力但需验证               │
│  - 黑名单（20-30 只）：明显诱多陷阱                 │
└──────────────────────────────────────────────────┘
```

### 1.3 快速开始

#### 环境准备

确保已安装以下依赖：

```bash
pip install xtquant akshare pandas
```

#### 配置文件

编辑 `config/market_scan_config.json`，调整筛选阈值：

```json
{
  "level1": {
    "pct_chg_min": 3.0,       // 涨跌幅最小值（%）
    "amount_min": 30000000,   // 成交额最小值（元）
    "turnover_min": 2.0       // 换手率最小值（%）
  },
  "level2": {
    "main_inflow_min": 5000000,  // 主力流入最小值（元）
    "super_ratio_min": 0.3       // 超大单占比
  },
  "level3": {
    "risk_score_max": 0.6     // 风险评分上限
  }
}
```

#### 运行扫描

```bash
# 盘前扫描（9:00 前）
python tasks/run_full_market_scan.py --mode premarket

# 盘中扫描（交易时间）
python tasks/run_full_market_scan.py --mode intraday

# 盘后复盘（15:00 后）
python tasks/run_full_market_scan.py --mode postmarket
```

#### 查看结果

扫描结果保存在 `data/scan_results/` 目录下：

```
data/scan_results/
├── 2026-02-05_premarket.json   # 盘前结果
├── 2026-02-05_intraday.json    # 盘中结果
└── 2026-02-05_postmarket.json  # 盘后结果
```

### 1.4 输出结果详解

#### JSON 结构

```json
{
  "scan_time": "2026-02-05T09:00:00",
  "mode": "premarket",
  "summary": {
    "opportunities": 18,
    "watchlist": 29,
    "blacklist": 20
  },
  "results": {
    "opportunities": [
      {
        "code": "600519.SH",
        "code_6digit": "600519",
        "risk_score": 0.23,
        "trap_signals": [],
        "capital_type": "机构长线",
        "flow_data": {
          "main_net_inflow": 12500000,
          "super_ratio": 0.45
        },
        "scan_time": "2026-02-05T09:15:23"
      }
    ],
    "watchlist": [...],
    "blacklist": [...]
  }
}
```

#### 字段说明

| 字段 | 说明 | 示例 |
|------|------|------|
| `code` | QMT格式股票代码 | `600519.SH` |
| `code_6digit` | 6位代码（AkShare格式） | `600519` |
| `risk_score` | 风险评分（0-1，越高越危险） | `0.23` |
| `trap_signals` | 诱多信号列表 | `["单日暴量+隔日反手"]` |
| `capital_type` | 资金性质 | `机构长线` / `游资短炒` / `散户接盘` |
| `flow_data.main_net_inflow` | 主力净流入（元） | `12500000` |
| `flow_data.super_ratio` | 超大单占比 | `0.45` |

### 1.5 使用场景

#### 场景 1: 盘前快速选股（推荐）

**时间点：** 每天 8:30-9:00

**目的：** 在开盘前筛选出今日值得关注的股票

```bash
python tasks/run_full_market_scan.py --mode premarket
```

**预期输出：**
- 机会池：10-20 只（今日可重点关注）
- 观察池：20-30 只（盘中跟踪验证）
- 黑名单：20-30 只（今日避开）

**后续操作：**
1. 将机会池加入自选股
2. 开盘后用 `triple_funnel_scanner` 做实时监控
3. 符合买点即可入场

#### 场景 2: 盘中动态更新

**时间点：** 10:30、13:30（盘中两次）

**目的：** 捕捉盘中新出现的异动股

```bash
python tasks/run_full_market_scan.py --mode intraday
```

**预期输出：**
- 机会池可能增加（盘中启动的股票）
- 黑名单可能增加（盘中诱多的股票）

#### 场景 3: 盘后复盘总结

**时间点：** 15:30-16:00

**目的：** 复盘今日市场全貌，为明日做准备

```bash
python tasks/run_full_market_scan.py --mode postmarket
```

**预期输出：**
- 今日强势股汇总
- 今日诱多陷阱汇总
- 明日潜在机会预判

### 1.6 进阶用法

#### 自定义筛选条件

修改 `config/market_scan_config.json`：

```json
{
  "level1": {
    "pct_chg_min": 5.0,       // 提高到5%，只看强势股
    "amount_min": 50000000,   // 提高到5000万，只看大盘股
    "turnover_min": 3.0       // 提高到3%，只看活跃股
  }
}
```

#### 集成到自动化流程

```python
from logic.full_market_scanner import FullMarketScanner

# 在定时任务中调用
scanner = FullMarketScanner()
results = scanner.scan_market(mode='premarket')

# 自动发送机会池到邮件/微信
opportunities = results['opportunities']
for stock in opportunities:
    send_alert(stock['code'], stock['risk_score'])
```

### 1.7 性能优化

#### 当前性能指标

- **Level 1**: 5187 只 → 300-500 只，耗时 ~0.5 秒
- **Level 2**: 300-500 只 → 50-100 只，耗时 ~60 秒（受限于AkShare限速）
- **Level 3**: 50-100 只 → 最终分类，耗时 ~30 秒
- **总耗时**: 90-120 秒（1.5-2分钟）

#### 优化建议

1. **Level 2 并行化** - 使用多线程+限速队列，缩短到 30 秒
2. **缓存资金数据** - 5 分钟内重复请求直接读缓存
3. **增量扫描** - 盘中模式只扫新增异动股

---

## 二、持续监控模块

### 2.1 功能说明

持续监控模块实现了**固定间隔扫描**，适合新手学习测试。

### 核心特性

1. **自动持续扫描**
   - 在交易时间内自动运行（9:25-15:00）
   - 每5分钟执行一次全市场扫描
   - 自动识别交易时间，非交易时间休眠

2. **智能状态指纹**
   - 每次扫描生成唯一的状态指纹
   - 指纹包含：机会池股票代码、风险评分、系统置信度、仓位限制
   - 使用MD5哈希算法确保指纹唯一性

3. **按需快照保存**
   - **仅在状态变化时保存快照**
   - 避免重复保存相同结果
   - 使用时间戳命名，避免覆盖历史快照

4. **实时日志输出**
   - 命令行实时显示扫描进度
   - 显示机会池TOP3股票
   - 统计累计保存快照次数

### 2.2 快速开始

#### 方式一：使用启动脚本（推荐）

双击运行：
```
start_continuous_monitor.bat
```

#### 方式二：命令行运行

```bash
python tasks/run_continuous_monitor.py
```

#### 停止监控

在命令行中按 `Ctrl+C` 停止监控

### 2.3 测试验证

运行测试脚本：

```bash
python test_continuous_monitor.py
```

测试内容包括：
- ✅ 状态指纹生成功能
- ✅ 指纹对比逻辑
- ✅ 真实扫描功能（可选）

### 2.4 快照文件格式

快照保存在 `data/scan_results/` 目录，文件命名格式：

```
YYYY-MM-DD_HHMMSS_intraday.json
```

示例：`2026-02-06_093000_intraday.json`

#### 快照结构

```json
{
  "scan_time": "2026-02-06T09:30:00.123456",
  "mode": "intraday",
  "state_signature": "788c6369e35c8a7a...",
  "state_changed": true,
  "summary": {
    "opportunities": 12,
    "watchlist": 11,
    "blacklist": 0
  },
  "results": {
    "mode": "FULL",
    "evidence_matrix": {...},
    "position_limit": 0.74,
    "confidence": 0.925,
    "risk_reason": "...",
    "risk_warnings": [],
    "opportunities": [...],
    "watchlist": [...],
    "blacklist": [...]
  }
}
```

### 2.5 配置参数

#### 修改扫描间隔

编辑 `tasks/run_continuous_monitor.py`：

```python
# 第274行
monitor = ContinuousMonitor(scan_interval=300)  # 300秒 = 5分钟
```

可调整的间隔：
- `60` 秒 = 1分钟（高频率，适合事件驱动）
- `300` 秒 = 5分钟（推荐，平衡性能和实时性）
- `600` 秒 = 10分钟（低频率，节省资源）

### 2.6 状态指纹说明

状态指纹基于以下信息生成：

1. **机会池股票代码**（排序后）
2. **每只机会股的风险评分**（四舍五入到2位小数）
3. **系统置信度**（四舍五入到1位小数）
4. **推荐最大仓位**（四舍五入到1位小数）
5. **池子大小**（机会池/观察池/黑名单数量）

**触发状态变化的条件**：
- 机会池股票代码变化（新增或删除）
- 风险评分变化（>0.01）
- 系统置信度变化（>0.1）
- 推荐最大仓位变化（>0.1）
- 池子大小变化

### 2.7 监控输出示例

```
================================================================================
📊 扫描完成 #1 - 09:30:00
================================================================================
✅ 机会池: 12 只
⚠️  观察池: 11 只
❌ 黑名单: 0 只
📈 系统置信度: 92.5%
💰 今日建议最大总仓位: 74.0%
🎯 累计保存快照: 1 次

🔥 机会池 TOP3:
   000592.SZ - 风险: 0.00 - 类型: HOT_MONEY
   601869.SH - 风险: 0.20 - 类型: INSTITUTIONAL 诱多信号: 长期流出+单日巨量
   300502.SZ - 风险: 0.40 - 类型: HOT_MONEY
================================================================================
```

---

## 三、事件驱动监控模块

### 3.1 功能说明

事件驱动监控模块实现了**智能事件触发扫描**，适合高级用户实盘交易。

### 核心特性

1. **双模式支持**
   - **固定间隔模式**：每N分钟执行一次全市场扫描（新手推荐）
   - **事件驱动模式**：只在检测到事件时触发扫描（高级用户推荐）

2. **四大战法事件检测**
   - 集合竞价战法：弱转强、一字板扩散
   - 半路战法：平台突破
   - 低吸战法：5日均线回踩、分时均线低吸
   - 龙头战法：板块龙头、竞价弱转强、日内加速

3. **智能状态指纹**
   - 每次扫描生成唯一的状态指纹
   - 指纹包含：机会池股票代码、风险评分、系统置信度、仓位限制
   - 使用MD5哈希算法确保指纹唯一性

4. **按需快照保存**
   - **仅在状态变化时保存快照**
   - 避免重复保存相同结果
   - 使用时间戳命名，避免覆盖历史快照

5. **QMT Tick实时监控**
   - 使用QMT API订阅指定股票的Tick数据
   - 维护每只股票的"上一刻状态"
   - 实时检测价量事件

### 3.2 快速开始

#### 方式一：固定间隔模式（推荐新手）

双击运行：
```
start_event_driven_monitor.bat fixed
```

或者命令行：
```bash
python tasks/run_event_driven_monitor.py --mode fixed_interval
```

**特点**：
- 简单易用，无需配置
- 每5分钟扫描一次
- 适合学习和测试

#### 方式二：事件驱动模式（推荐高级用户）

命令行：
```bash
python tasks/run_event_driven_monitor.py --mode event_driven --stocks 000001.SZ 000002.SZ 300502.SZ
```

**特点**：
- 高效节能，只在有事件时扫描
- 需要指定监控股票列表
- 适合实盘交易

#### 停止监控

在命令行中按 `Ctrl+C`

### 3.3 测试验证

运行测试脚本：

```bash
python test_event_driven.py
```

测试内容包括：
- ✅ 事件检测器导入测试
- ✅ 事件管理器测试
- ✅ QMT Tick监控器测试
- ✅ 事件驱动监控器测试
- ✅ 事件触发测试

### 3.4 事件类型说明

#### 1. 集合竞价战法事件

##### OPENING_WEAK_TO_STRONG（竞价弱转强）

**触发条件**：
- 昨日：收盘涨幅 < 3%，或收阴线
- 今日竞价：高开幅度 ≥ 5%，竞价量比 ≥ 1.5

**示例**：
```
🔔 检测到事件: 000592.SZ - 竞价弱转强：高开6.00%，量比2.00
```

##### OPENING_THEME_SPREAD（一字板扩散）

**触发条件**：
- 当前票：竞价涨幅 ≥ 9.9%，封单金额 ≥ 流通盘市值的 5%
- 同题材：未封死涨停，但高开 ≥ 3%，竞价量比 ≥ 1.2

**示例**：
```
🔔 检测到事件: 300502.SZ - 一字板扩散：竞价涨幅10.50%，封单6.20%
```

#### 2. 半路战法事件

##### HALFWAY_BREAKOUT（平台突破）

**触发条件**：
- 涨幅区间：20cm标的（10%-19.5%）或 10cm标的（5%-9.5%）
- 过去30-60分钟有平台（振幅 < 3%）
- 突破平台高点 ≥ 1%
- 突破成交量 ≥ 平台期平均量的1.5倍

**示例**：
```
🔔 检测到事件: 300502.SZ - 半路平台突破（20cm）：涨幅12.50%，突破1.20%，量比1.80
```

#### 3. 低吸战法事件

##### DIP_BUY_CANDIDATE（低吸候选）

**触发条件（5日均线低吸）**：
- 日线趋势：MA5 > MA10 > MA20（多头排列）
- 盘中价格：回踩到 MA5 下方 0%-2%
- 成交量萎缩：当日量 ≤ 昨日量的 70%

**触发条件（分时均线低吸）**：
- 分时均线多头排列
- 价格回落到分时均线下方 1.5%-2.5%
- 近期成交量 ≤ 早盘高峰的 60%
- 价格重新站上均线之上（突破 0.5%）

**示例**：
```
🔔 检测到事件: 000592.SZ - 5日均线低吸：回踩1.50%，缩量65.0%
```

#### 4. 龙头战法事件

##### LEADER_CANDIDATE（龙头候选）

**触发条件（板块龙头）**：
- 同板块内：当日涨幅 = 板块内第一（或 Top3 且差距 < 1%）
- 且涨幅 ≥ 5%

**触发条件（竞价弱转强）**：
- 昨日：收盘涨幅 < 3%（弱势或震荡）
- 今日 9:25 后：高开幅度 ≥ 5%，竞价量比 ≥ 1.5

**触发条件（日内加速）**：
- 最近 5-10 分钟：价格突破当日前高（或最近 60 分钟平台高点）
- 且最近 5 分钟成交额 ≥ 前 5 分钟的 1.5 倍

**示例**：
```
🔔 检测到事件: 300502.SZ - 板块龙头候选：涨幅8.50%，板块排名第1
```

### 3.5 配置参数

#### 修改扫描间隔

编辑命令行参数：

```bash
python tasks/run_event_driven_monitor.py --mode fixed_interval --interval 300
```

可调整的间隔：
- `60` 秒 = 1分钟（高频率）
- `300` 秒 = 5分钟（推荐）
- `600` 秒 = 10分钟（低频率）

#### 修改监控股票列表

在事件驱动模式下，指定要监控的股票：

```bash
python tasks/run_event_driven_monitor.py --mode event_driven --stocks 000001.SZ 000002.SZ 300502.SZ
```

#### 修改事件冷却时间

编辑 `logic/event_detector.py` 第72行：

```python
self.cooldown_seconds = 60  # 冷却时间（秒）
```

### 3.6 监控输出示例

#### 固定间隔模式

```
================================================================================
📊 扫描完成 #1 - 09:30:00
================================================================================
✅ 机会池: 12 只
⚠️  观察池: 11 只
❌ 黑名单: 0 只
📈 系统置信度: 92.5%
💰 今日建议最大总仓位: 74.0%
🎯 累计保存快照: 1 次
🔔 累计检测事件: 0 次

🔥 机会池 TOP3:
   000592.SZ - 风险: 0.00 - 类型: HOT_MONEY
   601869.SH - 风险: 0.20 - 类型: INSTITUTIONAL
   300502.SZ - 风险: 0.40 - 类型: HOT_MONEY
================================================================================
```

#### 事件驱动模式

```
💓 监控中... (累计事件: 0)
💓 监控中... (累计事件: 0)
🔔 检测到事件: 300502.SZ - 半路平台突破（20cm）：涨幅12.50%，突破1.20%，量比1.80
🔥 事件触发扫描！
--------------------------------------------------------------------------------
🔍 开始扫描 #1
...
```

### 3.7 与持续监控对比

| 特性 | 持续监控（固定间隔） | 事件驱动监控 |
|------|---------------------|--------------|
| 扫描方式 | 每5分钟扫描一次 | 只在检测到事件时扫描 |
| 资源消耗 | 较高 | 较低 |
| 实时性 | 一般 | 高 |
| 配置难度 | 简单 | 中等 |
| 适用场景 | 学习测试 | 实盘交易 |

---

## 四、事件记录器

### 4.1 功能说明

事件记录器可以自动记录所有检测到的事件，并支持后续更新和统计分析。

### 核心特性

1. **自动记录**：检测到事件时自动记录到数据库
2. **后续更新**：支持更新收盘价、次日开盘、3天表现等数据
3. **统计分析**：自动计算胜率、平均盈利/亏损等指标
4. **表格导出**：一键导出为Excel/CSV表格

### 4.2 使用方法

#### 1. 自动记录（无需手动操作）

事件会在检测到时自动记录到数据库，无需手动操作。

当运行事件驱动监控器时，检测到的事件会自动记录：
```bash
python tasks/run_event_driven_monitor.py --mode fixed_interval
```

日志会显示：
```
🔔 检测到事件: 000592.SZ - 竞价弱转强：高开6.00%，量比2.00
💾 事件已记录到数据库 (ID: 5)
```

#### 2. 导出事件记录

##### 方式一：使用批处理文件（推荐）
```bash
export_records.bat
```

##### 方式二：使用Python脚本
```bash
python export_event_records.py
```

##### 输出文件
- `data/event_records.xlsx` - Excel表格
- `data/event_records.csv` - CSV表格

### 4.3 表格字段说明

| 字段 | 说明 | 示例 |
|------|------|------|
| 时间 | 事件触发时间 | 2026-02-06 09:25:00 |
| 股票代码 | 股票代码 | 000592.SZ |
| 事件类型 | 事件类型 | opening_weak_to_strong |
| 事件描述 | 事件描述 | 竞价弱转强：高开6.00%，量比2.00 |
| 置信度 | 事件置信度 | 0.85 |
| 触发条件 | 触发条件（JSON） | {"gap_pct": 0.06, "volume_ratio": 2.0} |
| 昨收价 | 昨日收盘价 | 10.00 |
| 开盘价 | 开盘价 | 10.60 |
| 当前价 | 当前价 | 10.60 |
| 收盘价 | 当日收盘价 | 10.81 |
| 收盘涨幅 | 当日收盘涨幅 | 0.0812 |
| 次日开盘 | 次日开盘价 | 10.92 |
| 次日开盘涨幅 | 次日开盘涨幅 | 0.0918 |
| 3天最大涨幅 | 3天内最大涨幅 | 0.15 |
| 3天最大跌幅 | 3天内最大跌幅 | -0.03 |
| 是否赚钱 | 是否赚钱（3天内） | TRUE |
| 盈利金额 | 盈利金额 | 15000 |
| 备注 | 备注 | - |

### 4.4 统计分析

事件记录器会自动生成统计信息：

```
================================================================================
📊 事件记录统计
================================================================================
总记录数: 8

按事件类型统计:
   dip_buy_candidate: 2 次
   halfway_breakout: 2 次
   leader_candidate: 2 次
   opening_weak_to_strong: 2 次

盈利统计:
   盈利次数: 4
   亏损次数: 4
   平均盈利: 15000.00
   平均亏损: -5000.00
   胜率: 50.00%
================================================================================
```

### 4.5 查询和筛选

#### 按事件类型筛选

```python
from logic.event_recorder import get_event_recorder

recorder = get_event_recorder()
records = recorder.get_records(event_type='opening_weak_to_strong')
```

#### 按股票代码筛选

```python
records = recorder.get_records(stock_code='000592.SZ')
```

#### 按日期筛选

```python
records = recorder.get_records(
    start_date='2026-02-01',
    end_date='2026-02-28'
)
```

### 4.6 手动更新数据

如果需要手动更新后续数据，可以使用以下方法：

#### 更新收盘价

```python
recorder.update_day_close(record_id=5, day_close=10.81)
```

#### 更新次日开盘

```python
recorder.update_next_day_open(record_id=5, next_day_open=10.92)
```

#### 更新3天表现

```python
recorder.update_3days_performance(
    record_id=5,
    max_gain=0.15,
    max_loss=-0.03,
    is_profitable=True,
    profit_amount=15000
)
```

### 4.7 实盘使用建议

#### 每天收盘后

1. **导出事件记录**
   ```bash
   export_records.bat
   ```

2. **打开Excel表格**
   - 打开 `data/event_records.xlsx`
   - 查看当天触发的事件

3. **更新收盘价**
   - 使用Excel筛选当天的事件
   - 手动更新收盘价和收盘涨幅

4. **分析事件质量**
   - 统计每种事件的胜率
   - 计算平均收益
   - 识别高胜率事件

#### 每周复盘

1. **导出周报**
   - 筛选一周的事件
   - 更新所有后续数据

2. **统计分析**
   - 每种事件的胜率
   - 平均盈利/亏损
   - 最优事件类型

3. **调整参数**
   - 胜率低的事件：调严阈值
   - 触发少的事件：调宽阈值

### 4.8 高级功能

#### 自定义查询

```python
from logic.event_recorder import get_event_recorder

recorder = get_event_recorder()

# 查询最近10条竞价弱转强事件
records = recorder.get_records(
    event_type='opening_weak_to_strong',
    limit=10
)

# 查询指定股票的所有事件
records = recorder.get_records(
    stock_code='000592.SZ',
    limit=100
)
```

#### 导出特定数据

```python
# 只导出竞价弱转强事件
records = recorder.get_records(event_type='opening_weak_to_strong')

# 转换为DataFrame
import pandas as pd
data = [record.to_dict() for record in records]
df = pd.DataFrame(data)

# 自定义筛选
df_filtered = df[df['day_close_pct'] > 0.05]  # 只看收盘涨幅>5%的

# 导出
df_filtered.to_excel('filtered_events.xlsx', index=False)
```

---

## 五、故障排查

### 5.1 扫描失败

**症状**：日志显示 "❌ 扫描失败"

**可能原因**：
- QMT未启动
- 网络连接问题
- AkShare API限流

**解决方法**：
1. 确保QMT客户端已启动
2. 检查网络连接
3. 等待几分钟后重试

### 5.2 状态未变化但保存了快照

**症状**：日志显示 "💾 [状态变化] 快照已保存"，但实际状态未变化

**可能原因**：
- 风险评分微小变化（<0.01）
- 系统置信度微小变化（<0.1）

**解决方法**：
- 这是正常行为，状态指纹对微小变化敏感
- 如需调整敏感度，修改 `generate_state_signature` 方法中的四舍五入逻辑

### 5.3 监控器在非交易时间不停止

**症状**：监控器在收盘后继续运行

**可能原因**：
- 系统时间不准确
- 时区设置错误

**解决方法**：
1. 检查系统时间是否正确
2. 确认时区为Asia/Shanghai
3. 手动按Ctrl+C停止

### 5.4 QMT不可用

**症状**：日志显示 "QMT不可用"

**可能原因**：
- 未安装xtquant库
- QMT客户端未启动

**解决方法**：
1. 安装xtquant库：`pip install xtquant`
2. 启动QMT客户端
3. 使用固定间隔模式作为备选

### 5.5 事件未触发

**症状**：长时间没有检测到事件

**可能原因**：
- 监控股票列表为空
- 股票价格波动太小
- 事件检测器未启用

**解决方法**：
1. 检查监控股票列表是否正确
2. 使用固定间隔模式确保扫描正常运行
3. 检查事件检测器是否启用

### 5.6 扫描频繁触发

**症状**：事件频繁触发，扫描过于频繁

**可能原因**：
- 冷却时间设置过短
- 事件检测阈值过低

**解决方法**：
1. 增加冷却时间（默认60秒）
2. 调整事件检测阈值

### 5.7 Level 1 没有筛选出股票

**症状**：Level 1 一只股票都没筛出来

**可能原因**：
- 市场整体无异动（大盘平稳时正常）
- 筛选条件过严
- QMT 数据源问题

**解决方案**：
```json
{
  "level1": {
    "pct_chg_min": 2.0,  // 从3%降到2%
    "amount_min": 20000000  // 从3000万降到2000万
  }
}
```

### 5.8 Level 2 耗时过长

**症状**：Level 2 耗时过长

**原因**：AkShare 限速 18 次/分钟

**解决方案**：
- 提高 Level 1 筛选标准，减少进入 Level 2 的股票数量
- 使用缓存机制（开发中）

### 5.9 风险评分都很低，没有黑名单

**症状**：风险评分都很低，没有黑名单

**原因**：市场没有明显诱多行为

**解决方案**：这是好事！说明当前市场相对健康。

---

## 六、常见问题

### Q1: 数据库文件在哪里？

A: 数据库文件位于 `data/event_records.db`

### Q2: 如何备份数据？

A: 直接复制 `data/event_records.db` 文件即可

### Q3: 如何清空数据？

A: 删除 `data/event_records.db` 文件，系统会自动重新创建

### Q4: Excel导出失败怎么办？

A: 需要安装pandas和openpyxl：
```bash
pip install pandas openpyxl
```

### Q5: 如何分析数据？

A: 打开Excel表格，使用透视表、筛选、排序等功能进行分析

---

## 七、技术细节

### 7.1 风险评分算法

```python
def _calculate_risk_score(trap_result, capital_result):
    score = 0.0

    # 诱多信号权重
    if '单日暴量+隔日反手' in trap_signals:
        score += 0.4
    if '游资突袭' in trap_signals:
        score += 0.3
    if '长期流出+单日巨量' in trap_signals:
        score += 0.2

    # 资金性质权重
    if capital_type == '散户接盘':
        score += 0.3
    elif capital_type == '游资短炒':
        score += 0.2
    elif capital_type == '机构长线':
        score -= 0.1

    return min(max(score, 0.0), 1.0)
```

### 7.2 数据源优先级

| 数据类型 | 优先级 | 数据源 | 用途 |
|---------|--------|--------|------|
| 实时行情 | 1 | QMT | Level 1 粗筛 |
| 资金流向 | 2 | AkShare | Level 2 精筛 |
| 历史K线 | 3 | AkShare | Level 3 分析 |

---

## 八、更新日志

### v1.0.0 (2026-02-05)

- ✅ 全市场扫描系统初始版本发布
- ✅ 三层漏斗架构实现
- ✅ QMT + AkShare 数据源集成
- ✅ TrapDetector + CapitalClassifier 集成
- ✅ 三种运行模式（盘前/盘中/盘后）
- ✅ JSON 结果持久化

### v2.0.0 (2026-02-06)

- ✅ 事件驱动监控模块
- ✅ 四大战法事件检测
- ✅ 双模式支持（固定间隔/事件驱动）
- ✅ 事件记录器
- ✅ 统计分析功能
- ✅ Excel/CSV导出

---

## 九、后续规划

- [ ] Level 2 并行化优化（多线程）
- [ ] 资金数据缓存机制
- [ ] 增量扫描模式（盘中模式）
- [ ] Web UI 可视化界面
- [ ] 微信/邮件告警集成
- [ ] 历史扫描结果回测分析

---

## 十、相关文档

- [用户指南](../docs/user-guide/README.md)
- [开发文档](../docs/dev/README.md)
- [核心架构](../CORE_ARCHITECTURE.md)
- [项目架构](../PROJECT_ARCHITECTURE.md)

---

## 联系方式

如有问题或建议，请提交 Issue 到 GitHub 仓库。

---

**版本**: V2.0
**最后更新**: 2026-02-09
**作者**: iFlow CLI