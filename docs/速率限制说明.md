# API è¯·æ±‚é€Ÿç‡é™åˆ¶è¯´æ˜

## ğŸ“Š æ¦‚è¿°

ä¸ºäº†é˜²æ­¢é¢‘ç¹è¯·æ±‚å¯¼è‡´è¢«å°IPï¼Œæ‰€æœ‰å·¥å…·éƒ½å·²ç»é›†æˆäº†**é€Ÿç‡é™åˆ¶å™¨ï¼ˆRateLimiterï¼‰**ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

### 1. è‡ªåŠ¨é€Ÿç‡é™åˆ¶

- **æ¯åˆ†é’Ÿæœ€å¤š 20 æ¬¡è¯·æ±‚**
- **æ¯å°æ—¶æœ€å¤š 200 æ¬¡è¯·æ±‚**
- **æœ€å°è¯·æ±‚é—´éš” 3 ç§’**

### 2. æ™ºèƒ½é˜Ÿåˆ—ç®¡ç†

- è‡ªåŠ¨ç­‰å¾…ç›´åˆ°å¯ä»¥è¯·æ±‚
- å®æ—¶æ˜¾ç¤ºå‰©ä½™é…é¢
- è¯·æ±‚å†å²è®°å½•

### 3. å®‰å…¨ä¿æŠ¤

- å•ä¾‹æ¨¡å¼ï¼ˆå…¨å±€å…±äº«é€Ÿç‡é™åˆ¶å™¨ï¼‰
- çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨ Lockï¼‰
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å½•

## ğŸ“‹ ä½¿ç”¨æ–¹å¼

### æ–¹å¼1ï¼šè‡ªåŠ¨é™åˆ¶ï¼ˆæ¨èï¼‰

æ‰€æœ‰å·¥å…·éƒ½å·²ç»è‡ªåŠ¨é›†æˆäº†é€Ÿç‡é™åˆ¶ï¼Œæ— éœ€é¢å¤–é…ç½®ï¼š

```python
from stock_ai_tool import analyze_stock

# è‡ªåŠ¨åº”ç”¨é€Ÿç‡é™åˆ¶
result = analyze_stock('300997', 10, mode='full')
```

### æ–¹å¼2ï¼šæ‰¹é‡åˆ†æ

ä½¿ç”¨æ‰¹é‡åˆ†æå·¥å…·è‡ªåŠ¨å¤„ç†å¤šåªè‚¡ç¥¨ï¼š

```python
from batch_analyze import batch_analyze

stocks = ['300997', '301171', '600000', '000001']
results = batch_analyze(stocks, days=10, mode='full')
```

### æ–¹å¼3ï¼šæ‰‹åŠ¨æ§åˆ¶

å¦‚æœéœ€è¦æ‰‹åŠ¨æ§åˆ¶é€Ÿç‡é™åˆ¶ï¼š

```python
from logic.rate_limiter import get_rate_limiter

limiter = get_rate_limiter()

# æ£€æŸ¥æ˜¯å¦å¯ä»¥è¯·æ±‚
can_request, reason = limiter.can_request()
if not can_request:
    print(f"â³ {reason}")

# ç­‰å¾…ç›´åˆ°å¯ä»¥è¯·æ±‚
limiter.wait_if_needed()

# æ‰§è¡Œè¯·æ±‚
result = your_api_call()

# è®°å½•è¯·æ±‚
limiter.record_request()

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
limiter.print_stats()
```

## ğŸ“Š ç›‘æ§åŠŸèƒ½

### æŸ¥çœ‹å®æ—¶ç»Ÿè®¡

```python
from logic.rate_limiter import get_rate_limiter

limiter = get_rate_limiter()
stats = limiter.get_stats()

print(f"æœ€è¿‘1åˆ†é’Ÿ: {stats['recent_minute']}/{stats['max_per_minute']} æ¬¡")
print(f"æœ€è¿‘1å°æ—¶: {stats['recent_hour']}/{stats['max_per_hour']} æ¬¡")
print(f"å‰©ä½™é…é¢: {stats['remaining_minute']} (åˆ†é’Ÿ)")
```

### è¾“å‡ºç¤ºä¾‹

```
============================================================
ğŸ“Š RateLimiter ç»Ÿè®¡ä¿¡æ¯
============================================================
  æœ€è¿‘1åˆ†é’Ÿ: 6/20 æ¬¡
  æœ€è¿‘1å°æ—¶: 6/200 æ¬¡
  å‰©ä½™é…é¢: 14 (åˆ†é’Ÿ) | 194 (å°æ—¶)
  æœ€åè¯·æ±‚: 2026-02-02T17:29:15.153453
============================================================
```

## âš™ï¸ é…ç½®å‚æ•°

### é»˜è®¤é…ç½®

```python
RateLimiter(
    max_requests_per_minute=20,  # æ¯åˆ†é’Ÿæœ€å¤š20æ¬¡è¯·æ±‚
    max_requests_per_hour=200,   # æ¯å°æ—¶æœ€å¤š200æ¬¡è¯·æ±‚
    min_request_interval=3,       # æœ€å°è¯·æ±‚é—´éš”3ç§’
    enable_logging=True
)
```

### è‡ªå®šä¹‰é…ç½®

å¦‚æœéœ€è¦ä¿®æ”¹é…ç½®ï¼Œè¯·ç¼–è¾‘ `logic/rate_limiter.py` æ–‡ä»¶ï¼š

```python
# æ›´ä¿å®ˆçš„é…ç½®
RateLimiter(
    max_requests_per_minute=10,  # æ¯åˆ†é’Ÿæœ€å¤š10æ¬¡
    max_requests_per_hour=100,   # æ¯å°æ—¶æœ€å¤š100æ¬¡
    min_request_interval=5,       # æœ€å°é—´éš”5ç§’
    enable_logging=True
)
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å•åªè‚¡ç¥¨åˆ†æ

```python
from stock_ai_tool import analyze_stock

# è‡ªåŠ¨åº”ç”¨é€Ÿç‡é™åˆ¶ï¼Œæ— éœ€æ‹…å¿ƒ
result = analyze_stock('300997', 10, mode='full')
```

### 2. æ‰¹é‡åˆ†æï¼ˆæ¨èï¼‰

```python
from batch_analyze import batch_analyze

stocks = ['300997', '301171', '600000']
results = batch_analyze(stocks, days=10, mode='full')
```

### 3. åˆ†æ‰¹å¤„ç†å¤§é‡è‚¡ç¥¨

```python
from batch_analyze import batch_analyze

# åˆ†æˆå°æ‰¹ï¼Œæ¯æ‰¹10åª
all_stocks = ['300997', '301171', ...]  # å‡è®¾æœ‰100åª

batch_size = 10
for i in range(0, len(all_stocks), batch_size):
    batch = all_stocks[i:i+batch_size]
    results = batch_analyze(batch, days=10, mode='full')

    # æ¯æ‰¹ä¹‹é—´ä¼‘æ¯1åˆ†é’Ÿ
    import time
    time.sleep(60)
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸è¦ç»•è¿‡é€Ÿç‡é™åˆ¶

```python
# âŒ é”™è¯¯ï¼šç›´æ¥è°ƒç”¨ APIï¼Œç»•è¿‡é€Ÿç‡é™åˆ¶
import akshare as ak
df = ak.stock_individual_fund_flow(stock='300997', market='sz')

# âœ… æ­£ç¡®ï¼šä½¿ç”¨å¸¦é€Ÿç‡é™åˆ¶çš„å·¥å…·
from stock_ai_tool import analyze_stock
result = analyze_stock('300997', 10, mode='full')
```

### 2. é¿å…é«˜é¢‘å¹¶å‘

```python
# âŒ é”™è¯¯ï¼šå¹¶å‘è°ƒç”¨
from concurrent.futures import ThreadPoolExecutor

stocks = ['300997', '301171', '600000']
with ThreadPoolExecutor(max_workers=10) as executor:
    results = list(executor.map(analyze_stock, stocks))

# âœ… æ­£ç¡®ï¼šä½¿ç”¨æ‰¹é‡åˆ†æå·¥å…·
from batch_analyze import batch_analyze
results = batch_analyze(stocks, days=10, mode='full')
```

### 3. ç›‘æ§è¯·æ±‚é¢‘ç‡

```python
from logic.rate_limiter import get_rate_limiter

limiter = get_rate_limiter()

# å®šæœŸæ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯
limiter.print_stats()
```

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šè¯·æ±‚å¤ªæ…¢

**åŸå› **ï¼šè¾¾åˆ°äº†é€Ÿç‡é™åˆ¶ï¼Œéœ€è¦ç­‰å¾…

**è§£å†³**ï¼š
- è¿™æ˜¯æ­£å¸¸è¡Œä¸ºï¼Œé€Ÿç‡é™åˆ¶å™¨åœ¨ä¿æŠ¤ä½ çš„IP
- å¦‚æœéœ€è¦æ›´å¿«çš„é€Ÿåº¦ï¼Œå¯ä»¥è°ƒæ•´é…ç½®å‚æ•°ï¼ˆä½†ä¸å»ºè®®ï¼‰

### é—®é¢˜2ï¼šè¢«å°IP

**åŸå› **ï¼šç»•è¿‡äº†é€Ÿç‡é™åˆ¶ï¼Œè¯·æ±‚è¿‡äºé¢‘ç¹

**è§£å†³**ï¼š
- ç­‰å¾…1-2å°æ—¶åé‡è¯•
- ç¡®ä¿ä½¿ç”¨å¸¦é€Ÿç‡é™åˆ¶çš„å·¥å…·
- ä¸è¦ç»•è¿‡é€Ÿç‡é™åˆ¶å™¨

### é—®é¢˜3ï¼šé…é¢ä¸è¶³

**åŸå› **ï¼šçŸ­æ—¶é—´å†…è¯·æ±‚å¤ªå¤š

**è§£å†³**ï¼š
- ç­‰å¾…å‡ åˆ†é’Ÿè®©é…é¢æ¢å¤
- ä½¿ç”¨æ‰¹é‡åˆ†æå·¥å…·è‡ªåŠ¨å¤„ç†
- åˆ†æ‰¹å¤„ç†å¤§é‡è‚¡ç¥¨

## ğŸ“Š è¯·æ±‚å†å²è®°å½•

### æŸ¥çœ‹å†å²è®°å½•

é€Ÿç‡é™åˆ¶å™¨ä¼šè‡ªåŠ¨è®°å½•è¯·æ±‚å†å²ï¼š

```python
from logic.rate_limiter import get_rate_limiter

limiter = get_rate_limiter()
stats = limiter.get_stats()

print(f"æœ€åè¯·æ±‚æ—¶é—´: {stats['last_request']}")
```

### å†å²è®°å½•ä½ç½®

- æ–‡ä»¶è·¯å¾„ï¼š`data/rate_limiter_history.json`
- å†…å®¹ï¼šæœ€è¿‘100æ¬¡è¯·æ±‚è®°å½•
- æ ¼å¼ï¼šJSON

## âœ… æ€»ç»“

é€Ÿç‡é™åˆ¶å™¨å·²ç»å®Œå…¨é›†æˆåˆ°æ‰€æœ‰å·¥å…·ä¸­ï¼Œ**æ— éœ€æ‰‹åŠ¨é…ç½®**ã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. âœ… ä½¿ç”¨æä¾›çš„å·¥å…·ï¼ˆ`stock_ai_tool`ã€`batch_analyze`ï¼‰
2. âœ… ä¸è¦ç»•è¿‡é€Ÿç‡é™åˆ¶å™¨
3. âœ… ç›‘æ§è¯·æ±‚é¢‘ç‡
4. âœ… éµå®ˆæœ€ä½³å®è·µ

**å®‰å…¨ä¿è¯**ï¼š
- æ¯åˆ†é’Ÿæœ€å¤š 20 æ¬¡è¯·æ±‚
- æ¯å°æ—¶æœ€å¤š 200 æ¬¡è¯·æ±‚
- æœ€å°è¯·æ±‚é—´éš” 3 ç§’
- è‡ªåŠ¨ç­‰å¾…å’Œé˜Ÿåˆ—ç®¡ç†

è¿™æ ·å¯ä»¥æœ‰æ•ˆé¿å…è¢«å°IPçš„é£é™©ï¼