# 事件驱动监控使用指南

## 📖 功能说明

事件驱动监控模块实现了**第二阶段框架**，包含以下核心功能：

### 核心特性

1. **双模式支持**
   - **固定间隔模式**：每N分钟执行一次全市场扫描（新手推荐）
   - **事件驱动模式**：只在检测到事件时触发扫描（高级用户推荐）

2. **四大战法事件检测**
   - 集合竞价战法：弱转强、一字板扩散
   - 半路战法：平台突破
   - 低吸战法：5日均线回踩、分时均线低吸
   - 龙头战法：板块龙头、竞价弱转强、日内加速

3. **智能状态指纹**
   - 每次扫描生成唯一的状态指纹
   - 指纹包含：机会池股票代码、风险评分、系统置信度、仓位限制
   - 使用MD5哈希算法确保指纹唯一性

4. **按需快照保存**
   - **仅在状态变化时保存快照**
   - 避免重复保存相同结果
   - 使用时间戳命名，避免覆盖历史快照

5. **QMT Tick实时监控**
   - 使用QMT API订阅指定股票的Tick数据
   - 维护每只股票的"上一刻状态"
   - 实时检测价量事件

---

## 🚀 快速开始

### 方式一：固定间隔模式（推荐新手）

双击运行：
```
start_event_driven_monitor.bat fixed
```

或者命令行：
```bash
python tasks/run_event_driven_monitor.py --mode fixed_interval
```

**特点**：
- 简单易用，无需配置
- 每5分钟扫描一次
- 适合学习和测试

### 方式二：事件驱动模式（推荐高级用户）

命令行：
```bash
python tasks/run_event_driven_monitor.py --mode event_driven --stocks 000001.SZ 000002.SZ 300502.SZ
```

**特点**：
- 高效节能，只在有事件时扫描
- 需要指定监控股票列表
- 适合实盘交易

### 停止监控

在命令行中按 `Ctrl+C`

---

## 🧪 测试验证

### 运行测试脚本

```bash
python test_event_driven.py
```

测试内容包括：
- ✅ 事件检测器导入测试
- ✅ 事件管理器测试
- ✅ QMT Tick监控器测试
- ✅ 事件驱动监控器测试
- ✅ 事件触发测试

---

## 📊 事件类型说明

### 1. 集合竞价战法事件

#### OPENING_WEAK_TO_STRONG（竞价弱转强）

**触发条件**：
- 昨日：收盘涨幅 < 3%，或收阴线
- 今日竞价：高开幅度 ≥ 5%，竞价量比 ≥ 1.5

**示例**：
```
🔔 检测到事件: 000592.SZ - 竞价弱转强：高开6.00%，量比2.00
```

#### OPENING_THEME_SPREAD（一字板扩散）

**触发条件**：
- 当前票：竞价涨幅 ≥ 9.9%，封单金额 ≥ 流通盘市值的 5%
- 同题材：未封死涨停，但高开 ≥ 3%，竞价量比 ≥ 1.2

**示例**：
```
🔔 检测到事件: 300502.SZ - 一字板扩散：竞价涨幅10.50%，封单6.20%
```

### 2. 半路战法事件

#### HALFWAY_BREAKOUT（平台突破）

**触发条件**：
- 涨幅区间：20cm标的（10%-19.5%）或 10cm标的（5%-9.5%）
- 过去30-60分钟有平台（振幅 < 3%）
- 突破平台高点 ≥ 1%
- 突破成交量 ≥ 平台期平均量的1.5倍

**示例**：
```
🔔 检测到事件: 300502.SZ - 半路平台突破（20cm）：涨幅12.50%，突破1.20%，量比1.80
```

### 3. 低吸战法事件

#### DIP_BUY_CANDIDATE（低吸候选）

**触发条件（5日均线低吸）**：
- 日线趋势：MA5 > MA10 > MA20（多头排列）
- 盘中价格：回踩到 MA5 下方 0%-2%
- 成交量萎缩：当日量 ≤ 昨日量的 70%

**触发条件（分时均线低吸）**：
- 分时均线多头排列
- 价格回落到分时均线下方 1.5%-2.5%
- 近期成交量 ≤ 早盘高峰的 60%
- 价格重新站上均线之上（突破 0.5%）

**示例**：
```
🔔 检测到事件: 000592.SZ - 5日均线低吸：回踩1.50%，缩量65.0%
```

### 4. 龙头战法事件

#### LEADER_CANDIDATE（龙头候选）

**触发条件（板块龙头）**：
- 同板块内：当日涨幅 = 板块内第一（或 Top3 且差距 < 1%）
- 且涨幅 ≥ 5%

**触发条件（竞价弱转强）**：
- 昨日：收盘涨幅 < 3%（弱势或震荡）
- 今日 9:25 后：高开幅度 ≥ 5%，竞价量比 ≥ 1.5

**触发条件（日内加速）**：
- 最近 5-10 分钟：价格突破当日前高（或最近 60 分钟平台高点）
- 且最近 5 分钟成交额 ≥ 前 5 分钟的 1.5 倍

**示例**：
```
🔔 检测到事件: 300502.SZ - 板块龙头候选：涨幅8.50%，板块排名第1
```

---

## ⚙️ 配置参数

### 修改扫描间隔

编辑命令行参数：

```bash
python tasks/run_event_driven_monitor.py --mode fixed_interval --interval 300
```

可调整的间隔：
- `60` 秒 = 1分钟（高频率）
- `300` 秒 = 5分钟（推荐）
- `600` 秒 = 10分钟（低频率）

### 修改监控股票列表

在事件驱动模式下，指定要监控的股票：

```bash
python tasks/run_event_driven_monitor.py --mode event_driven --stocks 000001.SZ 000002.SZ 300502.SZ
```

### 修改事件冷却时间

编辑 `logic/event_detector.py` 第72行：

```python
self.cooldown_seconds = 60  # 冷却时间（秒）
```

---

## 📈 监控输出示例

### 固定间隔模式

```
================================================================================
📊 扫描完成 #1 - 09:30:00
================================================================================
✅ 机会池: 12 只
⚠️  观察池: 11 只
❌ 黑名单: 0 只
📈 系统置信度: 92.5%
💰 今日建议最大总仓位: 74.0%
🎯 累计保存快照: 1 次
🔔 累计检测事件: 0 次

🔥 机会池 TOP3:
   000592.SZ - 风险: 0.00 - 类型: HOT_MONEY
   601869.SH - 风险: 0.20 - 类型: INSTITUTIONAL
   300502.SZ - 风险: 0.40 - 类型: HOT_MONEY
================================================================================
```

### 事件驱动模式

```
💓 监控中... (累计事件: 0)
💓 监控中... (累计事件: 0)
🔔 检测到事件: 300502.SZ - 半路平台突破（20cm）：涨幅12.50%，突破1.20%，量比1.80
🔥 事件触发扫描！
--------------------------------------------------------------------------------
🔍 开始扫描 #1
...
```

---

## 🔧 故障排查

### 问题1：QMT不可用

**症状**：日志显示 "QMT不可用"

**可能原因**：
- 未安装xtquant库
- QMT客户端未启动

**解决方法**：
1. 安装xtquant库：`pip install xtquant`
2. 启动QMT客户端
3. 使用固定间隔模式作为备选

### 问题2：事件未触发

**症状**：长时间没有检测到事件

**可能原因**：
- 监控股票列表为空
- 股票价格波动太小
- 事件检测器未启用

**解决方法**：
1. 检查监控股票列表是否正确
2. 使用固定间隔模式确保扫描正常运行
3. 检查事件检测器是否启用

### 问题3：扫描频繁触发

**症状**：事件频繁触发，扫描过于频繁

**可能原因**：
- 冷却时间设置过短
- 事件检测阈值过低

**解决方法**：
1. 增加冷却时间（默认60秒）
2. 调整事件检测阈值

---

## 📝 与第一阶段对比

| 特性 | 第一阶段（固定间隔） | 第二阶段（事件驱动） |
|------|---------------------|---------------------|
| 扫描方式 | 每5分钟扫描一次 | 只在检测到事件时扫描 |
| 资源消耗 | 较高 | 较低 |
| 实时性 | 一般 | 高 |
| 配置难度 | 简单 | 中等 |
| 适用场景 | 学习测试 | 实盘交易 |

---

## 📚 相关文档

- [持续监控使用指南](CONTINUOUS_MONITOR_GUIDE.md)
- [全市场扫描器文档](FULL_MARKET_SCANNER_GUIDE.md)
- [用户指南](../docs/user-guide/README.md)
- [开发文档](../docs/dev/README.md)

---

## 🤝 反馈与建议

如有问题或建议，请通过以下方式反馈：

1. 提交Issue到GitHub
2. 联系开发团队
3. 查看项目文档

---

**版本**: V2.0
**最后更新**: 2026-02-06
**作者**: iFlow CLI