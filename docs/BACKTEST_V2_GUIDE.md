# 量化回测执行手册 V2（严格版）

> **目标**：修复幸存者偏差，验证5日均线突破策略在“成交额Top 500股票”上的真实表现

---

## 🚨 V1 的致命问题（必须了解）

### 问题1：幸存者偏差
```
V1 样本：83只“已经涨停”的股票
问题：这是“赛后买彩票”，无法验证策略的预测能力
```

**正确做法**：
- 使用“成交额Top 500”（流动性最好的股票）
- 这些股票没有“已经成功”的标签，是中性样本

### 问题2：策略与股票类型不匹配
```
V1 策略：5日均线突破（趋势跟随，滞后）
V1 样本：涨停股（爆发性行情）
结果：胜率分布极端（0%-100%），说明策略对这类股票无效
```

**正确做法**：
- 均线策略适用于“趋势股”，不适用于涨停股
- 用成交额Top 500股票测试，这些股票更可能产生趋势性行情

### 问题3：统计意义不足
```
V1 样本量：83只股票，总交易次数不足300次
问题：无法得出统计上的结论
```

**正确做法**：
- 500只股票 × 90天数据 = 足够的样本量
- 增加“随机买入对照组”，验证策略是否优于随机

---

## ✅ V2 的改进（三大核心）

### 1. 样本选择：成交额Top 500
- **不用涨停股**，避免幸存者偏差
- **流动性最好**：成交额排名前500的股票
- **中性样本**：既有牛股，也有平常股票

### 2. 消除未来函数
```python
# 错误：用未来数据做决策
if today_close > today_ma5:  # 今天收盘才知道的信息
    buy_tomorrow()  # 明天买入（但现实中买不到）

# 正确：只用当日收盘前的数据
if yesterday_close > yesterday_ma5:  # 昨天收盘时已知
    buy_today_open()  # 今天开盘买入（真实可执行）
```

### 3. 增加对照组
- **策略买入**：根据5日均线突破信号买入
- **随机买入**：随机选择日期买入
- **对比分析**：如果策略买入的胜率、收益不优于随机买入 → 策略无效

---

## 🚀 完整执行流程

### **步靄1：获取热门股票列表（成交额Top 500）**

```bash
# 优先使用 Tushare Pro（Token认证，不受IP限制）
python tools/get_hot_stocks_v2.py --mode tushare --top 500

# 如果 Tushare Token 未配置，使用 AkShare 备用方案
python tools/get_hot_stocks_v2.py --mode akshare --top 500
```

**输出**：`data/hot_stocks_v2.txt`（500只股票代码）

**特点**：
- ✅ 缓存机制：12小时内重复调用直接读缓存
- ✅ 随机延迟：避免机器人检测
- ✅ 更保守的速率限制：8秒间隔，确保不超过 7.5 req/min

---

### **步靄2：下载分钟K线数据（90天）**

```bash
# 下载90天数据（覆盖更多市场环境）
python tools/download_from_list.py --list data/hot_stocks_v2.txt --days 90
```

**时间预估**：
- 500只股票 × 约 0.5秒/只 = 4-5分钟

**输出**：`data/minute_data_hot/` 目录
- 500个 CSV 文件，每个包含90天的分钟级K线

---

### **步靄3：运行回测（V2 引擎）**

```bash
python tools/run_backtest_1m_v2.py --data-dir data/minute_data_hot
```

**输出**：`data/backtest_report_v2.md`

**报告内容**：
1. 总体统计（股票数、交易次数、平均胜率、总收益）
2. **策略 vs 随机买入**（对照组对比）
3. 胜率分布分析（0-30%, 30-50%, 50-70%, 70-100%）
4. Top 10 / Bottom 10 股票

---

## 📈 如何判断策略是否有效？

### ✅ 策略有效的标志

1. **胜率优于随机**
   ```
   策略胜率 > 随机胜率 + 5%
   例：策略 58% vs 随机 50%  → ✅ 有效
   ```

2. **胜率分布合理**
   ```
   50%-70% 区间的股票数 > 40%
   0%-30% 和 70%-100% 的极端值 < 20%
   ```

3. **总收益为正**
   ```
   总收益率 > 10%（500只股票 × 90天）
   ```

4. **盈亏比 > 1.5**
   ```
   平均盈利 / |平均亏损| > 1.5
   ```

### ❌ 策略无效的信号

1. **胜率接近或低于随机**
   ```
   策略胜率 ≈ 随机胜率  → 策略无效
   ```

2. **胜率分布极端**
   ```
   0%-30% 和 70%-100% 的股票 > 50%  → 策略对股票没有筛选能力
   ```

3. **总收益为负**
   ```
   总收益率 < 0%  → 策略长期亏损
   ```

---

## 🔧 故障排查

### 问题1：AkShare IP 封禁

**现象**：
```
❌ 失败: HTTPError 403 Forbidden
```

**解决方案**：
1. 等待5-10分钟后重试
2. 切换到 Tushare：`--mode tushare`
3. 使用缓存：12小时内重复调用会自动读缓存

### 问题2：QMT 连接失败

**现象**：
```
❌ QMT 连接失败: Connection refused
```

**解决方案**：
1. 检查 QMT 客户端是否开启
2. 检查是否已登录账户
3. 检查 `userdata_mini` 目录下的账户状态

### 问题3：回测结果为空

**现象**：
```
⚠️  没有有效的回测结果
```

**原因**：
1. 数据文件损坏或格式错误
2. 股票数据天数不足（<10天）
3. MA5 计算失败（需要至少5天数据）

**解决方案**：
1. 检查 CSV 文件是否存在
2. 检查 CSV 文件是否有数据（打开查看）
3. 重新下载数据

---

## 📊 后续优化方向

### 1. 增加更多策略
- 动量突破策略
- MACD 金叉策略
- 布林带突破策略

### 2. 多维度分析
- 按市值分组（大盘、中盘、小盘）
- 按板块分组（科技、消费、金融）
- 按时间段分组（牛市、熊市、震荡）

### 3. 风险控制
- 最大回撤控制
- 位置管理（每只股票最大持仓比例）
- 止损/止盈规则

---

## ✅ 总结

**V2 相比 V1 的核心优势**：

| 项目 | V1 | V2 |
|------|----|----||
| 样本选择 | 涨停股（幸存者偏差） | 成交额Top 500（中性样本） |
| 样本量 | 83只 | 500只 |
| 时间范围 | 30天 | 90天 |
| 未来函数 | 存在 | 已消除 |
| 对照组 | 无 | 有（随机买入） |
| 统计分析 | 简单 | 完整（胜率分布、Top/Bottom） |
| 防封机制 | 缺失 | 完善（缓存+延迟+限制器） |

**现在可以开始执行！**🚀