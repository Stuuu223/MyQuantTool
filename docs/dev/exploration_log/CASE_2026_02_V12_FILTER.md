# CASE: V12.1.0过滤器失效与回滚

**ID**: CASE_2026_02_V12_FILTER  
**创建日期**: 2026-02-18  
**状态**: 已关闭（回滚完成）  
**负责人**: AI项目总监  
**严重程度**: 🔴 高（影响实际数据表现）

---

## 0. 背景 & 目标

### 为什么开始这条探索？
在顽主杯分析框架中启用V12.1.0三大过滤器（板块共振+动态阈值+竞价校验），发现回测通过率极低，实际数据表现糟糕。

### 想回答的关键问题
1. V12.1.0过滤器为什么在实际数据中失效？
2. 模拟数据 vs 实际数据差异为什么这么大？
3. 如何防止类似问题再次发生？

---

## 1. 进展记录

### Day 1 (2026-02-18)

#### 1.1 做了什么
- 分析V12.1.0三大过滤器在顽主杯回测中的表现
- 对比模拟数据 vs 实际数据的表现差异
- 深度代码审查：wind_filter.py / dynamic_threshold.py / auction_validator.py
- 复盘过滤器架构设计问题

#### 1.2 关键发现

**1.2.1 表现对比（模拟 vs 实际）**

| 指标 | 模拟数据 | 实际数据 | 差异 |
|-----|---------|---------|------|
| 胜率 | 93.33% | 25.00% | -68.33% |
| 收益率 | +9.32% | -21.01% | -30.33% |
| 交易次数 | 15次 | 24次 | +60% |
| 最大回撤 | 11.00% | 24.72% | +124% |

**1.2.2 具体缺陷分析**

| 组件 | 设计缺陷 | 实际表现 |
|-----|---------|---------|
| **板块共振** | 阈值过高（涨停≥3只/上涨≥35%/连续3日流入） | 通过率仅3.8%（102/2652） |
| **动态阈值** | 市值范围过窄（50-1000亿） | 误杀小盘起爆股（20-50亿） |
| **竞价校验** | 使用估算数据（prev_close*0.99） | 回测严重失真 |
| **串联架构** | 一票否决制 | 综合通过率0.11%（3.8%×32.7%×50%） |

**1.2.3 根因分析**

1. **过拟合理想场景**
   - 模拟数据人为构造"板块共振强、主力流入多"的特征
   - 实际市场这些特征极少同时出现

2. **硬编码阈值**
   - 所有阈值基于"理想环境"设计，未考虑真实市场分布
   - 如：要求板块内≥3只涨停，实际市场95%时间不满足

3. **串联一票否决**
   - 过滤器1不通过 → 直接跳过（不再检查其他条件）
   - 理论上通过率 = 3.8% × 32.7% × 50% ≈ 0.6%
   - 实际通过率0.11%，几乎全拒

4. **市值过滤误杀**
   - 过滤<50亿股票，但右侧起爆核心标的多在20-50亿
   - 系统性截杀策略应该捕捉的机会

#### 1.3 决策 / 动作

**立即执行（CTO+老板拍板）**：
- ✅ V12.1.0标记为EXPERIMENTAL，默认禁用（`enable_filters=False`）
- ✅ 回滚到V11 TripleFunnel评分制防守轴
- ✅ 禁止在新模块重复发明过滤器
- ✅ 制定《架构铁律》文档，防止重复犯错

**文档更新**：
- `docs/MyQuantTool-Architecture-Iron-Laws.md` - 新增铁律文档
- `docs/CORE_ARCHITECTURE.md` - 新增0.4节记录V12.1.0状态
- `docs/V17_TECH_DEBT.md` - 新增技术债务条目

---

## 2. 经验教训

### 架构层面
1. **过滤器必须用"评分制"，慎用"一票否决"**
   - V11 TripleFunnel：各因子输出评分，综合决策
   - V12.1.0错误：串联硬拒绝，单点失效

2. **阈值必须"跟随市场"，禁止硬编码**
   - 相对分位数 > 绝对数值
   - 动态调整 > 固定阈值

3. **任何过滤改动必须热门票验证**
   - 模拟数据通过 ≠ 实际数据通过
   - 必须在网宿/顽主等真实强势票上验证

### 工程层面
1. **禁止在新引擎里复制过滤逻辑**
   - 应抽象统一过滤层，供1m/tick回测复用
   - 禁止各自为政造新过滤器

2. **数据估算必须明示失真**
   - prev_close*0.99这种估算必须标注"估算数据"
   - 关键决策必须用真实数据

### 流程层面
1. **Code Review红线**
   - 出现`> 100_000_000`等魔法数字直接打回
   - 出现`import xtdata`直接打回
   - 无热门票回测报告直接打回

---

## 3. 相关资源

### 代码文件
- `logic/strategies/wind_filter.py` - 板块共振过滤器
- `logic/strategies/dynamic_threshold.py` - 动态阈值管理器
- `logic/strategies/auction_strength_validator.py` - 竞价校验器
- `backtest/t1_tick_backtester.py` - 回测引擎（已禁用V12.1.0）

### 数据
- `backtest/reports/V12.1.0_FINAL_VALIDATION_REPORT.md` - 验证报告
- `backtest/reports/V12.1.0_comparison_report.md` - 对比报告

### 文档
- `docs/MyQuantTool-Architecture-Iron-Laws.md` - 铁律文档
- `docs/CORE_ARCHITECTURE.md` - 0.4节V12.1.0状态
- `docs/V17_TECH_DEBT.md` - 技术债务#1

---

## 4. 后续规划

### 短期（本周）
- [x] 禁用V12.1.0，恢复V11 TripleFunnel
- [x] 制定铁律文档，建立Code Review红线
- [ ] 将V12.1.0重构为"评分贡献"模式（非一票否决）

### 中期（本月）
- [ ] 统一过滤层抽象，供1m/tick回测复用
- [ ] 动态阈值+分位数判断方案实现
- [ ] 在热门票样本上验证新方案

### 长期（持续）
- [ ] 建立"过滤器效果监控"体系
- [ ] 每月根据历史表现自校准阈值
- [ ] 定期评审铁律执行情况

---

## 5. 关键引用

**CTO指示**：
> "禁止在新模块重复发明过滤器。所有新过滤逻辑必须基于V11 triplefunnel/defenseaxe已验证的防守轴抽象出来。"

**老板定调**：
> "心中无顶底，跟随市场。资金强度是相对概念，不是绝对数值。"

**铁律条款**：
- 第1.1条：禁止魔法数字进核心引擎
- 第3.1条：过滤器优先"评分制"，慎用"一票否决"
- 第5.1条：任何核心改动，先跑"热门样本回测"，再谈全市场
