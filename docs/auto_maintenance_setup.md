# 数据预热自动运行配置指南

## 概述

数据预热自动运行系统可以在盘后自动下载历史数据，确保复盘模式随时可用。

## 两种运行方式

### 方式一：集成到主程序（实时检查）

适合主程序一直运行的情况，在主循环中自动检查并下载数据。

**使用方法：**

```python
from logic.auto_maintenance import AutoMaintenance

# 创建维护实例
maintainer = AutoMaintenance()

# 在主循环中调用
while True:
    # 你的主逻辑
    scan_market()

    # 检查并执行数据预热
    maintainer.run_daily_job()

    time.sleep(1)
```

**优点：**
- 无需额外配置
- 与主程序无缝集成

**缺点：**
- 主程序必须一直运行
- 主程序崩溃时无法自动下载

---

### 方式二：Windows 任务计划程序（推荐）

适合需要独立运行、解耦的场景。

**优点：**
- 完全独立运行，不受主程序影响
- Windows 负责准时唤醒
- 即使主程序挂了，数据预热依然正常

**缺点：**
- 需要配置一次任务计划程序

---

## Windows 任务计划程序配置步骤

### 1. 打开任务计划程序

- 按 `Win + R`，输入 `taskschd.msc`，按回车
- 或者在开始菜单搜索"任务计划程序"

### 2. 创建基本任务

- 在右侧操作栏点击"创建基本任务"
- 输入名称：`QMT数据自动预热`
- 输入描述：`盘后自动下载历史数据，支持复盘模式`
- 点击"下一步"

### 3. 设置触发器

- 选择"每天"
- 点击"下一步"
- 设置开始时间：`16:00:00`
- 点击"下一步"

**注意：**
- 建议设置在 16:00 之后（给交易所一点归档数据的时间）
- 可以设置为 16:00 或 17:00

### 4. 设置操作

- 选择"启动程序"
- 点击"下一步"
- 配置以下参数：

  - **程序或脚本**：你的 Python 解释器路径
    ```
    C:\Users\你的用户名\AppData\Local\Programs\Python\Python310\python.exe
    ```

    如果不知道路径，可以运行：
    ```cmd
    where python
    ```

  - **添加参数（可选）**：
    ```
    scripts\daily_update.py
    ```

  - **起始于（重要）**：你的项目根目录
    ```
    C:\Users\pc\Desktop\Astock\MyQuantTool
    ```

- 点击"下一步"

### 5. 完成设置

- 查看摘要信息
- 勾选"当单击完成时，打开此任务属性的对话框"
- 点击"完成"

### 6. 高级设置（可选）

在打开的属性对话框中：

- **常规**选项卡：
  - 勾选"使用最高权限运行"
  - 配置为：Windows 10

- **条件**选项卡：
  - 取消勾选"只有在计算机使用交流电源时才启动此任务"（如果需要）

- **设置**选项卡：
  - 勾选"如果任务失败，按以下频率重新启动"：5分钟
  - 勾选"如果任务运行时间超过以下时间，停止任务"：1小时

- 点击"确定"

---

## 手动测试

在配置完成后，可以手动测试脚本是否正常运行：

```cmd
cd C:\Users\pc\Desktop\Astock\MyQuantTool
python scripts\daily_update.py
```

**指定日期测试：**

```cmd
python scripts\daily_update.py 20260128
```

---

## 验证自动运行

### 1. 查看任务历史

在任务计划程序中：

- 点击"任务计划程序库"
- 找到"QMT数据自动预热"任务
- 在中间的"历史记录"标签页查看运行记录

### 2. 查看日志

日志文件位置：`logs/auto_maintenance.log`

### 3. 检查数据可用性

在 UI 中：

1. 打开"历史重演测试"
2. 选择日期
3. 查看"系统状态"中的数据状态

---

## 常见问题

### Q1: 任务没有自动运行？

**检查清单：**
1. 计算机是否在 16:00 时开机？
2. 是否有管理员权限？
3. 查看任务计划程序中的"历史记录"
4. 查看日志文件是否有错误信息

### Q2: 下载失败？

**可能原因：**
1. QMT 客户端未启动
2. 网络连接问题
3. 日期格式错误

**解决方法：**
1. 确保 QMT 客户端已启动并登录
2. 手动运行脚本测试：`python scripts\daily_update.py`

### Q3: 磁盘空间不足？

**解决方案：**

当前系统采用**增量下载策略**，每天只下载当天的数据，不会造成磁盘爆炸。

如果需要清理旧数据，可以：
1. 删除 QMT 的历史数据目录（注意备份）
2. 或者配置只保留最近 30 天的数据

### Q4: 周末也会运行吗？

**当前设计：**
- 任务计划程序每天都会运行
- 但周末下载的数据会很少（无交易数据）

**优化建议：**
可以修改脚本，检查是否为交易日，非交易日跳过下载。

---

## 性能说明

**下载速度：**
- 1分钟K线：约 2-3 分钟（全市场）
- 日K线：约 1 分钟（全市场）
- 总计：约 5 分钟

**磁盘占用：**
- 每天：约 100-200 MB（全市场 1分钟K线）
- 30 天：约 3-6 GB

---

## 版本历史

- **V19.17.2** (2026-01-28)
  - 初始版本
  - 支持增量下载策略
  - 支持多周期数据下载
  - 支持数据可用性检查

---

## 技术支持

如有问题，请查看：
1. 日志文件：`logs/auto_maintenance.log`
2. 任务计划程序历史记录
3. 运行 `python scripts/daily_update.py` 手动测试