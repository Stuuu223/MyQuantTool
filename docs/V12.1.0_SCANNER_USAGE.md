# V12.1.0 增强版三漏斗扫描器使用指南

## 概述

V12.1.0 增强版三漏斗扫描器在原有三漏斗扫描器的基础上，集成了三大核心过滤器：

1. **板块共振过滤器** - 拒绝"孤军深入"
2. **动态阈值管理器** - 废弃硬编码阈值
3. **竞价强弱校验器** - 避免竞价陷阱

## 架构设计

```
Level 1: 技术面粗筛（QMT）
  ↓
Level 2: 资金流向分析（AkShare）
  ↓
【新增】Level 2.5: 三大过滤器检查
  ├─ 风口过滤器（板块共振）
  ├─ 动态阈值（市值+时间+情绪）
  └─ 竞价校验（仅开盘阶段）
  ↓
Level 3: 坑vs机会分类（TrapDetector）
```

## 快速开始

### 1. 基础使用

```python
from logic.strategies.triple_funnel_scanner_v121 import get_scanner_v121

# 创建扫描器
scanner = get_scanner_v121(
    enable_wind_filter=True,        # 启用板块共振过滤器
    enable_dynamic_threshold=True,   # 启用动态阈值管理器
    enable_auction_validator=True,   # 启用竞价校验器
    sentiment_stage='divergence'     # 情绪周期阶段
)

# 运行盘后扫描
results = scanner.run_post_market_scan_v121(max_stocks=100)

# 查看结果
for stock in results:
    print(f"{stock['code']} {stock['name']}")
    print(f"  Level 2.5: {'✅' if stock['filter25_result'].passed else '❌'}")
```

### 2. 使用配置加载器

```python
from logic.strategies.scanner_v121_config_loader import get_config_loader

# 获取配置加载器
loader = get_config_loader()

# 查看可用预设
presets = loader.get_available_presets()
print(f"可用预设: {', '.join(presets)}")

# 使用平衡模式
scanner = loader.get_scanner(preset="balanced")

# 切换到保守模式
scanner = loader.switch_preset("conservative")
```

## 预设配置

### 1. 平衡模式（balanced）

- **适用场景**: 日常交易，平衡风险和收益
- **板块共振**: ✅ 启用
- **动态阈值**: ✅ 启用
- **竞价校验**: ✅ 启用
- **情绪周期**: divergence（分歧期）

### 2. 保守模式（conservative）

- **适用场景**: 市场低迷期，严格控制风险
- **板块共振**: ✅ 启用
- **动态阈值**: ✅ 启用
- **竞价校验**: ✅ 启用
- **情绪周期**: recession（退潮期）

### 3. 激进模式（aggressive）

- **适用场景**: 市场启动期，追求高收益
- **板块共振**: ❌ 禁用（避免错过机会）
- **动态阈值**: ✅ 启用
- **竞价校验**: ❌ 禁用（避免错过开盘机会）
- **情绪周期**: start（启动期）

### 4. A/B 测试模式（ab_test_no_filters）

- **适用场景**: 回测对比，验证过滤器效果
- **板块共振**: ❌ 禁用
- **动态阈值**: ❌ 禁用
- **竞价校验**: ❌ 禁用
- **情绪周期**: divergence（分歧期）

## 过滤器详解

### 1. 板块共振过滤器（wind_filter）

**核心逻辑**:
- 条件A: 板块内涨停股 ≥ 3只
- 条件B: 板块内上涨股票占比 ≥ 35%
- 条件C: 板块指数连续3日资金净流入
- 满足至少2个条件才返回True

**配置参数**:
```python
{
    "min_limit_up_count": 3,      # 最少涨停股数
    "min_rise_ratio": 0.35,       # 最少上涨比例 (35%)
    "sustained_inflow_days": 3    # 连续流入天数
}
```

**使用场景**:
- 拒绝"孤军深入"的个股
- 只有"个股强 + 板块共振"才是真龙
- 适用于主升期和分歧期

### 2. 动态阈值管理器（dynamic_threshold）

**核心逻辑**:
- 根据流通市值分层计算基础阈值
- 根据时间分段调整阈值（开盘/盘中/尾盘）
- 根据情绪周期调整阈值（启动/主升/高潮/退潮/冰点）

**市值分层**:
```python
{
    'small': {'max': 50, 'ratio': 0.002},      # 小盘股：0.2%
    'mid': {'max': 100, 'ratio': 0.001},       # 中盘股：0.1%
    'large': {'max': 1000, 'ratio': 0.0005},   # 大盘股：0.05%
    'mega': {'ratio': 0.0002}                  # 超大盘股：0.02%
}
```

**时间分段**:
```python
{
    'open': {'adjustment': 0.8},   # 开盘：放宽阈值（x0.8）
    'mid': {'adjustment': 1.0},    # 盘中：标准阈值（x1.0）
    'close': {'adjustment': 1.2}   # 尾盘：严格阈值（x1.2）
}
```

**情绪周期**:
```python
{
    'start': {'adjustment': 0.8},      # 启动期：激进（x0.8）
    'main': {'adjustment': 0.8},       # 主升期：激进（x0.8）
    'climax': {'adjustment': 0.8},     # 高潮期：激进（x0.8）
    'divergence': {'adjustment': 1.0}, # 分歧期：标准（x1.0）
    'recession': {'adjustment': 1.2},  # 退潮期：保守（x1.2）
    'freeze': {'adjustment': 1.2}      # 冰点期：保守（x1.2）
}
```

### 3. 竞价强弱校验器（auction_strength_validator）

**核心逻辑**:
- 区分明牌焦点股和非明牌股的判断逻辑
- 根据历史表现计算竞价预期溢价
- 提供降级策略（数据缺失时返回中性判断）

**明牌焦点股判断**:
- 昨日涨停股：今日竞价量比 < 1.0 或 低开 → 不及预期 → 放弃
- 昨日越强，今日预期越高

**首板挖掘判断**:
- 竞价量比 > 3.0 且 高开 1-3% → 超预期 → 加分
- 竞价爆量跳空高开 → 强烈关注

**配置参数**:
```python
{
    "focus_stock_min_volume_ratio": 1.0,   # 焦点股最小量比
    "focus_stock_min_open_gap": 0.0,      # 焦点股最小高开
    "first_board_min_volume_ratio": 3.0,  # 首板最小量比
    "first_board_min_open_gap": 0.01,     # 首板最小高开 1%
    "first_board_max_open_gap": 0.03,     # 首板最大高开 3%
    "base_min_volume_ratio": 1.5,         # 基础最小量比
    "base_min_open_gap": 0.02             # 基础最小高开 2%
}
```

## 动态配置

### 切换过滤器开关

```python
# 禁用板块共振过滤器
scanner.toggle_filter('wind', False)

# 启用动态阈值管理器
scanner.toggle_filter('threshold', True)

# 禁用竞价校验器
scanner.toggle_filter('auction', False)
```

### 更新情绪周期

```python
# 更新情绪周期阶段
scanner.update_sentiment_stage('start')  # 启动期
scanner.update_sentiment_stage('main')   # 主升期
scanner.update_sentiment_stage('climax') # 高潮期
scanner.update_sentiment_stage('divergence')  # 分歧期
scanner.update_sentiment_stage('recession')  # 退潮期
scanner.update_sentiment_stage('freeze')     # 冰点期
```

### 获取过滤器统计

```python
# 获取过滤器统计信息
stats = scanner.get_filter_stats()

print(f"总检查: {stats['total_checks']}")
print(f"板块共振通过: {stats['wind_passed']}")
print(f"动态阈值通过: {stats['threshold_passed']}")
print(f"竞价校验通过: {stats['auction_passed']}")
print(f"全部通过: {stats['all_passed']}")
print(f"平均耗时: {stats['total_time_ms']/stats['total_checks']:.2f}ms/股")
```

## 运行测试

### 1. 集成测试

```bash
# 运行集成测试
python test_scanner_v121.py
```

### 2. 对比测试

```bash
# 运行对比测试（V12.1.0 vs 原版）
python test_scanner_comparison.py
```

### 3. 配置加载器测试

```bash
# 测试配置加载器
python logic/strategies/scanner_v121_config_loader.py
```

## 性能指标

- **单次过滤耗时**: < 1000ms
- **板块共振检查**: < 500ms
- **动态阈值计算**: < 50ms
- **竞价校验**: < 30ms
- **缓存优化**: 支持全局缓存，减少重复计算

## 最佳实践

### 1. 情绪周期匹配

根据市场情绪周期选择合适的预设配置：

| 情绪周期 | 推荐预设 | 说明 |
|---------|---------|------|
| 启动期 | aggressive | 激进模式，捕捉机会 |
| 主升期 | aggressive | 激进模式，追求收益 |
| 高潮期 | balanced | 平衡模式，控制风险 |
| 分歧期 | balanced | 平衡模式，谨慎选择 |
| 退潮期 | conservative | 保守模式，严格过滤 |
| 冰点期 | conservative | 保守模式，等待机会 |

### 2. A/B 测试

使用 A/B 测试模式验证过滤器效果：

```python
# 1. 运行原版扫描（无过滤器）
scanner_ab = loader.get_scanner(preset="ab_test_no_filters")
results_ab = scanner_ab.run_post_market_scan_v121()

# 2. 运行 V12.1.0 扫描（有过滤器）
scanner_v121 = loader.get_scanner(preset="balanced")
results_v121 = scanner_v121.run_post_market_scan_v121()

# 3. 对比结果
print(f"原版通过: {len(results_ab)} 只")
print(f"V12.1.0通过: {len(results_v121)} 只")
print(f"过滤减少: {len(results_ab) - len(results_v121)} 只")
```

### 3. 监控和调优

定期查看过滤器统计，优化过滤策略：

```python
# 获取统计信息
stats = scanner.get_filter_stats()

# 计算通过率
wind_pass_rate = stats['wind_passed'] / stats['total_checks'] * 100
threshold_pass_rate = stats['threshold_passed'] / stats['total_checks'] * 100
auction_pass_rate = stats['auction_passed'] / stats['total_checks'] * 100

print(f"板块共振通过率: {wind_pass_rate:.1f}%")
print(f"动态阈值通过率: {threshold_pass_rate:.1f}%")
print(f"竞价校验通过率: {auction_pass_rate:.1f}%")

# 根据通过率调整配置
if wind_pass_rate < 30:
    print("⚠️ 板块共振通过率过低，考虑放宽阈值")
elif wind_pass_rate > 70:
    print("⚠️ 板块共振通过率过高，考虑收紧阈值")
```

## 常见问题

### Q1: 为什么某些股票被过滤器拒绝？

**A**: 查看过滤结果中的原因：

```python
for stock in results:
    if not stock['filter25_result'].passed:
        print(f"{stock['code']}: {', '.join(stock['filter25_result'].reasons)}")
```

### Q2: 如何单独测试某个过滤器？

**A**: 使用 `toggle_filter` 方法：

```python
# 只启用板块共振过滤器
scanner.toggle_filter('wind', True)
scanner.toggle_filter('threshold', False)
scanner.toggle_filter('auction', False)

# 运行测试
results = scanner.run_post_market_scan_v121()
```

### Q3: 如何自定义过滤器参数？

**A**: 修改配置文件 `config/scanner_v121_config.json`，或直接修改过滤器实例：

```python
# 修改板块共振过滤器参数
scanner.wind_filter.MIN_LIMIT_UP_COUNT = 5  # 提高涨停股阈值
scanner.wind_filter.MIN_RISE_RATIO = 0.4    # 提高上涨比例阈值

# 修改动态阈值管理器参数
scanner.dynamic_threshold.MARKET_CAP_TIERS['small']['ratio'] = 0.003  # 提高小盘股阈值
```

### Q4: 过滤器会影响性能吗？

**A**: 影响很小，通过缓存优化：

- 板块共振检查: < 500ms（缓存后 < 50ms）
- 动态阈值计算: < 50ms（缓存后 < 10ms）
- 竞价校验: < 30ms

### Q5: 如何回测验证过滤器效果？

**A**: 使用 A/B 测试模式对比结果：

```python
# 运行 A/B 测试
scanner_ab = loader.get_scanner(preset="ab_test_no_filters")
scanner_v121 = loader.get_scanner(preset="balanced")

# 对比回测结果
results_ab = scanner_ab.run_post_market_scan_v121()
results_v121 = scanner_v121.run_post_market_scan_v121()

# 分析过滤效果
print(f"原版通过率: {len(results_ab)/total_stocks*100:.1f}%")
print(f"V12.1.0通过率: {len(results_v121)/total_stocks*100:.1f}%")
print(f"过滤精度: 需要进一步回测验证")
```

## 更新日志

### V12.1.0 (2026-02-14)

- ✅ 集成三大过滤器：板块共振、动态阈值、竞价校验
- ✅ 实现过滤结果可追溯
- ✅ 支持独立启用/禁用每个过滤器
- ✅ 提供配置加载器和预设配置
- ✅ 性能优化，单次过滤 < 1000ms
- ✅ 完善的测试用例和文档

## 技术支持

如有问题，请参考：
- 项目文档: `docs/V12.1.0_SCANNER_USAGE.md`
- 测试脚本: `test_scanner_v121.py`
- 对比测试: `test_scanner_comparison.py`
- 配置文件: `config/scanner_v121_config.json`

---

**Author**: iFlow CLI  
**Version**: V12.1.0  
**Date**: 2026-02-14