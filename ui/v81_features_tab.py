"""
V8.1 æµåŠ¨æ€§ä¸çœŸé¾™è¯†åˆ«å±•ç¤ºé¡µé¢

åŠŸèƒ½ï¼š
1. é‡æ¯”BUGä¿®å¤å±•ç¤º
2. æµåŠ¨æ€§é™·é˜±è¯†åˆ«
3. çœŸé¾™è¯†åˆ«ç³»ç»Ÿ
4. ç­–ç•¥ä»²è£åº­ä¸€ç¥¨å¦å†³
"""

import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import plotly.express as px
from typing import Dict, Any


def render_v81_features_tab(db, config):
    """æ¸²æŸ“V8.1æ–°åŠŸèƒ½æ ‡ç­¾é¡µ"""
    st.subheader("ğŸ›¡ï¸ V8.1 æµåŠ¨æ€§ä¸çœŸé¾™è¯†åˆ« - ä»é‡æ¯”BUGåˆ°çœŸé¾™è¯†åˆ«")
    
    # åˆ›å»ºå››ä¸ªå­æ ‡ç­¾é¡µ
    tab1, tab2, tab3, tab4 = st.tabs([
        "ğŸ› é‡æ¯”BUGä¿®å¤",
        "âš ï¸ æµåŠ¨æ€§é™·é˜±è¯†åˆ«",
        "ğŸ‰ çœŸé¾™è¯†åˆ«ç³»ç»Ÿ",
        "ğŸš« ç­–ç•¥ä»²è£åº­ä¸€ç¥¨å¦å†³"
    ])
    
    # Tab 1: é‡æ¯”BUGä¿®å¤
    with tab1:
        st.markdown("### ğŸ› é‡æ¯”BUGä¿®å¤ (V8.1)")
        st.markdown("""
        **æ ¸å¿ƒé—®é¢˜**ï¼šé‡æ¯”è®¡ç®—å•ä½æ¢ç®—é”™è¯¯
        
        - **é—®é¢˜**ï¼šå†å²æ•°æ®volumeæ˜¯è‚¡æ•°ï¼ˆæ¥è‡ªakshareï¼‰ï¼Œéœ€è¦è½¬æ¢ä¸ºæ‰‹æ•°ï¼ˆé™¤ä»¥100ï¼‰
        - **é—®é¢˜**ï¼šå®æ—¶æ•°æ®volumeæ˜¯è‚¡æ•°ï¼ˆæ¥è‡ªeasyquotationï¼‰ï¼Œä¹Ÿéœ€è¦è½¬æ¢ä¸ºæ‰‹æ•°
        - **ä¿®å¤**ï¼šåœ¨è®¡ç®—é‡æ¯”æ—¶ï¼Œå°†volumeé™¤ä»¥100è½¬æ¢ä¸ºæ‰‹æ•°
        - **æ¡ˆä¾‹**ï¼šç¥æ€ç”µå­ï¼ˆ300479ï¼‰é‡æ¯”ä»12577å€ä¿®å¤ä¸º125å€
        """)
        
        st.markdown("#### ğŸ“Š é‡æ¯”ä¿®å¤å‰åå¯¹æ¯”")
        
        # æ¨¡æ‹Ÿé‡æ¯”ä¿®å¤å‰åå¯¹æ¯”
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("ä¿®å¤å‰", "12577å€", "å¼‚å¸¸æ”¾å¤§", delta_color="inverse")
        
        with col2:
            st.metric("ä¿®å¤å", "125å€", "æ­£å¸¸æ”¾é‡", delta_color="normal")
        
        with col3:
            st.metric("ä¿®æ­£å€æ•°", "100å€", "å•ä½æ¢ç®—", delta_color="normal")
        
        st.markdown("#### ğŸ” é‡æ¯”ä¿®å¤é€»è¾‘")
        st.code("""
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
avg_volume = df['volume'].tail(5).mean()  # è‚¡æ•°
current_volume = realtime_data_item.get('volume', 0)  # è‚¡æ•°
volume_ratio = current_volume / avg_volume  # ç»“æœï¼š12577å€

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
avg_volume = df['volume'].tail(5).mean() / 100  # è½¬æ¢ä¸ºæ‰‹æ•°
current_volume = realtime_data_item.get('volume', 0) / 100  # è½¬æ¢ä¸ºæ‰‹æ•°
volume_ratio = current_volume / avg_volume  # ç»“æœï¼š125å€
        """, language='python')
        
        st.markdown("#### ğŸ“ˆ é‡æ¯”åˆ†å¸ƒå¯è§†åŒ–")
        
        # æ¨¡æ‹Ÿé‡æ¯”åˆ†å¸ƒæ•°æ®
        np.random.seed(42)
        n_stocks = 100
        volume_ratios = np.random.lognormal(mean=1, sigma=1, size=n_stocks)
        
        fig = px.histogram(
            x=volume_ratios,
            nbins=50,
            title='é‡æ¯”åˆ†å¸ƒï¼ˆä¿®å¤åï¼‰',
            labels={'x': 'é‡æ¯”', 'y': 'è‚¡ç¥¨æ•°é‡'}
        )
        
        # æ·»åŠ é˜ˆå€¼çº¿
        fig.add_vline(x=1.5, line_dash="dash", line_color="yellow", annotation_text="æ¸©å’Œæ”¾é‡")
        fig.add_vline(x=3.0, line_dash="dash", line_color="orange", annotation_text="æ”¾é‡")
        fig.add_vline(x=5.0, line_dash="dash", line_color="red", annotation_text="æ”»å‡»æ€§æ”¾é‡")
        fig.add_vline(x=50.0, line_dash="dash", line_color="purple", annotation_text="é‡å¤§åˆ©å¥½")
        
        st.plotly_chart(fig, use_container_width=True)
        
        st.markdown("""
        **é‡æ¯”è§£è¯»æ ‡å‡†**ï¼š
        - < 0.5ï¼šç¼©é‡ï¼Œèµ„é‡‘ä¸æ´»è·ƒ
        - 0.5 - 1.5ï¼šæ­£å¸¸é‡ï¼Œèµ°åŠ¿å¹³ç¨³
        - 1.5 - 3.0ï¼šæ¸©å’Œæ”¾é‡ï¼Œèµ„é‡‘æ´»è·ƒ
        - 3.0 - 5.0ï¼šæ”¾é‡ï¼Œèµ„é‡‘æŠ¢ç­¹
        - 5.0 - 50.0ï¼šæ”»å‡»æ€§æ”¾é‡ï¼Œå¼ºåŠ¿è‚¡
        - > 50.0ï¼šé‡å¤§åˆ©å¥½æˆ–ä¸€å­—æ¿
        """)
    
    # Tab 2: æµåŠ¨æ€§é™·é˜±è¯†åˆ«
    with tab2:
        st.markdown("### âš ï¸ æµåŠ¨æ€§é™·é˜±è¯†åˆ« (V8.1)")
        st.markdown("""
        **æ ¸å¿ƒé—®é¢˜**ï¼šç¼©é‡æ‹‰å‡é™·é˜±
        
        - **ç°è±¡**ï¼šæ¶¨å¹…å¾ˆå¤§ï¼Œä½†ç«ä»·é‡å¾ˆå°
        - **é£é™©**ï¼šä¸»åŠ›æ²¡æœ‰èŠ±å¤§é’±æ‹‰å‡ï¼Œå®¹æ˜“ç‚¸æ¿
        - **ç‰¹å¾**ï¼šç«ä»·é‡‘é¢<500ä¸‡ï¼Œç«ä»·æŠ¢ç­¹åº¦<2%ï¼Œæ¶¨å¹…>5%
        - **æ¡ˆä¾‹**ï¼šç¥æ€ç”µå­ï¼ˆ300479ï¼‰ç«ä»·é‡449æ‰‹ï¼ˆ104ä¸‡ï¼‰ï¼Œæ¶¨å¹…12.83%
        """)
        
        st.markdown("#### ğŸš¨ æµåŠ¨æ€§é™·é˜±æ¡ˆä¾‹")
        
        # æ¨¡æ‹Ÿç¥æ€ç”µå­æ•°æ®
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("æœ€æ–°ä»·", "Â¥23.31", "+12.83%", delta_color="normal")
        
        with col2:
            st.metric("ç«ä»·é‡", "449æ‰‹", "æµåŠ¨æ€§ä¸è¶³", delta_color="inverse")
        
        with col3:
            st.metric("ç«ä»·é‡‘é¢", "Â¥104ä¸‡", "<500ä¸‡", delta_color="inverse")
        
        st.markdown("#### ğŸ“Š æµåŠ¨æ€§é™·é˜±åˆ¤å®šæ¡ä»¶")
        
        trap_conditions = pd.DataFrame({
            'æŒ‡æ ‡': ['ç«ä»·é‡‘é¢', 'ç«ä»·æŠ¢ç­¹åº¦', 'æ¶¨è·Œå¹…'],
            'é˜ˆå€¼': ['< 500ä¸‡', '< 2%', '> 5%'],
            'ç¥æ€ç”µå­': ['104ä¸‡ âŒ', '1.12% âŒ', '12.83% âœ…'],
            'åˆ¤å®š': ['æµåŠ¨æ€§ä¸è¶³', 'ä¸»åŠ›æœªæŠ¢ç­¹', 'çœ‹ä¼¼å¼ºåŠ¿'],
            'ç»“è®º': ['âš ï¸ ç¼©é‡æ‹‰å‡é™·é˜±', 'âš ï¸ ç¼©é‡æ‹‰å‡é™·é˜±', 'âš ï¸ ç¼©é‡æ‹‰å‡é™·é˜±']
        })
        
        st.dataframe(trap_conditions, use_container_width=True)
        
        st.markdown("#### ğŸ” æµåŠ¨æ€§é™·é˜±è¯†åˆ«é€»è¾‘")
        st.code("""
def detect_liquidity_trap(auction_amount, auction_ratio, change_pct, ask1_price, seal_amount, symbol):
    \"\"\"\n    æµåŠ¨æ€§é™·é˜±æ£€æµ‹
    
    Args:
        auction_amount: ç«ä»·é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰
        auction_ratio: ç«ä»·æŠ¢ç­¹åº¦
        change_pct: æ¶¨è·Œå¹…ï¼ˆ%ï¼‰
        ask1_price: å–ä¸€ä»·
        seal_amount: å°å•é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰
        symbol: è‚¡ç¥¨ä»£ç 
    
    Returns:
        tuple: (æ˜¯å¦é™·é˜±, åŸå› )
    \"\"\"\n    # æµåŠ¨æ€§é™·é˜±æ¡ä»¶
    is_trap = auction_amount < 500 and auction_ratio < 0.02 and change_pct > 5
    
    # ğŸ†• V8.2: è±å…é€»è¾‘ - ç»å¯¹ä¸€å­—æ¿é¾™å¤´ï¼ˆThe Absolute One-Word Boardï¼‰
    # è±å…æ¡ä»¶ï¼šå¦‚æœæ˜¯"ä¸€å­—æ¶¨åœ"ä¸”"å°å•å·¨å¤§"ï¼ˆå°å•é¢>1äº¿ï¼‰
    is_super_one_word = (ask1_price == 0 and change_pct >= 19.5 and seal_amount > 10000)
    
    # ğŸ†• V8.3: è±å…é€»è¾‘ - æ¬¡æ–°è‚¡ï¼ˆSub-New Stockï¼‰
    # è±å…æ¡ä»¶ï¼šå¦‚æœæ˜¯æ¬¡æ–°è‚¡ï¼ˆä»£ç ä»¥301ã€303ã€688å¼€å¤´ï¼‰ä¸”ç¼©é‡æƒœå”®
    # æ¬¡æ–°è‚¡ç‰¹æ€§ï¼šç­¹ç ç¨³å®šï¼Œæƒœå”®ç¼©é‡ï¼Œç‚’ä½œé€»è¾‘æ˜¯æƒ…ç»ªåšå¼ˆï¼Œä¸æ˜¯ä¸šç»©é©±åŠ¨
    is_sub_new = (symbol.startswith('301') or symbol.startswith('303') or symbol.startswith('688')) and auction_amount < 500
    
    if is_trap and is_super_one_word:
        return False, f"âœ… è±å…ï¼šç¼©é‡ä¸€å­—æ¿çœŸé¾™ï¼ˆå°å•é‡‘é¢{seal_amount:.0f}ä¸‡>1äº¿ï¼‰"
    elif is_trap and is_sub_new:
        return False, f"âœ… è±å…ï¼šæ¬¡æ–°è‚¡æƒœå”®ï¼ˆç«ä»·é‡‘é¢{auction_amount:.0f}ä¸‡<500ä¸‡ï¼Œç­¹ç ç¨³å®šï¼‰"
    elif is_trap:
        return True, f"âš ï¸ æµåŠ¨æ€§é™·é˜±ï¼šç«ä»·é‡‘é¢{auction_amount:.0f}ä¸‡<500ä¸‡ï¼Œç«ä»·æŠ¢ç­¹åº¦{auction_ratio*100:.2f}%<2%ï¼Œç¼©é‡æ‹‰å‡"
    
    return False, ""
        """, language='python')
        
        st.markdown("#### ğŸ†• V8.2: ä¸€å­—æ¿é¾™å¤´è±å…")
        st.markdown("""
        **è±å…æ¡ä»¶**ï¼š
        - ä¸€å­—æ¶¨åœï¼šå–ä¸€ä»·=0 ä¸” æ¶¨å¹…>=19.5%
        - å°å•å·¨å¤§ï¼šå°å•é‡‘é¢>1äº¿ï¼ˆä¹°ä¸€é‡*ä»·æ ¼ï¼‰
        
        **è±å…åŸå› **ï¼š
        - è¿™ç§æƒ…å†µé€šå¸¸æ˜¯é‡ç»„å¤ç‰Œç­‰è¶…çº§åˆ©å¥½ï¼Œä¹°éƒ½ä¹°ä¸åˆ°
        - ä¸æ˜¯æµåŠ¨æ€§é™·é˜±ï¼Œè€Œæ˜¯"ä¹°ä¸åˆ°çš„æœ€å¼ºé¾™"
        - å¦‚æœä¸åŠ è±å…ï¼Œä¼šé”™è¿‡æœ€å¼ºçš„è¿æ¿ç¥¨
        
        **æ¡ˆä¾‹**ï¼šæŸé‡ç»„å¤ç‰Œè‚¡ï¼Œç«ä»·æˆäº¤é¢50ä¸‡ï¼Œå°å•é‡‘é¢2äº¿ï¼Œå¼€ç›˜ä¸€å­—æ¶¨åœ
        """)
        
        st.markdown("#### ğŸ†• V8.3: æ¬¡æ–°è‚¡è±å…")
        st.markdown("""
        **è±å…æ¡ä»¶**ï¼š
        - æ¬¡æ–°è‚¡ï¼šä»£ç ä»¥301ã€303ã€688å¼€å¤´
        - ç¼©é‡æƒœå”®ï¼šç«ä»·é‡‘é¢<500ä¸‡
        
        **è±å…åŸå› **ï¼š
        - æ¬¡æ–°è‚¡ç‰¹æ€§ï¼šç­¹ç ç¨³å®šï¼Œæƒœå”®ç¼©é‡
        - ç‚’ä½œé€»è¾‘ï¼šæƒ…ç»ªåšå¼ˆï¼Œä¸æ˜¯ä¸šç»©é©±åŠ¨
        - é«˜ä»·è‚¡ç‰¹å¾ï¼šæ•£æˆ·å°‘ï¼Œæœºæ„å’Œæ¸¸èµ„å¥½æ§ç›˜
        - å¦‚æœä¸åŠ è±å…ï¼Œä¼šé”™è¿‡æ¬¡æ–°è‚¡çš„ç¼©é‡åŠ é€Ÿæœºä¼š
        
        **æ¡ˆä¾‹**ï¼šå®å·¥ç§‘æŠ€ï¼ˆ301662ï¼‰ï¼Œç«ä»·æˆäº¤é¢16ä¸‡ï¼Œæ¶¨å¹…10.72%ï¼Œæ¬¡æ–°è‚¡æƒœå”®
        """)
        
        st.markdown("#### ğŸ“Š æµåŠ¨æ€§é™·é˜±vsæ­£å¸¸å¼ºåŠ¿è‚¡vsä¸€å­—æ¿é¾™å¤´vsæ¬¡æ–°è‚¡å¯¹æ¯”")
        
        # æ¨¡æ‹Ÿå¯¹æ¯”æ•°æ®
        comparison_data = pd.DataFrame({
            'è‚¡ç¥¨': ['ç¥æ€ç”µå­ï¼ˆé™·é˜±ï¼‰', 'ä¸‡ä¸°å¥¥å¨ï¼ˆçœŸé¾™ï¼‰', 'ä¸­ä¿¡æµ·ç›´ï¼ˆçœŸé¾™ï¼‰', 'æŸé‡ç»„å¤ç‰Œï¼ˆä¸€å­—æ¿é¾™å¤´ï¼‰', 'å®å·¥ç§‘æŠ€ï¼ˆæ¬¡æ–°è‚¡ï¼‰'],
            'æœ€æ–°ä»·': ['Â¥23.31', 'Â¥18.50', 'Â¥15.20', 'Â¥30.00', 'Â¥166.95'],
            'æ¶¨è·Œå¹…': ['+12.83%', '+10.50%', '+9.80%', '+20.00%', '+10.72%'],
            'ç«ä»·é‡': ['449æ‰‹', '5000æ‰‹', '4500æ‰‹', '100æ‰‹', '10æ‰‹'],
            'ç«ä»·é‡‘é¢': ['Â¥104ä¸‡', 'Â¥925ä¸‡', 'Â¥684ä¸‡', 'Â¥30ä¸‡', 'Â¥16ä¸‡'],
            'ç«ä»·æŠ¢ç­¹åº¦': ['1.12%', '3.50%', '2.80%', '0.50%', '0.08%'],
            'å°å•é‡‘é¢': ['Â¥0ä¸‡', 'Â¥0ä¸‡', 'Â¥0ä¸‡', 'Â¥20000ä¸‡', 'Â¥0ä¸‡'],
            'æˆäº¤é¢': ['Â¥2000ä¸‡', 'Â¥8000ä¸‡', 'Â¥6500ä¸‡', 'Â¥300ä¸‡', 'Â¥5000ä¸‡'],
            'æµåŠ¨æ€§é™·é˜±': ['âš ï¸ æ˜¯', 'âœ… å¦', 'âœ… å¦', 'âœ… è±å…', 'âœ… è±å…'],
            'æ“ä½œå»ºè®®': ['âŒ ä¸ä¹°', 'âœ… ä¹°å…¥', 'âœ… ä¹°å…¥', 'âœ… ä¹°å…¥ï¼ˆä¸€å­—æ¿ï¼‰', 'âš ï¸ è§‚å¯Ÿï¼ˆæ¬¡æ–°è‚¡æƒœå”®ï¼‰']
        })
        
        st.dataframe(comparison_data, use_container_width=True)
        
        # æµåŠ¨æ€§é™·é˜±å¯è§†åŒ–
        st.markdown("#### ğŸ“Š ç«ä»·é‡‘é¢vsæ¶¨è·Œå¹…æ•£ç‚¹å›¾")
        
        # æ¨¡æ‹Ÿæ•£ç‚¹æ•°æ®
        np.random.seed(42)
        n_stocks = 50
        auction_amounts = np.random.uniform(100, 3000, n_stocks)
        pct_changes = np.random.uniform(-5, 20, n_stocks)
        
        # æ·»åŠ ä¸€äº›æµåŠ¨æ€§é™·é˜±
        trap_indices = np.random.choice(n_stocks, 10, replace=False)
        auction_amounts[trap_indices] = np.random.uniform(100, 500, 10)
        pct_changes[trap_indices] = np.random.uniform(5, 15, 10)
        
        # æ·»åŠ ä¸€äº›çœŸé¾™
        dragon_indices = np.random.choice([i for i in range(n_stocks) if i not in trap_indices], 5, replace=False)
        auction_amounts[dragon_indices] = np.random.uniform(1500, 2000, 5)
        pct_changes[dragon_indices] = np.random.uniform(8, 15, 5)
        
        # ğŸ†• V8.2: æ·»åŠ ä¸€å­—æ¿é¾™å¤´
        oneword_indices = np.random.choice([i for i in range(n_stocks) if i not in trap_indices and i not in dragon_indices], 3, replace=False)
        auction_amounts[oneword_indices] = np.random.uniform(30, 100, 3)
        pct_changes[oneword_indices] = np.random.uniform(19, 20, 3)
        
        # ğŸ†• V8.3: æ·»åŠ æ¬¡æ–°è‚¡
        subnew_indices = np.random.choice([i for i in range(n_stocks) if i not in trap_indices and i not in dragon_indices and i not in oneword_indices], 3, replace=False)
        auction_amounts[subnew_indices] = np.random.uniform(10, 50, 3)
        pct_changes[subnew_indices] = np.random.uniform(8, 15, 3)
        
        # æ ‡è®°
        labels = ['æ­£å¸¸'] * n_stocks
        for i in trap_indices:
            labels[i] = 'æµåŠ¨æ€§é™·é˜±'
        for i in dragon_indices:
            labels[i] = 'çœŸé¾™'
        for i in oneword_indices:
            labels[i] = 'ä¸€å­—æ¿é¾™å¤´'
        for i in subnew_indices:
            labels[i] = 'æ¬¡æ–°è‚¡'
        
        df_scatter = pd.DataFrame({
            'æ¶¨è·Œå¹…': pct_changes,
            'ç«ä»·é‡‘é¢': auction_amounts,
            'ç±»å‹': labels
        })
        
        fig = px.scatter(
            df_scatter,
            x='æ¶¨è·Œå¹…',
            y='ç«ä»·é‡‘é¢',
            color='ç±»å‹',
            title='ç«ä»·é‡‘é¢vsæ¶¨è·Œå¹…ï¼ˆè¯†åˆ«æµåŠ¨æ€§é™·é˜±ã€ä¸€å­—æ¿é¾™å¤´å’Œæ¬¡æ–°è‚¡ï¼‰',
            color_discrete_map={
                'æ­£å¸¸': 'blue',
                'æµåŠ¨æ€§é™·é˜±': 'red',
                'çœŸé¾™': 'green',
                'ä¸€å­—æ¿é¾™å¤´': 'purple',
                'æ¬¡æ–°è‚¡': 'orange'
            }
        )
        
        # æ·»åŠ é˜ˆå€¼çº¿
        fig.add_hline(y=500, line_dash="dash", line_color="red", annotation_text="500ä¸‡é˜ˆå€¼")
        fig.add_vline(x=5, line_dash="dash", line_color="orange", annotation_text="5%é˜ˆå€¼")
        fig.add_vline(x=19.5, line_dash="dash", line_color="purple", annotation_text="19.5%ä¸€å­—æ¿")
        
        st.plotly_chart(fig, use_container_width=True)
        
        st.markdown("""
        **è§£è¯»**ï¼š
        - **çº¢è‰²åŒºåŸŸ**ï¼ˆç«ä»·é‡‘é¢<500ä¸‡ ä¸” æ¶¨å¹…>5%ï¼‰ï¼šæµåŠ¨æ€§é™·é˜±ï¼Œä¸ä¹°
        - **ç»¿è‰²åŒºåŸŸ**ï¼ˆç«ä»·é‡‘é¢>1500ä¸‡ ä¸” æ¶¨å¹…>8%ï¼‰ï¼šçœŸé¾™ï¼Œä¹°å…¥
        - **ç´«è‰²åŒºåŸŸ**ï¼ˆæ¶¨å¹…>19.5%ï¼‰ï¼šä¸€å­—æ¿é¾™å¤´ï¼Œè±å…æµåŠ¨æ€§é™·é˜±ï¼Œä¹°å…¥
        - **æ©™è‰²åŒºåŸŸ**ï¼ˆç«ä»·é‡‘é¢<500ä¸‡ï¼Œä½†ä»£ç ä»¥301/303/688å¼€å¤´ï¼‰ï¼šæ¬¡æ–°è‚¡ï¼Œè±å…æµåŠ¨æ€§é™·é˜±ï¼Œè§‚å¯Ÿ
        - **è“è‰²åŒºåŸŸ**ï¼šæ­£å¸¸è§‚å¯Ÿ
        """)
    
    # Tab 3: çœŸé¾™è¯†åˆ«ç³»ç»Ÿ
    with tab3:
        st.markdown("### ğŸ‰ çœŸé¾™è¯†åˆ«ç³»ç»Ÿ (V8.1)")
        st.markdown("""
        **æ ¸å¿ƒåŠŸèƒ½**ï¼šåŒºåˆ†é¾™å¤´vsè·Ÿé£
        
        - **çœŸé¾™**ï¼šæˆäº¤é¢>5000ä¸‡ï¼Œç«ä»·æŠ¢ç­¹åº¦>2%ï¼Œæ¶¨å¹…>10%
        - **å¼ºè·Ÿé£**ï¼šæˆäº¤é¢>2000ä¸‡ï¼Œç«ä»·æŠ¢ç­¹åº¦>1%ï¼Œæ¶¨å¹…>8%
        - **å¼±è·Ÿé£**ï¼šæˆäº¤é¢<2000ä¸‡æˆ–ç«ä»·æŠ¢ç­¹åº¦<1%
        - **æ‚æ¯›**ï¼šæˆäº¤é¢<500ä¸‡æˆ–ç«ä»·æŠ¢ç­¹åº¦<1%
        """)
        
        st.markdown("#### ğŸ“Š çœŸé¾™è¯†åˆ«æ ‡å‡†")
        
        dragon_standards = pd.DataFrame({
            'ç±»å‹': ['ğŸ‰ çœŸé¾™', 'ğŸ² å¼ºè·Ÿé£', 'ğŸ¦† å¼±è·Ÿé£', 'ğŸ› æ‚æ¯›'],
            'æˆäº¤é¢': ['> 5000ä¸‡', '> 2000ä¸‡', '< 2000ä¸‡', '< 500ä¸‡'],
            'ç«ä»·æŠ¢ç­¹åº¦': ['> 2%', '> 1%', '< 1%', '< 1%'],
            'æ¶¨å¹…': ['> 10%', '> 8%', 'ä»»æ„', 'ä»»æ„'],
            'æ“ä½œå»ºè®®': ['âœ… ä¹°å…¥', 'âš ï¸ è§‚å¯Ÿåä¹°å…¥', 'âŒ ä¸ä¹°', 'âŒ ä¸ä¹°']
        })
        
        st.dataframe(dragon_standards, use_container_width=True)
        
        st.markdown("#### ğŸ“Š æˆäº¤é¢vsç«ä»·æŠ¢ç­¹åº¦æ•£ç‚¹å›¾")
        
        # æ¨¡æ‹Ÿæ•£ç‚¹æ•°æ®
        np.random.seed(42)
        n_stocks = 50
        turnovers = np.random.uniform(100, 10000, n_stocks)
        auction_ratios = np.random.uniform(0.1, 5, n_stocks)
        
        # æ ‡è®°
        dragon_labels = []
        for i in range(n_stocks):
            if turnovers[i] > 5000 and auction_ratios[i] > 2:
                dragon_labels.append('ğŸ‰ çœŸé¾™')
            elif turnovers[i] > 2000 and auction_ratios[i] > 1:
                dragon_labels.append('ğŸ² å¼ºè·Ÿé£')
            elif turnovers[i] < 500 or auction_ratios[i] < 1:
                dragon_labels.append('ğŸ› æ‚æ¯›')
            else:
                dragon_labels.append('ğŸ¦† å¼±è·Ÿé£')
        
        df_dragon_scatter = pd.DataFrame({
            'æˆäº¤é¢': turnovers,
            'ç«ä»·æŠ¢ç­¹åº¦': auction_ratios,
            'çœŸé¾™ç±»å‹': dragon_labels
        })
        
        fig = px.scatter(
            df_dragon_scatter,
            x='æˆäº¤é¢',
            y='ç«ä»·æŠ¢ç­¹åº¦',
            color='çœŸé¾™ç±»å‹',
            title='æˆäº¤é¢vsç«ä»·æŠ¢ç­¹åº¦ï¼ˆçœŸé¾™è¯†åˆ«ï¼‰',
            color_discrete_map={
                'ğŸ‰ çœŸé¾™': 'green',
                'ğŸ² å¼ºè·Ÿé£': 'blue',
                'ğŸ¦† å¼±è·Ÿé£': 'orange',
                'ğŸ› æ‚æ¯›': 'red'
            }
        )
        
        # æ·»åŠ é˜ˆå€¼çº¿
        fig.add_vline(x=5000, line_dash="dash", line_color="green", annotation_text="5000ä¸‡")
        fig.add_vline(x=2000, line_dash="dash", line_color="blue", annotation_text="2000ä¸‡")
        fig.add_vline(x=500, line_dash="dash", line_color="red", annotation_text="500ä¸‡")
        fig.add_hline(y=2, line_dash="dash", line_color="green", annotation_text="2%")
        fig.add_hline(y=1, line_dash="dash", line_color="blue", annotation_text="1%")
        
        st.plotly_chart(fig, use_container_width=True)
        
        st.markdown("""
        **è§£è¯»**ï¼š
        - **ç»¿è‰²åŒºåŸŸ**ï¼ˆæˆäº¤é¢>5000ä¸‡ ä¸” ç«ä»·æŠ¢ç­¹åº¦>2%ï¼‰ï¼šçœŸé¾™ï¼Œä¹°å…¥
        - **è“è‰²åŒºåŸŸ**ï¼ˆæˆäº¤é¢>2000ä¸‡ ä¸” ç«ä»·æŠ¢ç­¹åº¦>1%ï¼‰ï¼šå¼ºè·Ÿé£ï¼Œè§‚å¯Ÿåä¹°å…¥
        - **æ©™è‰²åŒºåŸŸ**ï¼šå¼±è·Ÿé£ï¼Œä¸ä¹°
        - **çº¢è‰²åŒºåŸŸ**ï¼ˆæˆäº¤é¢<500ä¸‡ æˆ– ç«ä»·æŠ¢ç­¹åº¦<1%ï¼‰ï¼šæ‚æ¯›ï¼Œä¸ä¹°
        """)
    
    # Tab 4: ç­–ç•¥ä»²è£åº­ä¸€ç¥¨å¦å†³
    with tab4:
        st.markdown("### ğŸš« ç­–ç•¥ä»²è£åº­ä¸€ç¥¨å¦å†³ (V8.3)")
        st.markdown("""
        **æ ¸å¿ƒåŠŸèƒ½**ï¼šæµåŠ¨æ€§ä¸è¶³çš„ä¸€ç¥¨å¦å†³
        
        - **æµåŠ¨æ€§é™·é˜±**ï¼šç¼©é‡æ‹‰å‡ï¼Œä¸€ç¥¨å¦å†³
        - **æ‚æ¯›è‚¡**ï¼šæˆäº¤é¢<500ä¸‡æˆ–ç«ä»·æŠ¢ç­¹åº¦<1%ï¼Œä¸€ç¥¨å¦å†³
        - **å¼±è·Ÿé£**ï¼šæˆäº¤é¢<2000ä¸‡æˆ–ç«ä»·æŠ¢ç­¹åº¦<1%ï¼Œä¸€ç¥¨å¦å†³
        - **ğŸ†• V8.2 è±å…**ï¼šä¸€å­—æ¿é¾™å¤´ï¼ˆå°å•é‡‘é¢>1äº¿ï¼‰ï¼Œè±å…æµåŠ¨æ€§é™·é˜±
        - **ğŸ†• V8.3 è±å…**ï¼šæ¬¡æ–°è‚¡ï¼ˆä»£ç ä»¥301/303/688å¼€å¤´ï¼‰ï¼Œè±å…æµåŠ¨æ€§é™·é˜±
        """)
        
        st.markdown("#### ğŸ›¡ï¸ ä¸€ç¥¨å¦å†³è§„åˆ™")
        
        veto_rules = pd.DataFrame({
            'å¦å†³ç±»å‹': ['æµåŠ¨æ€§é™·é˜±', 'æ‚æ¯›è‚¡', 'å¼±è·Ÿé£', 'ä¸€å­—æ¿é¾™å¤´è±å…', 'æ¬¡æ–°è‚¡è±å…'],
            'è§¦å‘æ¡ä»¶': ['ç«ä»·é‡‘é¢<500ä¸‡ ä¸” ç«ä»·æŠ¢ç­¹åº¦<2% ä¸” æ¶¨å¹…>5%', 'æˆäº¤é¢<500ä¸‡ æˆ– ç«ä»·æŠ¢ç­¹åº¦<1%', 'æˆäº¤é¢<2000ä¸‡ æˆ– ç«ä»·æŠ¢ç­¹åº¦<1%', 'ä¸€å­—æ¶¨åœ ä¸” å°å•é‡‘é¢>1äº¿', 'æ¬¡æ–°è‚¡ï¼ˆ301/303/688ï¼‰ä¸” ç«ä»·é‡‘é¢<500ä¸‡'],
            'å¦å†³åŠ¨ä½œ': ['ä¸€ç¥¨å¦å†³', 'ä¸€ç¥¨å¦å†³', 'ä¸€ç¥¨å¦å†³', 'è±å…', 'è±å…'],
            'æ¡ˆä¾‹': ['ç¥æ€ç”µå­ï¼ˆ300479ï¼‰', 'æŸå°ç›˜è‚¡', 'æŸè·Ÿé£è‚¡', 'æŸé‡ç»„å¤ç‰Œè‚¡', 'å®å·¥ç§‘æŠ€ï¼ˆ301662ï¼‰'],
            'æ“ä½œå»ºè®®': ['âŒ ä¸ä¹°', 'âŒ ä¸ä¹°', 'âŒ ä¸ä¹°', 'âœ… ä¹°å…¥', 'âš ï¸ è§‚å¯Ÿ']
        })
        
        st.dataframe(veto_rules, use_container_width=True)
        
        st.markdown("#### ğŸ”„ å†³ç­–æµç¨‹")
        st.code("""
def final_judgement(stock_signal, market_status, theme_info):
    \"\"\"\n    æœ€ç»ˆè£å†³æµç¨‹
    
    1. ä¸€ç¥¨å¦å†³æƒæ£€æŸ¥
       - é€€æ½®æœŸä¸€ç¥¨å¦å†³ï¼ˆé™¤éåæ ¸ï¼‰
       - é«˜æ½®æœŸä¸€ç¥¨å¦å†³æ‰“æ¿
       - STè‚¡ç¥¨ä¸€ç¥¨å¦å†³
       - æµåŠ¨æ€§é™·é˜±ä¸€ç¥¨å¦å†³ï¼ˆV8.1ï¼‰
       - æ‚æ¯›è‚¡ä¸€ç¥¨å¦å†³ï¼ˆV8.1ï¼‰
       - å¼±è·Ÿé£ä¸€ç¥¨å¦å†³ï¼ˆV8.1ï¼‰
       - ğŸ†• V8.2: ä¸€å­—æ¿é¾™å¤´è±å…
       - ğŸ†• V8.3: æ¬¡æ–°è‚¡è±å…
    
    2. æ—¥å†…å¼±è½¬å¼ºæ£€æµ‹ï¼ˆV9.0ï¼‰
       - æ£€æµ‹ç«ä»·å¼±ä½†å¼€ç›˜åæ‰¿æ¥å¼ºçš„æœºä¼š
       - ä¿®æ­£è¯„åˆ†+20~+50åˆ†
    
    3. åŠ æƒæ‰“åˆ†
       - å¸‚åœºç¯å¢ƒå¾—åˆ†ï¼ˆ50%ï¼‰
       - æ¿å—åœ°ä½å¾—åˆ†ï¼ˆ30%ï¼‰
       - ä¸ªè‚¡æŠ€æœ¯é¢å¾—åˆ†ï¼ˆ20%ï¼‰
    
    4. è¾“å‡ºå†³ç­–
       - BUY: ç»¼åˆå¾—åˆ†>=80ï¼Œå»ºè®®ä¹°å…¥
       - BUY: ç»¼åˆå¾—åˆ†>=60ï¼Œå»ºè®®è½»ä»“ä¹°å…¥
       - WAIT: ç»¼åˆå¾—åˆ†>=40ï¼Œå»ºè®®è§‚æœ›
       - REJECT: ç»¼åˆå¾—åˆ†<40ï¼Œå»ºè®®æ”¾å¼ƒ
    \"\"\"\n        """, language='python')
        
        st.markdown("#### ğŸš¨ æ¡ˆä¾‹å±•ç¤ºï¼šä¸€å­—æ¿é¾™å¤´è±å…")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("æœ€æ–°ä»·", "Â¥30.00", "+20.00%", delta_color="normal")
        
        with col2:
            st.metric("ç«ä»·é‡‘é¢", "Â¥30ä¸‡", "çœ‹ä¼¼æµåŠ¨æ€§ä¸è¶³", delta_color="inverse")
        
        with col3:
            st.metric("å°å•é‡‘é¢", "Â¥20000ä¸‡", "å°å•å·¨å¤§", delta_color="normal")
        
        st.markdown("""
        **åˆ¤å®šè¿‡ç¨‹**ï¼š
        1. æ£€æµ‹åˆ°ç«ä»·é‡‘é¢<500ä¸‡ï¼Œè§¦å‘æµåŠ¨æ€§é™·é˜±æ£€æµ‹
        2. æ£€æµ‹åˆ°ä¸€å­—æ¶¨åœï¼ˆå–ä¸€ä»·=0ï¼Œæ¶¨å¹…=20%ï¼‰
        3. æ£€æµ‹åˆ°å°å•é‡‘é¢>1äº¿ï¼ˆ2äº¿ï¼‰
        4. è§¦å‘ä¸€å­—æ¿é¾™å¤´è±å…
        5. ä¸è¿›è¡Œä¸€ç¥¨å¦å†³ï¼Œå…è®¸ä¹°å…¥
        
        **è±å…åŸå› **ï¼š
        - é‡ç»„å¤ç‰Œç­‰è¶…çº§åˆ©å¥½ï¼Œä¹°éƒ½ä¹°ä¸åˆ°
        - ä¸æ˜¯æµåŠ¨æ€§é™·é˜±ï¼Œè€Œæ˜¯"ä¹°ä¸åˆ°çš„æœ€å¼ºé¾™"
        - å¦‚æœä¸åŠ è±å…ï¼Œä¼šé”™è¿‡æœ€å¼ºçš„è¿æ¿ç¥¨
        """)
        
        st.markdown("#### ğŸš¨ æ¡ˆä¾‹å±•ç¤ºï¼šæ¬¡æ–°è‚¡è±å…ï¼ˆå®å·¥ç§‘æŠ€301662ï¼‰")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("æœ€æ–°ä»·", "Â¥166.95", "+10.72%", delta_color="normal")
        
        with col2:
            st.metric("ç«ä»·é‡‘é¢", "Â¥16ä¸‡", "çœ‹ä¼¼æµåŠ¨æ€§ä¸è¶³", delta_color="inverse")
        
        with col3:
            st.metric("è‚¡ç¥¨ä»£ç ", "301662", "æ¬¡æ–°è‚¡", delta_color="normal")
        
        st.markdown("""
        **åˆ¤å®šè¿‡ç¨‹**ï¼š
        1. æ£€æµ‹åˆ°ç«ä»·é‡‘é¢<500ä¸‡ï¼Œè§¦å‘æµåŠ¨æ€§é™·é˜±æ£€æµ‹
        2. æ£€æµ‹åˆ°æ¬¡æ–°è‚¡ï¼ˆä»£ç ä»¥301å¼€å¤´ï¼‰
        3. è§¦å‘æ¬¡æ–°è‚¡è±å…
        4. ä¸è¿›è¡Œä¸€ç¥¨å¦å†³ï¼Œå…è®¸è§‚å¯Ÿ
        
        **è±å…åŸå› **ï¼š
        - æ¬¡æ–°è‚¡ç‰¹æ€§ï¼šç­¹ç ç¨³å®šï¼Œæƒœå”®ç¼©é‡
        - ç‚’ä½œé€»è¾‘ï¼šæƒ…ç»ªåšå¼ˆï¼Œä¸æ˜¯ä¸šç»©é©±åŠ¨
        - é«˜ä»·è‚¡ç‰¹å¾ï¼šæ•£æˆ·å°‘ï¼Œæœºæ„å’Œæ¸¸èµ„å¥½æ§ç›˜
        - å¦‚æœä¸åŠ è±å…ï¼Œä¼šé”™è¿‡æ¬¡æ–°è‚¡çš„ç¼©é‡åŠ é€Ÿæœºä¼š
        
        **æ“ä½œå»ºè®®**ï¼š
        - è§‚å¯Ÿä¸ºä¸»ï¼Œä¸ç›²ç›®è¿½é«˜
        - æ¬¡æ–°è‚¡æµåŠ¨æ€§æ¯ç«­ï¼Œä¸€æ—¦å¼€æ¿å°±æ˜¯æ ¸æŒ‰é’®
        - è¿›å¾—å»å‡ºä¸æ¥ï¼Œé£é™©æé«˜
        """)