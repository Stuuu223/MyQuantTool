# Phase 1: 单股票监控增强（QPST四维分析）

> **阶段目标**：在不影响现有系统的前提下，实现单股票四维实时监控，验证算法有效性
> **验证周期**：2-4周实盘观察
> **成功标准**：捕捉到 ≥3次诱多预警，事后验证准确率 >70%

---

## 🎯 核心功能

### 1. QPST四维分析框架

| 维度 | 英文名 | 检测内容 | 机构特征 | 散户/诱多特征 |
|------|----------|----------|----------|----------------|
| **量** | Quantity | 成交量脉冲 | 持续放量，波动率低 | 单次巨量，波动率高 |
| **价** | Price | 价格形态 | 稳步上涨，波动小 | 暴力拉升，波动大 |
| **空** | Space | 换手率 | 中等稳定（5-8%） | 极高(>10%)或极低(<2%) |
| **时** | Time | 持续时间 | 持续10分钟+ | 3秒冲高或尾盘拉升 |

**投票机制**：
- 4维同时符合 → `STRONG_INFLOW` (置信度 85%)
- 3维符合 → `WEAK_INFLOW` (置信度 65%)
- 触发诱多特征 → `TRAP_WARNING` (置信度 90%，**硬刹车**)

### 2. 反诱多检测层（硬刹车）

| 检测类型 | 特征 | 风险级别 |
|----------|------|----------|
| **对倒识别** | 成交量异常但买卖盘挂单几乎不变 | 🔴 高 |
| **尾盘拉升** | 14:30后突然放量，警惕次日低开 | 🔴 高 |
| **连板开板** | 连续涨停后首次开板，可能出货 | 🟠 中 |
| **单边挂单** | 买盘或卖盘长时间为0，可能对敲 | 🟡 低 |

---

## 🚀 快速开始

### 步除1：确认环境

```bash
# 检查Python版本（必须3.10）
python --version
# 输出: Python 3.10.x (64-bit)

# 检查QMT是否登录
# 打开QMT客户端，确认已登录账号
```

### 步除2：切换分支并拉取代码

```bash
cd MyQuantTool
git fetch origin feature/smart-flow-qpst-phase1
git checkout feature/smart-flow-qpst-phase1
```

### 步除3：安装依赖（如果有新增）

```bash
# 激活虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 确认xtquant已安装
pip list | grep xtquant
```

### 步除4：准备股本信息数据

```bash
# 检查股本信息文件是否存在
ls -lh data/equity_info.json

# 如果不存在，使用以下命令生成（需要AkShare）
python tools/fetch_equity_info.py
```

**数据格式**（`data/equity_info.json`）：
```json
{
  "300997.SZ": {
    "name": "欢乐家",
    "float_shares": 150000000.0,
    "total_shares": 200000000.0
  },
  "603697.SH": {
    "name": "有友食品",
    "float_shares": 120000000.0,
    "total_shares": 180000000.0
  }
}
```

### 步除5：启动监控

```bash
# 监控单只股票（300997 欢乐家）
python tasks/monitor_single_stock.py --codes 300997.SZ

# 监控多只股票
python tasks/monitor_single_stock.py --codes 300997.SZ,603697.SH,601869.SH

# 修改刷新间隔（3秒）
python tasks/monitor_single_stock.py --codes 300997.SZ --interval 3
```

---

## 📊 输出示例

```
================================================================================
🚀 单股票实时监控启动
================================================================================
监控股票: 300997.SZ
刷新间隔: 5秒
开始时间: 2026-02-11 12:45:30
================================================================================

[09:35:12] 300997.SZ
  信号: 🟡 WEAK_INFLOW (置信度: 65%)
  原因: 温和流入（量能+价格+换手）
--------------------------------------------------------------------------------

[09:40:25] 300997.SZ
  信号: ⚠️ TRAP_WARNING (置信度: 90%)
  原因: 诱多预警: 对倒嫌疑：成交量异常但买卖盘不变
  ⚠️  诱多预警: ['对倒嫌疑：成交量异常但买卖盘不变']
--------------------------------------------------------------------------------

⚠️  诱多预警 ⚠️

股票代码: 300997.SZ
时间: 2026-02-11 09:40:25
预警信号: 对倒嫌疑：成交量异常但买卖盘不变
置信度: 90%
原因: 诱多预警: 对倒嫌疑：成交量异常但买卖盘不变

建议: 立即停止买入，观察1-3个交易日
```

---

## 📝 日志记录

### 1. 实时监控日志
- 路径：`logs/smart_flow_monitor.log`
- 内容：所有监控记录（信号、置信度、维度详情）

### 2. 诱多预警日志
- 路径：`logs/trap_alerts/{code}_alerts.log`
- 内容：所有诱多预警记录（含时间戳、置信度、原因）

### 3. Tick历史数据（SQLite）
- 路径：`data/tick_history.db`
- 表结构：
  ```sql
  CREATE TABLE tick_history (
      code TEXT,
      timestamp INTEGER,
      volume REAL,
      price REAL,
      amount REAL,
      bid_total REAL,
      ask_total REAL,
      PRIMARY KEY (code, timestamp)
  );
  ```

---

## 🛠️ 故障排除

### Q1: `xtquant 未安装`

**原因**：Python版本不是3.10或虚拟环境未激活

**解决**：
```bash
# 检查Python版本
python --version

# 激活虚拟环境
source venv/bin/activate  # Windows: venv\Scripts\activate

# 重新安装xtquant
pip install xtquant --upgrade
```

### Q2: `Tick数据缺失`

**原因**：QMT客户端未登录或Session过期

**解决**：
1. 打开QMT客户端
2. 登录账号
3. 重新运行监控脚本

### Q3: `股本信息缺失`

**原因**：`data/equity_info.json` 不存在

**解决**：
```bash
# 使用AkShare生成股本信息
python tools/fetch_equity_info.py

# 或手动创建（参考上面数据格式）
```

### Q4: `换手率分析失败`

**原因**：没有足够的历史K线数据

**影响**：只影响 `Space` 维度，不影响其他三个维度

**解决**：等待几个交易日积累足够数据

---

## ✅ 验证标准

### 目标
在 **2-4周实盘监控** 后，达到以下标准：

1. **预警次数**：捕捉到 ≥3次 `TRAP_WARNING` 信号
2. **准确率**：事后验证，准确率 >70%（即被警告后確实出現下跌或横盨）
3. **误报率**：<20%（避免过多误报）

### 验证方法

#### 1. 记录预警
每次触发 `TRAP_WARNING` 时，记录：
- 时间戳
- 股票代码
- 预警类型（对倒/尾盘拉升/连板开板）
- 当时价格

#### 2. 跟踪验证
在预警后 **1-3个交易日** 跟踪验证：
- 预警后1天：记录涨跌幅
- 预警后3天：记录累计涨跌幅
- 判断是否符合“诱多”特征（下跌或横盘）

#### 3. 统计分析

```
总预警次数: 5
准确次数: 4  (预警后碮實下跌/樫盤)
误报次数: 1  (預警後繼續上漲)

准确率: 4 / 5 = 80%  ✅ 符合标准 (>70%)
```

---

## 🔜 下一步：阶段2

当 Phase 1 验证成功后，将开始 **阶段2：全市场扫描**：

- 扫描 **全A股市场** 5000+股票
- 使用 **竞价快照数据** + **分钟K** 数据
- 每天扫描 **2-3次**（09:35, 10:00, 14:00）
- 输出 **疑似诱多榜单**（TOP 20-50）

敬请期待！
